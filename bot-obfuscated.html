<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Deriv DigitMartchStar Bot - SMART ANALYSIS + INSTANT EXECUTION</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <style>
        #log-area::-webkit-scrollbar { width: 4px; }
        #log-area::-webkit-scrollbar-thumb { background: #4ade80; border-radius: 2px; }
        #log-area::-webkit-scrollbar-track { background: #374151; }
        body { font-family: 'Inter', sans-serif; background-color: #111827; }
        @keyframes pulse-once { 0% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.03); opacity: 0.9; } 100% { transform: scale(1); opacity: 1; } }
        .tick-flash { animation: pulse-once 0.1s ease-out; }
        .queue-indicator { animation: pulse-once 0.3s ease-out; }
        @keyframes win-pulse { 0% { box-shadow: 0 0 5px #10B981; } 50% { box-shadow: 0 0 20px #10B981; } 100% { box-shadow: 0 0 5px #10B981; } }
        .win-detected { animation: win-pulse 0.5s infinite; }
        .queue-digit { 
            width: 32px; 
            height: 32px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            border-radius: 50%; 
            font-weight: bold; 
            margin: 0 2px;
        }
        .contract-type-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: bold;
            margin-left: 5px;
        }
        .stop-button-active {
            background-color: #dc2626 !important;
            border: 2px solid #fca5a5 !important;
            animation: pulse-once 0.5s infinite;
        }
        .start-button-active {
            background-color: #16a34a !important;
            border: 2px solid #86efac !important;
            animation: pulse-once 0.5s;
        }
        .token-container {
            position: relative;
        }
        .token-visibility-toggle {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: #9ca3af;
            cursor: pointer;
            font-size: 14px;
        }
        .trade-completed {
            border: 3px solid #10b981 !important;
            background-color: #064e3b !important;
        }
        .trade-failed {
            border: 3px solid #ef4444 !important;
            background-color: #7f1d1d !important;
        }
        .tick-current {
            border: 3px solid #10B981 !important;
            background-color: #064e3b !important;
            animation: pulse-once 0.5s infinite;
        }
        .instant-tick {
            animation: pulse-once 0.3s ease-out;
        }
        .success-pulse {
            animation: pulse-once 0.3s ease-out;
        }
        .instant-win-detected {
            animation: pulse-once 0.5s infinite;
            border: 3px solid #00ff00 !important;
            box-shadow: 0 0 20px #00ff00 !important;
        }
        .account-balance-green {
            color: #10B981 !important;
            font-weight: bold !important;
        }
        .current-stake-green {
            color: #10B981 !important;
            font-weight: bold !important;
        }
        .profit-green {
            color: #10B981 !important;
            font-weight: bold !important;
            text-shadow: 0 0 10px rgba(16, 185, 129, 0.5);
        }
        .profit-red {
            color: #ef4444 !important;
            font-weight: bold !important;
            text-shadow: 0 0 10px rgba(239, 68, 68, 0.5);
        }
        .queued-tick {
            background-color: #1e40af !important;
            border: 2px solid #3b82f6 !important;
        }
        .processing-queued-tick {
            background-color: #7c2d12 !important;
            border: 3px solid #f59e0b !important;
            animation: pulse-once 0.5s infinite;
        }
        .executed-tick {
            background-color: #064e3b !important;
            border: 2px solid #10b981 !important;
        }
        .probability-high { color: #10b981; }
        .probability-medium { color: #f59e0b; }
        .probability-low { color: #ef4444; }
        /* NEW: Account toggle switch styles */
        .account-toggle-container {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .account-toggle {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 30px;
        }
        .account-toggle input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .account-toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #1d4ed8;
            transition: .4s;
            border-radius: 34px;
        }
        .account-toggle-slider:before {
            position: absolute;
            content: "";
            height: 22px;
            width: 22px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        .account-toggle input:checked + .account-toggle-slider {
            background-color: #16a34a;
        }
        .account-toggle input:checked + .account-toggle-slider:before {
            transform: translateX(30px);
        }
        .account-label {
            font-size: 12px;
            font-weight: bold;
        }
        .account-label-demo {
            color: #1d4ed8;
        }
        .account-label-real {
            color: #16a34a;
        }
        /* Smart Analysis Styles */
        .analysis-active {
            border: 2px solid #00ffea !important;
            box-shadow: 0 0 10px rgba(0, 255, 234, 0.3) !important;
        }
        .analysis-complete {
            border: 2px solid #10b981 !important;
            background-color: #064e3b20 !important;
        }
        .digit-missing {
            color: #00ffea !important;
            font-weight: bold !important;
        }
        .digit-frequent {
            color: #f59e0b !important;
            font-weight: bold !important;
        }
        .session-active {
            background: linear-gradient(90deg, #1e3a8a, #1e40af) !important;
            border: 2px solid #3b82f6 !important;
        }
        .session-stopped {
            background: linear-gradient(90deg, #7f1d1d, #991b1b) !important;
            border: 2px solid #ef4444 !important;
        }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght400;600;700&display=swap" rel="stylesheet">
</head>
<body class="min-h-screen p-4 sm:p-8 flex items-start justify-center">

    <div class="w-full max-w-6xl bg-gray-800 text-gray-100 shadow-2xl rounded-xl p-5 md:p-6">
        <div class="flex justify-between items-center mb-4">
            <h1 class="text-3xl font-extrabold text-green-400 border-b border-gray-700 pb-2">
                Deriv DigitMartchStar Bot 
                <span id="status-badge" class="ml-3 inline-flex items-center px-3 py-1 text-sm font-medium rounded-full bg-red-600 text-white shadow-md">
                    DMS Disconnected
                </span>
                <span id="contract-type-badge" class="contract-type-badge bg-purple-600 text-white">DIGITMATCH</span>
                <!-- Account toggle -->
                <div class="account-toggle-container ml-3">
                    <span class="account-label account-label-demo">DEMO</span>
                    <label class="account-toggle">
                        <input type="checkbox" id="accTypeToggle" onchange="switchAccount()">
                        <span class="account-toggle-slider"></span>
                    </label>
                    <span class="account-label account-label-real">REAL</span>
                </div>
            </h1>
            <div class="flex items-center space-x-2">
                <button id="soundToggle" onclick="toggleSound()" class="px-4 py-2 bg-blue-600 text-white font-bold rounded-lg shadow hover:bg-blue-700 transition">
                    üîä Sound ON
                </button>
            </div>
        </div>
        
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
            <!-- LEFT COLUMN: SMART ANALYSIS ENGINE -->
            <div class="lg:col-span-1">
                <div class="bg-gray-900 border border-gray-700 rounded-xl p-4 shadow-lg">
                    <h2 class="text-lg font-bold text-cyan-400 mb-4 pb-2 border-b border-gray-700">
                        üß† SMART DIGIT ANALYSIS ENGINE
                    </h2>
                    
                    <!-- Smart Predictor Settings -->
                    <div class="mb-6 p-3 bg-gray-800 rounded-lg border border-cyan-500/30">
                        <h3 class="text-sm font-bold text-cyan-300 mb-3">Smart Predictor Settings</h3>
                        
                        <div class="mb-3">
                            <label class="block text-xs font-semibold text-gray-300 mb-1">Tick Window Size</label>
                            <div class="flex items-center gap-2">
                                <input type="number" id="tick_window_input" value="20" min="3" max="100" 
                                    class="flex-1 rounded-md bg-gray-700 border border-gray-600 text-white shadow-sm focus:border-cyan-500 focus:ring-cyan-500 py-1.5 px-2 text-sm">
                                <button id="apply_tick_window" 
                                    class="px-3 py-1.5 bg-cyan-600 text-white font-bold rounded-md hover:bg-cyan-700 transition text-sm">
                                    Apply
                                </button>
                            </div>
                            <p class="text-xs text-gray-400 mt-1">Analyze last N ticks for digit patterns</p>
                        </div>
                        
                        <div id="tick_progress" class="mb-4 p-2 bg-gray-800 rounded text-center text-sm">
                            ‚è≥ Collecting ticks... (0 / 20)
                        </div>
                        
                        <div id="prediction_box" class="p-3 bg-gray-800 rounded border border-cyan-500/50 text-sm">
                            <div class="text-cyan-300 font-bold mb-1">Prediction Analysis:</div>
                            <div class="text-gray-300">Waiting for enough ticks...</div>
                        </div>
                    </div>
                    
                    <!-- Trading Session Control -->
                    <div class="p-3 bg-gray-800 rounded-lg border border-blue-500/30">
                        <h3 class="text-sm font-bold text-blue-300 mb-3">Trading Session Control</h3>
                        
                        <div class="grid grid-cols-2 gap-3 mb-3">
                            <div>
                                <label class="block text-xs font-semibold text-gray-300 mb-1">Digit</label>
                                <input type="number" id="digit_input" value="5" min="0" max="9" 
                                    class="w-full rounded-md bg-gray-700 border border-gray-600 text-white shadow-sm focus:border-blue-500 focus:ring-blue-500 py-1.5 px-2 text-sm text-center">
                            </div>
                            
                            <div>
                                <label class="block text-xs font-semibold text-gray-300 mb-1">Max Trades</label>
                                <input type="number" id="max_trades" value="20" min="1" max="100" 
                                    class="w-full rounded-md bg-gray-700 border border-gray-600 text-white shadow-sm focus:border-blue-500 focus:ring-blue-500 py-1.5 px-2 text-sm">
                            </div>
                            
                            <div>
                                <label class="block text-xs font-semibold text-gray-300 mb-1">Base Stake</label>
                                <input type="number" id="base_stake" value="1.0" min="0.1" step="0.1" 
                                    class="w-full rounded-md bg-gray-700 border border-gray-600 text-white shadow-sm focus:border-blue-500 focus:ring-blue-500 py-1.5 px-2 text-sm">
                            </div>
                            
                            <div>
                                <label class="block text-xs font-semibold text-gray-300 mb-1">Martingale</label>
                                <input type="number" id="martingale" value="1.15" min="1.0" step="0.01" 
                                    class="w-full rounded-md bg-gray-700 border border-gray-600 text-white shadow-sm focus:border-blue-500 focus:ring-blue-500 py-1.5 px-2 text-sm">
                            </div>
                        </div>
                        
                        <button onclick="startSmartSession()" 
                            class="w-full px-4 py-2 bg-green-600 text-white font-bold rounded-lg hover:bg-green-700 transition mb-3">
                            üöÄ START SMART SESSION
                        </button>
                        
                        <div id="session_status" class="p-2 bg-gray-900 rounded text-center text-sm">
                            <span class="text-gray-400">Session: READY</span>
                        </div>
                    </div>
                    
                    <!-- Analysis Statistics -->
                    <div class="mt-4 p-3 bg-gray-800 rounded-lg border border-purple-500/30">
                        <h3 class="text-sm font-bold text-purple-300 mb-2">Analysis Statistics</h3>
                        <div class="grid grid-cols-2 gap-2 text-xs">
                            <div>
                                <span class="text-gray-400">Window Size:</span>
                                <span id="stat_window_size" class="ml-2 font-bold">20</span>
                            </div>
                            <div>
                                <span class="text-gray-400">Ticks Collected:</span>
                                <span id="stat_ticks_collected" class="ml-2 font-bold text-cyan-400">0</span>
                            </div>
                            <div>
                                <span class="text-gray-400">Missing Digits:</span>
                                <span id="stat_missing_digits" class="ml-2 font-bold digit-missing">0</span>
                            </div>
                            <div>
                                <span class="text-gray-400">Most Frequent:</span>
                                <span id="stat_most_frequent" class="ml-2 font-bold digit-frequent">-</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- MIDDLE COLUMN: MAIN CONTROLS -->
            <div class="lg:col-span-2">
                <div class="grid grid-cols-2 lg:grid-cols-3 gap-3 mb-6">
                    <!-- Symbol -->
                    <div>
                        <label for="symbol" class="block text-xs font-semibold text-gray-300 mb-1">Symbol</label>
                        <select id="symbol" class="block w-full rounded-md bg-gray-700 border border-gray-600 text-white shadow-sm focus:border-green-500 focus:ring-green-500 py-1.5 px-2 text-sm">
                            <option value="R_10">V. 10 Index</option>
                            <option value="R_100">V. 100 Index</option>
                            <option value="R_25">V. 25 Index</option>
                            <option value="R_50">V. 50 Index</option>
                            <option value="R_75">V. 75 Index</option>
                        </select>
                    </div>
                    
                    <!-- Predicted Digit (can be overridden by analysis) -->
                    <div>
                        <label for="predictedDigit" class="block text-xs font-semibold text-gray-300 mb-1">Predicted Digit (0-9)</label>
                        <input type="number" id="predictedDigit" value="5" min="0" max="9" 
                            class="block w-full rounded-md bg-gray-700 border border-gray-600 text-white shadow-sm focus:border-green-500 focus:ring-green-500 py-1.5 px-2 text-sm text-center">
                    </div>

                    <!-- Contract Type -->
                    <div>
                        <label for="contractType" class="block text-xs font-semibold text-gray-300 mb-1">Contract Type</label>
                        <select id="contractType" class="block w-full rounded-md bg-gray-700 border border-gray-600 text-white shadow-sm focus:border-green-500 focus:ring-green-500 py-1.5 px-2 text-sm">
                            <option value="DIGITMATCH">DIGITMATCH (INSTANT - 792.9% payout)</option>
                        </select>
                    </div>

                    <!-- Bankroll Limit -->
                    <div>
                        <label for="bankrollLimit" class="block text-xs font-semibold text-gray-300 mb-1">Bankroll Limit</label>
                        <input type="number" id="bankrollLimit" value="25.0" min="1.0" step="0.1" 
                            class="block w-full rounded-md bg-gray-700 border border-gray-600 text-white shadow-sm focus:border-green-500 focus:ring-green-500 py-1.5 px-2 text-sm">
                    </div>
                    
                    <!-- Analysis Mode Toggle -->
                    <div class="col-span-2 lg:col-span-3">
                        <label class="block text-xs font-semibold text-gray-300 mb-1">Execution Mode</label>
                        <div class="grid grid-cols-2 gap-2">
                            <button id="mode_instant" onclick="switchMode('instant')" 
                                class="px-4 py-2 bg-green-600 text-white font-bold rounded-lg hover:bg-green-700 transition">
                                ‚ö° INSTANT MODE
                            </button>
                            <button id="mode_smart" onclick="switchMode('smart')" 
                                class="px-4 py-2 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 transition">
                                üß† SMART MODE
                            </button>
                        </div>
                        <p id="mode_description" class="text-xs text-gray-400 mt-1">
                            ‚ö° INSTANT: Trade on each tick immediately
                        </p>
                    </div>
                </div>
                
                <!-- METRICS COLUMN -->
                <div id="metrics-column">
                    <div class="grid grid-cols-3 gap-3">
                        <div class="bg-gray-700 rounded-lg p-2 shadow-inner border border-green-500/50 col-span-2">
                            <p class="text-[10px] font-semibold text-green-500 uppercase">Current Tick</p>
                            <p id="metricLiveTick" class="text-xl font-extrabold text-white">---</p>
                            <p id="metricLastDigit" class="text-lg font-bold text-green-300">Digit: ?</p>
                            <p id="metricTickRate" class="text-xs font-bold text-blue-400">Ticks/sec: --</p>
                            <p id="metricProbability" class="text-xs font-bold probability-medium">Probability: 10%</p>
                        </div>
                        
                        <div class="bg-gray-700 rounded-lg p-2 shadow-inner border border-purple-500/50">
                            <p class="text-[10px] font-semibold text-purple-500 uppercase">Account Balance</p>
                            <p id="metricAccountBalance" class="text-lg font-bold text-white">$---</p>
                            <p class="text-xs text-gray-300 mt-1">Available</p>
                        </div>
                        
                        <div class="bg-gray-700 rounded-lg p-2 shadow-inner">
                            <p class="text-[10px] font-semibold text-green-500 uppercase">Trade #</p>
                            <p id="metricTradeCount" class="text-lg font-bold text-white">0</p>
                        </div>
                        
                        <div class="bg-gray-700 rounded-lg p-2 shadow-inner">
                            <p class="text-[10px] font-semibold text-lime-400 uppercase">Net P/L</p>
                            <p id="metricTotalProfit" class="text-lg font-bold text-gray-300">$0.00</p>
                        </div>
                        
                        <div class="bg-gray-700 rounded-lg p-2 shadow-inner">
                            <p class="text-[10px] font-semibold text-green-500 uppercase">Current Stake</p>
                            <p id="metricCurrentStake" class="text-lg font-bold text-white">$0.00</p>
                        </div>
                        
                        <div id="trade-result-container" class="bg-gray-900 rounded-lg p-3 shadow-inner border border-yellow-500/50 col-span-3">
                            <div class="flex justify-between items-center mb-2">
                                <p class="text-[10px] font-semibold text-yellow-500 uppercase">‚ö° TRADE STATUS</p>
                                <p id="metricTradeResult" class="text-xs font-bold text-gray-400">READY</p>
                            </div>
                            <div class="mb-2">
                                <p class="text-[10px] font-semibold text-gray-400 uppercase mb-1">Status:</p>
                                <p id="metricPreviousResult" class="text-sm font-bold text-gray-300">Waiting for ticks...</p>
                            </div>
                            <div>
                                <p class="text-[10px] font-semibold text-gray-400 uppercase mb-1">Action:</p>
                                <p id="metricNextAction" class="text-sm font-bold text-yellow-400">Execute on each tick</p>
                            </div>
                        </div>
                        
                        <div id="queue-status-container" class="bg-gray-900 rounded-lg p-3 shadow-inner border border-blue-500/50 col-span-3 tick-queue-highlight relative">
                            <div class="flex justify-between items-center mb-2">
                                <p class="text-[10px] font-semibold text-blue-500 uppercase">üéØ EXECUTION STATS</p>
                                <p id="metricQueueStatus" class="text-xs font-bold text-green-400">READY</p>
                            </div>
                            
                            <div class="mb-3 p-2 bg-gray-800 rounded border border-yellow-500/30">
                                <p class="text-[10px] font-semibold text-yellow-500 uppercase mb-1">Processing Tick:</p>
                                <div id="processingTickDisplay" class="flex items-center">
                                    <div id="processingTickDigit" class="queue-digit bg-gray-700 text-white mr-2">?</div>
                                    <div class="flex-1">
                                        <p id="processingTickInfo" class="text-xs text-gray-300">Waiting...</p>
                                        <p id="processingTickTime" class="text-[10px] text-gray-400">--</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mb-2">
                                <div class="flex justify-between items-center mb-1">
                                    <p class="text-[10px] font-semibold text-blue-500 uppercase">Trades Executed:</p>
                                    <p id="metricExecutedTrades" class="text-xs font-bold text-white">0</p>
                                </div>
                                <div class="w-full bg-gray-700 rounded-full h-2.5 mb-2">
                                    <div id="executionBar" class="bg-green-600 h-2.5 rounded-full" style="width: 0%"></div>
                                </div>
                                <p class="text-[10px] text-gray-400 text-center">Trade progress</p>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-1 mt-2">
                                <div class="text-center">
                                    <p class="text-[8px] text-gray-400 uppercase">Trades Done</p>
                                    <p id="metricTradesDone" class="text-xs font-bold text-green-400">0/10</p>
                                </div>
                                <div class="text-center">
                                    <p class="text-[8px] text-gray-400 uppercase">Trades Left</p>
                                    <p id="metricTradesLeft" class="text-xs font-bold text-blue-400">10</p>
                                </div>
                            </div>
                            <p class="text-[9px] text-gray-400 text-center mt-2">
                                <strong>GOAL:</strong> Win detected within <span id="metricTradesRemaining">10</span> trades
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- START/STOP BUTTON -->
        <div class="flex justify-center mb-5">
            <button id="toggleButton" onclick="toggleBot()" 
                class="w-full md:w-1/2 px-6 py-3 bg-green-600 text-white font-bold text-lg rounded-lg shadow-xl hover:bg-green-700 transition duration-150">
                START BOT
            </button>
        </div>

        <!-- LOG AREA -->
        <div id="log-column" class="w-full flex flex-col">
            <h2 class="text-lg font-bold text-gray-300 mb-2 border-b border-gray-700 pb-1">Live Trade Log</h2>
            <div id="log-area" class="flex-grow h-80 bg-gray-900 text-lime-400 p-2.5 rounded-lg overflow-y-scroll text-xs whitespace-pre-wrap shadow-inner">
                [00:00:00] ü§ñ Bot initialized with SMART ANALYSIS ENGINE...
                [00:00:00] üß† SMART MODE: Trades begin only after analysis completion
                [00:00:00] ‚ö° INSTANT MODE: Trade immediately on each tick
            </div>
        </div>
    </div>

    <script>
        // ============================================================================
        // SMART DIGIT ANALYSIS + SESSION ENGINE
        // ============================================================================
        
        /************ GLOBAL STATE ************/
        let lastDigits = [];
        let TICK_WINDOW = 20;  // default - user can change
        
        let analysisState = {
            suggestedDigit: null,
            reason: "",
            frequency: Array(10).fill(0),
            digits: []
        };
        
        let sessionState = {
            active: false,
            targetDigit: null,
            tradesDone: 0,
            maxTrades: 20,
            baseStake: 1.0,
            currentStake: 1.0,
            martingale: 1.15,
            mode: 'instant' // 'instant' or 'smart'
        };
        
        /************ MODE MANAGEMENT ************/
        function switchMode(mode) {
            sessionState.mode = mode;
            
            // Update button styles
            document.getElementById('mode_instant').classList.remove('bg-green-600', 'bg-blue-600');
            document.getElementById('mode_smart').classList.remove('bg-green-600', 'bg-blue-600');
            
            if (mode === 'instant') {
                document.getElementById('mode_instant').classList.add('bg-green-600');
                document.getElementById('mode_smart').classList.add('bg-blue-600');
                document.getElementById('mode_description').textContent = '‚ö° INSTANT: Trade on each tick immediately';
                log('üîÑ Switched to INSTANT MODE: Trading on every tick', 'SYSTEM');
            } else {
                document.getElementById('mode_smart').classList.add('bg-green-600');
                document.getElementById('mode_instant').classList.add('bg-blue-600');
                document.getElementById('mode_description').textContent = 'üß† SMART: Analyze first, then trade on analyzed digit';
                log('üîÑ Switched to SMART MODE: Analyzing before trading', 'SYSTEM');
            }
            
            // Update execution logic
            updateExecutionLogic();
        }
        
        function updateExecutionLogic() {
            if (sessionState.mode === 'smart' && !analysisState.suggestedDigit) {
                log('üß† SMART MODE: Waiting for analysis completion before trading...', 'ANALYSIS');
                window.nextTradeAllowed = false;
            } else if (sessionState.mode === 'smart' && analysisState.suggestedDigit !== null) {
                log(`üß† SMART MODE: Analysis complete. Trading on digit ${analysisState.suggestedDigit}`, 'ANALYSIS');
                window.nextTradeAllowed = true;
                // Update predicted digit with analysis suggestion
                document.getElementById('predictedDigit').value = analysisState.suggestedDigit;
            } else if (sessionState.mode === 'instant') {
                window.nextTradeAllowed = true;
            }
        }
        
        /************ USER APPLY WINDOW ************/
        document.getElementById("apply_tick_window").addEventListener("click", function(){
            const val = Number(document.getElementById("tick_window_input").value);
            if (!val || val < 3) {
                alert("Enter a number ‚â• 3");
                return;
            }
            TICK_WINDOW = val;
            lastDigits = [];
            analysisState.suggestedDigit = null;
            
            document.getElementById("tick_progress").innerHTML = 
                `<span class="text-cyan-400">‚è≥ Collecting...</span> (0 / ${TICK_WINDOW})`;
            document.getElementById("stat_window_size").textContent = TICK_WINDOW;
            document.getElementById("stat_ticks_collected").textContent = "0";
            
            log(`üìä Analysis window set to ${TICK_WINDOW} ticks`, 'ANALYSIS');
            
            // Update execution logic if in smart mode
            if (sessionState.mode === 'smart') {
                updateExecutionLogic();
            }
        });
        
        /************ MAIN TICK HANDLER (Integrated with existing bot) ************/
        function handleTickWithAnalysis(tick) {
            const digit = parseInt(tick.digit);
            
            // Update analysis system
            updateLastDigits(digit);
            updateTickProgressUI();
            
            // Update statistics
            document.getElementById("stat_ticks_collected").textContent = lastDigits.length;
            
            // Analyze when window is full
            if (lastDigits.length === TICK_WINDOW) {
                analysisState = analyzeWindow(lastDigits);
                updatePredictionUI(analysisState);
                
                // Update statistics display
                const missingCount = analysisState.frequency.filter(f => f === 0).length;
                document.getElementById("stat_missing_digits").textContent = missingCount;
                
                const mostFreqIndex = analysisState.frequency.indexOf(Math.max(...analysisState.frequency));
                document.getElementById("stat_most_frequent").textContent = mostFreqIndex;
                
                // If in smart mode, update execution logic
                if (sessionState.mode === 'smart') {
                    updateExecutionLogic();
                    
                    // If analysis suggests a digit and session is active, update target
                    if (sessionState.active && analysisState.suggestedDigit !== null) {
                        sessionState.targetDigit = analysisState.suggestedDigit;
                        document.getElementById('digit_input').value = analysisState.suggestedDigit;
                        log(`üß† Analysis updated target digit to ${analysisState.suggestedDigit}`, 'ANALYSIS');
                    }
                }
            }
            
            // Handle active session
            if (sessionState.active) {
                handleActiveSession();
            }
        }
        
        /************ LAST DIGIT EXTRACTION ************/
        function getLastDigitFromPrice(price) {
            const symbol = document.getElementById('symbol').value;
            let decimalPlaces = 3;
            if (symbol === 'R_100') decimalPlaces = 2;
            const formattedPrice = price.toFixed(decimalPlaces);
            return parseInt(formattedPrice.charAt(formattedPrice.length - 1), 10);
        }
        
        /************ MAINTAIN DIGIT WINDOW ************/
        function updateLastDigits(d) {
            lastDigits.push(d);
            if (lastDigits.length > TICK_WINDOW) lastDigits.shift();
        }
        
        /************ ANALYZE WINDOW ************/
        function analyzeWindow(digits) {
            const freq = Array(10).fill(0);
            digits.forEach(d => freq[d]++);
            
            const freqThreshold = Math.ceil(TICK_WINDOW * 0.30);
            
            // Find missing digits
            const missing = freq.map((c, d) => c === 0 ? d : null).filter(v => v !== null);
            if (missing.length > 0) {
                const suggestedDigit = missing[Math.floor(Math.random() * missing.length)];
                return {
                    suggestedDigit: suggestedDigit,
                    reason: `Digit ${suggestedDigit} missing in last ${TICK_WINDOW} ticks`,
                    frequency: freq,
                    digits: [...digits]
                };
            }
            
            // Find least frequent digits (less than threshold)
            const infrequent = freq.map((c, d) => c < freqThreshold ? d : null).filter(v => v !== null);
            if (infrequent.length > 0) {
                const suggestedDigit = infrequent[Math.floor(Math.random() * infrequent.length)];
                return {
                    suggestedDigit: suggestedDigit,
                    reason: `Digit ${suggestedDigit} appears only ${freq[suggestedDigit]} times (below ${freqThreshold} threshold)`,
                    frequency: freq,
                    digits: [...digits]
                };
            }
            
            // Default: most frequent digit
            const mostFrequent = freq.indexOf(Math.max(...freq));
            return {
                suggestedDigit: mostFrequent,
                reason: `Digit ${mostFrequent} is most frequent (${freq[mostFrequent]} times)`,
                frequency: freq,
                digits: [...digits]
            };
        }
        
        /************ UPDATE PREDICTION UI ************/
        function updatePredictionUI(state) {
            const box = document.getElementById("prediction_box");
            
            if (state.suggestedDigit === null) {
                box.innerHTML = `
                    <div class="text-cyan-300 font-bold mb-1">Prediction Analysis:</div>
                    <div class="text-gray-300">Waiting for enough ticks...</div>
                `;
                return;
            }
            
            let reasonClass = "text-cyan-400";
            if (state.reason.includes("missing")) reasonClass = "digit-missing";
            if (state.reason.includes("most frequent")) reasonClass = "digit-frequent";
            
            box.innerHTML = `
                <div class="text-cyan-300 font-bold mb-1">Prediction Analysis:</div>
                <div class="text-xl font-bold mb-2 text-center ${reasonClass}">${state.suggestedDigit}</div>
                <div class="text-xs text-gray-300 mb-2">${state.reason}</div>
                <div class="text-xs text-gray-400">Based on last ${TICK_WINDOW} ticks</div>
            `;
            
            // Visual feedback
            box.classList.add('analysis-complete');
            setTimeout(() => box.classList.remove('analysis-complete'), 1000);
            
            log(`üß† Analysis complete: ${state.reason}`, 'ANALYSIS');
        }
        
        /************ UPDATE TICK COUNTER UI ************/
        function updateTickProgressUI() {
            const box = document.getElementById("tick_progress");
            const c = lastDigits.length;
            
            if (c < TICK_WINDOW) {
                box.innerHTML = `<span class="text-cyan-400">‚è≥ Collecting...</span> (${c} / ${TICK_WINDOW})`;
                box.className = "mb-4 p-2 bg-gray-800 rounded text-center text-sm";
            } else {
                box.innerHTML = `<span class="text-green-400">üìä Window Full</span> ‚Üí Analyzing (${TICK_WINDOW})`;
                box.className = "mb-4 p-2 bg-gray-800 rounded text-center text-sm analysis-active";
            }
        }
        
        /************ START SMART SESSION ************/
        function startSmartSession() {
            if (!window.isBotRunning) {
                log("‚ùå Start the bot first before starting a session", 'ERROR');
                return;
            }
            
            // Get values from inputs
            const digit = Number(document.getElementById("digit_input").value);
            const maxTrades = Number(document.getElementById("max_trades").value);
            const baseStake = Number(document.getElementById("base_stake").value);
            const martingale = Number(document.getElementById("martingale").value);
            
            // Validation
            if (digit < 0 || digit > 9) {
                alert("Please enter a digit between 0-9");
                return;
            }
            
            if (maxTrades < 1) {
                alert("Max trades must be at least 1");
                return;
            }
            
            if (baseStake < 0.1) {
                alert("Base stake must be at least 0.1");
                return;
            }
            
            if (martingale < 1.0) {
                alert("Martingale must be at least 1.0");
                return;
            }
            
            // Set session state
            sessionState.active = true;
            sessionState.targetDigit = digit;
            sessionState.maxTrades = maxTrades;
            sessionState.baseStake = baseStake;
            sessionState.currentStake = baseStake;
            sessionState.martingale = martingale;
            sessionState.tradesDone = 0;
            
            // Update bot parameters
            document.getElementById('predictedDigit').value = digit;
            document.getElementById('maxTrades').value = maxTrades;
            document.getElementById('baseStake').value = baseStake;
            document.getElementById('multiplier').value = martingale;
            
            // Update UI
            updateSessionUI("ACTIVE", `Smart Session Started - Target: ${digit}`);
            
            log(`üöÄ SMART SESSION STARTED: Target digit ${digit}, Max ${maxTrades} trades, Stake $${baseStake}`, 'SESSION');
            
            // If in smart mode and analysis isn't complete, warn user
            if (sessionState.mode === 'smart' && !analysisState.suggestedDigit) {
                log('‚ö†Ô∏è SMART MODE: Waiting for analysis completion before trading begins', 'ANALYSIS');
            }
        }
        
        /************ END SESSION ************/
        function endSession(message) {
            updateSessionUI("STOPPED", message);
            sessionState.active = false;
            sessionState.targetDigit = null;
            sessionState.tradesDone = 0;
            sessionState.currentStake = sessionState.baseStake;
            
            log(`üõë Session ended: ${message}`, 'SESSION');
        }
        
        /************ ACTIVE SESSION LOOP ************/
        function handleActiveSession() {
            // Check if we should trade
            if (!window.isBotRunning || !window.nextTradeAllowed || window.executionLock) {
                return;
            }
            
            // Check max trades
            if (sessionState.tradesDone >= sessionState.maxTrades) {
                endSession("Max Trades Reached ‚Äî Stopped");
                return;
            }
            
            // Check if we have a win condition (from main bot)
            if (window.stopAfterWin) {
                endSession("WIN ‚Äî Stopped");
                return;
            }
            
            // Place trade using main bot's execution system
            placeSmartTrade();
            sessionState.tradesDone++;
            
            // Update session UI
            updateSessionUI("ACTIVE", 
                `Trade #${sessionState.tradesDone}/${sessionState.maxTrades} | Stake: $${sessionState.currentStake.toFixed(2)}`);
        }
        
        /************ PLACE SMART TRADE ************/
        function placeSmartTrade() {
            if (!sessionState.active || !window.isBotRunning) return;
            
            // Update main bot's stake
            window.currentStake = sessionState.currentStake;
            document.getElementById('metricCurrentStake').textContent = `$${window.currentStake.toFixed(2)}`;
            
            // Set the predicted digit in main bot
            document.getElementById('predictedDigit').value = sessionState.targetDigit;
            
            log(`üß† SMART TRADE #${sessionState.tradesDone + 1}: Digit ${sessionState.targetDigit}, Stake $${sessionState.currentStake.toFixed(2)}`, 'SMART');
            
            // The actual trade will be executed by the main bot's tick processing
            // We just need to ensure the parameters are set
        }
        
        /************ UPDATE SESSION UI ************/
        function updateSessionUI(status, msg) {
            const sessionElem = document.getElementById("session_status");
            
            if (status === "ACTIVE") {
                sessionElem.innerHTML = `<span class="text-green-400 font-bold">‚ñ∂Ô∏è ACTIVE</span> ‚Äî ${msg}`;
                sessionElem.className = "p-2 bg-gray-900 rounded text-center text-sm session-active";
            } else if (status === "STOPPED") {
                sessionElem.innerHTML = `<span class="text-red-400 font-bold">‚èπÔ∏è STOPPED</span> ‚Äî ${msg}`;
                sessionElem.className = "p-2 bg-gray-900 rounded text-center text-sm session-stopped";
            } else {
                sessionElem.innerHTML = `<span class="text-gray-400">${status}</span> ‚Äî ${msg}`;
                sessionElem.className = "p-2 bg-gray-900 rounded text-center text-sm";
            }
        }
        
        /************ UPDATE STAKE AFTER TRADE RESULT ************/
        function updateSmartStakeAfterTrade(winOrLoss) {
            if (!sessionState.active) return;
            
            if (winOrLoss === 'win') {
                sessionState.currentStake = sessionState.baseStake;
                log(`‚úÖ SMART SESSION: Win! Reset stake to $${sessionState.currentStake.toFixed(2)}`, 'SMART');
            } else if (winOrLoss === 'loss') {
                sessionState.currentStake *= sessionState.martingale;
                sessionState.currentStake = parseFloat(sessionState.currentStake.toFixed(2));
                log(`‚ùå SMART SESSION: Loss. Next stake: $${sessionState.currentStake.toFixed(2)}`, 'SMART');
            }
        }
        
        // ============================================================================
        // ORIGINAL BOT CODE (Integrated with Analysis Engine)
        // ============================================================================
        
        // Initialize tokens from OAuth Login
        window.DERIV_TOKEN = localStorage.getItem('active_token');
        let allAccounts = JSON.parse(localStorage.getItem('deriv_accounts')) || [];
        
        // Set initial toggle state
        function initializeToggleState() {
            if (allAccounts.length > 0) {
                const currentToken = window.DERIV_TOKEN;
                const currentAccount = allAccounts.find(acc => acc.token === currentToken);
                
                if (currentAccount) {
                    const isReal = !currentAccount.account.startsWith('VR');
                    document.getElementById('accTypeToggle').checked = isReal;
                    log(`Initialized: ${isReal ? 'REAL' : 'DEMO'} account (${currentAccount.account})`, 'SYSTEM');
                }
            }
        }
        
        // Real/Demo Toggle Logic
        function switchAccount() {
            const isRealRequested = document.getElementById('accTypeToggle').checked;
            
            const targetAccount = allAccounts.find(acc => 
                isRealRequested ? !acc.account.startsWith('VR') : acc.account.startsWith('VR')
            );
        
            if (targetAccount) {
                window.DERIV_TOKEN = targetAccount.token;
                localStorage.setItem('active_token', targetAccount.token);
                log(`System: Switched to ${isRealRequested ? 'REAL' : 'DEMO'} (${targetAccount.account})`, 'SYSTEM');
                
                if (window.isBotRunning) {
                    stopBot();
                    setTimeout(() => startBot(), 1000);
                }
            } else {
                alert(`No ${isRealRequested ? 'Real' : 'Demo'} account found. Please login again.`);
                document.getElementById('accTypeToggle').checked = !isRealRequested;
            }
        }
        
        // Updated WebSocket Connection
        function connectWebSocket() {
            window.ws = new WebSocket('wss://ws.binaryws.com/websockets/v3?app_id=118332');
            
            window.ws.onopen = () => {
                sendRequest({ authorize: window.DERIV_TOKEN, req_id: getNextReqId() });
            };
            
            window.ws.onmessage = (msg) => {
                const data = JSON.parse(msg.data);
                handleAPIResponse(data);
            };
        }
        
        // Authentication check
        (function checkAuth() {
            console.log('üîç Bot: Checking authentication...');
            
            const derivToken = localStorage.getItem('derivToken');
            const verificationToken = localStorage.getItem('verificationToken');
            const affiliateVerified = localStorage.getItem('affiliateVerified');
            
            if (derivToken) {
                console.log('‚úÖ Bot: API token found, allowing access');
                return;
            }
            
            if (verificationToken && affiliateVerified === 'true') {
                console.log('‚úÖ Bot: Verified user, allowing access');
                return;
            }
            
            console.log('‚ö†Ô∏è Bot: No API token found. Manual mode enabled.');
            
            setTimeout(() => {
                const notification = document.createElement('div');
                notification.className = 'fixed top-4 left-1/2 transform -translate-x-1/2 px-4 py-2 bg-yellow-600 text-white rounded-lg shadow-lg z-50';
                notification.innerHTML = `
                    <div class="flex items-center">
                        <span class="mr-2">‚ö†Ô∏è</span>
                        <span>Please enter your Deriv API token to start trading</span>
                    </div>
                `;
                document.body.appendChild(notification);
                
                setTimeout(() => notification.remove(), 5000);
            }, 1000);
        })();
        
        // GLOBAL STATE
        window.ws = null;
        window.req_id = 0;
        window.isBotRunning = false;
        window.tokenVisible = false;
        
        // Audio
        window.ToneInitialized = false;
        window.synth = null;
        window.soundEnabled = true;
        
        // Trading & Martingale State
        window.baseStake = 1.0;
        window.currentStake = 1.0;
        window.multiplier = 1.15;
        window.maxTrades = 10;
        window.tradeCount = 0;
        window.martingaleStep = 0;
        window.accountBalance = 0.0;
        
        // PnL Tracking
        window.startingBalance = 0.0;
        window.currentBalance = 0.0;
        window.netProfit = 0.0;
        window.lastBalanceUpdate = 0;
        
        // Execution System
        window.lastTick = null;
        window.waitingForTradeResult = false;
        window.lastTradeResult = null;
        window.nextTradeAllowed = true;
        window.stopAfterWin = false;
        window.currentlyProcessingTick = null;
        window.pendingProposals = new Map();
        window.activeContracts = new Map();
        window.executionLock = false;
        
        // Statistics
        window.stats = {
            totalTicks: 0,
            tradesExecuted: 0,
            wins: 0,
            losses: 0,
            digitMatches: 0,
            digitNonMatches: 0
        };
        
        // Rate tracking
        window.lastTickTime = 0;
        window.tickTimestamps = [];
        
        // WebSocket keep-alive
        window.wsPingInterval = null;
        window.lastPingTime = Date.now();
        
        // Queue for ticks
        window.tickQueue = [];
        window.maxQueueSize = 10;
        
        // Probability tracking (separate from analysis engine)
        window.digitsHistory = [];
        window.MAX_HISTORY = 100;
        
        // --- DOM Elements ---
        const toggleButton = document.getElementById('toggleButton');
        const statusBadge = document.getElementById('status-badge');
        const soundToggleButton = document.getElementById('soundToggle');
        const contractTypeBadge = document.getElementById('contract-type-badge');
        const contractTypeSelect = document.getElementById('contractType');
        const maxTradesInput = document.getElementById('maxTrades');
        const predictedDigitInput = document.getElementById('predictedDigit');
        
        // Digit extraction
        function extractLastDigitBySymbol(price) {
            const symbol = document.getElementById('symbol').value;
            let decimalPlaces = 3;
            if (symbol === 'R_100') decimalPlaces = 2;
            const formattedPrice = price.toFixed(decimalPlaces);
            return formattedPrice.charAt(formattedPrice.length - 1);
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            console.log('ü§ñ Bot page loaded with SMART ANALYSIS ENGINE');
            
            // Initialize toggle state
            initializeToggleState();
            
            // Load saved settings
            window.soundEnabled = localStorage.getItem('soundEnabled') !== 'false';
            updateSoundButton();
            
            // Initialize displays
            updateContractTypeDisplay();
            
            window.baseStake = parseFloat(document.getElementById('baseStake').value) || 1.0;
            window.currentStake = window.baseStake;
            document.getElementById('metricCurrentStake').textContent = `$${window.currentStake.toFixed(2)}`;
            
            // Set up event listeners
            contractTypeSelect.addEventListener('change', updateContractTypeDisplay);
            
            // Initialize analysis engine UI
            document.getElementById("stat_window_size").textContent = TICK_WINDOW;
            
            // Start periodic updates
            setInterval(calculateRates, 1000);
            setInterval(updateStrategyDisplay, 100);
            setInterval(updateProbability, 2000);
            
            // Start queue processor
            startQueueProcessor();
            
            log('ü§ñ Bot initialized with SMART ANALYSIS ENGINE', 'SYSTEM');
            log('üß† SMART MODE: Trades begin only after analysis completion', 'ANALYSIS');
            log('‚ö° INSTANT MODE: Trade immediately on each tick', 'SYSTEM');
            
            // Set default mode
            switchMode('instant');
        });
        
        // MODIFIED TICK HANDLER WITH ANALYSIS INTEGRATION
        function handleTick(tick) {
            if (!window.isBotRunning) return;
            
            const price = parseFloat(tick.quote);
            const digit = extractLastDigitBySymbol(price);
            const time = parseInt(tick.epoch) * 1000;
            const tickData = { digit: digit, price: price, time: time };
            
            // Store tick data
            window.lastTick = tickData;
            
            // Update live tick display
            const displayPrice = price.toFixed(3);
            document.getElementById('metricLiveTick').textContent = displayPrice;
            document.getElementById('metricLastDigit').textContent = `Digit: ${digit}`;
            document.getElementById('metricLiveTick').classList.add('tick-flash');
            setTimeout(() => document.getElementById('metricLiveTick').classList.remove('tick-flash'), 50);
            
            window.tickTimestamps.push(Date.now());
            window.stats.totalTicks++;
            
            // Send tick to analysis engine
            handleTickWithAnalysis(tickData);
            
            // Add tick to queue (for instant mode)
            addTickToQueue(tickData);
            
            playAudioFeedback('TICK');
            
            // Log first few ticks
            if (window.stats.totalTicks <= 5) {
                const symbol = document.getElementById('symbol').value;
                log(`üéØ Tick ${window.stats.totalTicks}: ${displayPrice} (Digit ${digit})`, 'TICK');
            }
        }
        
        // MODIFIED TICK PROCESSING WITH MODE CHECK
        function processTickImmediately(tick) {
            if (window.stopAfterWin) return;
            
            // Check mode restrictions
            if (sessionState.mode === 'smart' && !analysisState.suggestedDigit) {
                // In smart mode, wait for analysis
                if (window.stats.totalTicks % 10 === 0) { // Log every 10th tick to avoid spam
                    log('üß† SMART MODE: Waiting for analysis completion...', 'ANALYSIS');
                }
                return;
            }
            
            // Check for win first
            if (checkForImmediateWin(tick)) {
                return;
            }
            
            // Check max trades
            const currentMaxTrades = sessionState.active ? sessionState.maxTrades : window.maxTrades;
            if (window.tradeCount >= currentMaxTrades) {
                log(`üõë Max trades limit reached (${currentMaxTrades})`, 'CRITICAL');
                stopBot();
                return;
            }
            
            // Execute trade
            window.executionLock = true;
            window.nextTradeAllowed = false;
            
            try {
                window.stats.tradesExecuted++;
                window.tradeCount++;
                document.getElementById('metricTradeCount').textContent = window.tradeCount;
                
                // Log based on mode
                if (sessionState.mode === 'smart' && sessionState.active) {
                    log(`üß† SMART TRADE #${window.tradeCount}: Digit ${sessionState.targetDigit}, Stake $${sessionState.currentStake.toFixed(2)}`, 'SMART');
                } else {
                    log(`‚ö° TRADE #${window.tradeCount}: ${tick.price.toFixed(3)} (Digit ${tick.digit})`, 'INSTANT');
                }
                
                playAudioFeedback('EXECUTION');
                
                // Update display
                updateProcessingTickDisplay(tick);
                
                // Execute trade immediately
                executeTrade(tick);
                
            } catch (error) {
                log(`‚ùå Error in processTickImmediately: ${error}`, 'ERROR');
                window.executionLock = false;
                window.nextTradeAllowed = true;
            }
        }
        
        // MODIFIED TRADE EXECUTION WITH SMART SESSION SUPPORT
        function executeTrade(tick) {
            const contractType = document.getElementById('contractType').value;
            const symbol = document.getElementById('symbol').value;
            
            // Use smart session digit if active, otherwise use manual input
            let predictedDigit;
            let stake;
            
            if (sessionState.active && sessionState.mode === 'smart') {
                predictedDigit = sessionState.targetDigit;
                stake = sessionState.currentStake;
            } else {
                predictedDigit = parseInt(document.getElementById('predictedDigit').value);
                stake = window.currentStake;
            }
            
            // Use duration 1 for fastest possible resolution
            const duration = 1;
            
            const proposalRequest = {
                proposal: 1,
                amount: stake.toFixed(2),
                basis: "stake",
                contract_type: contractType,
                currency: "USD",
                duration: duration,
                duration_unit: "t",
                symbol: symbol,
                barrier: predictedDigit.toString(),
                req_id: getNextReqId()
            };
            
            // Store pending proposal
            window.pendingProposals.set(proposalRequest.req_id, {
                tick: tick,
                stake: stake,
                contractType: contractType,
                predictedDigit: predictedDigit,
                startTime: Date.now()
            });
            
            // Send request
            sendRequest(proposalRequest);
        }
        
        // MODIFIED STAKE UPDATE WITH SMART SESSION SUPPORT
        function updateStake(winOrLoss) {
            window.baseStake = parseFloat(document.getElementById('baseStake').value) || 1.0;
            window.multiplier = parseFloat(document.getElementById('multiplier').value) || 1.15;
            window.maxTrades = parseInt(maxTradesInput.value) || 10;
            
            // Update smart session stake if active
            if (sessionState.active && sessionState.mode === 'smart') {
                updateSmartStakeAfterTrade(winOrLoss);
                
                // Also update main bot's stake
                window.currentStake = sessionState.currentStake;
            } else {
                // Original martingale logic
                if (winOrLoss === 'win') {
                    window.martingaleStep = 0;
                    window.currentStake = window.baseStake;
                    log(`‚úÖ WIN! Martingale reset. Next stake: $${window.currentStake.toFixed(2)}`, 'MARTINGALE');
                } else if (winOrLoss === 'loss') {
                    window.martingaleStep++;
                    
                    if (window.martingaleStep >= window.maxTrades) {
                        log(`üõë MAX TRADES REACHED (${window.maxTrades}). Stopping bot.`, 'CRITICAL');
                        stopBot();
                        return;
                    }
                    
                    const newStake = window.currentStake * window.multiplier;
                    window.currentStake = parseFloat(newStake.toFixed(2));
                    log(`‚ùå LOSS. Martingale Step ${window.martingaleStep}. Next stake: $${window.currentStake.toFixed(2)}`, 'MARTINGALE');
                } else {
                    window.martingaleStep = 0;
                    window.currentStake = window.baseStake;
                    log(`Starting strategy. Base stake: $${window.currentStake.toFixed(2)}`, 'MARTINGALE');
                }
            }
            
            // Update display
            const stakeElem = document.getElementById('metricCurrentStake');
            stakeElem.textContent = `$${window.currentStake.toFixed(2)}`;
            
            if (winOrLoss === 'win') {
                stakeElem.className = 'text-lg font-bold current-stake-green';
            } else {
                stakeElem.className = 'text-lg font-bold text-white';
            }
        }
        
        // MODIFIED BOT START WITH ANALYSIS RESET
        function startBot() {
            if (window.isBotRunning) return;
            
            // Check if we have a valid token
            if (!window.DERIV_TOKEN) {
                log('‚ùå No authentication token found', 'CRITICAL');
                showNotification('Please authenticate via the portal first', 'error');
                return;
            }
            
            resetAllState();
            
            // Reset analysis engine
            lastDigits = [];
            analysisState.suggestedDigit = null;
            updateTickProgressUI();
            updatePredictionUI(analysisState);
            
            window.isBotRunning = true;
            updateButtonState();
            
            if (sessionState.mode === 'smart') {
                log('üöÄ SMART ANALYSIS Bot started. Waiting for analysis...', 'STRATEGY');
            } else {
                log('üöÄ INSTANT TICK EXECUTION Bot started. Trading on EVERY tick!', 'STRATEGY');
            }
            
            updateStake('initial');
            updateSessionUI("READY", "Bot started - " + (sessionState.mode === 'smart' ? "Smart Mode" : "Instant Mode"));
            
            initTone();
            connectWebSocket();
            
            const controls = document.querySelectorAll('#controls-section input, #controls-section select');
            controls.forEach(control => {
                control.disabled = true;
                control.classList.add('opacity-50', 'cursor-not-allowed');
            });
        }
        
        // MODIFIED BOT STOP WITH SESSION CLEANUP
        function stopBot() {
            if (!window.isBotRunning) return;
            
            window.isBotRunning = false;
            window.nextTradeAllowed = false;
            window.stopAfterWin = false;
            updateButtonState();
            
            // End any active session
            if (sessionState.active) {
                endSession("Bot stopped");
            }
            
            log('‚èπÔ∏è Bot stopped', 'SYSTEM');
            
            // Final PnL calculation
            log(`üìä FINAL PnL: $${window.netProfit.toFixed(2)} (Balance: $${window.currentBalance.toFixed(2)} - Starting: $${window.startingBalance.toFixed(2)})`, 'PNL');
            log(`üìà Performance: ${window.stats.wins} wins, ${window.stats.losses} losses, ${window.tradeCount} total trades`, 'STATS');
            
            stopWebSocketKeepAlive();
            
            if (window.ws) {
                window.ws.close();
                window.ws = null;
            }
            window.tickSubscriptionSent = false;
            window.pendingProposals.clear();
            window.activeContracts.clear();
            window.executionLock = false;
            
            const controls = document.querySelectorAll('#controls-section input, #controls-section select');
            controls.forEach(control => {
                control.disabled = false;
                control.classList.remove('opacity-50', 'cursor-not-allowed');
            });
            
            document.getElementById('status-badge').textContent = 'Disconnected';
            document.getElementById('status-badge').className = 'ml-3 inline-flex items-center px-3 py-1 text-sm font-medium rounded-full bg-red-600 text-white shadow-md';
            updateTradeResultStatus();
        }
        
        // Keep existing helper functions (they remain the same)
        function updateContractTypeDisplay() {
            const contractType = contractTypeSelect.value;
            let badgeText = contractType;
            let badgeColor = 'bg-purple-600';
            
            if (contractType === 'DIGITMATCH') {
                badgeText = 'DIGITMATCH (INSTANT)';
                badgeColor = 'bg-purple-600';
            }
            
            contractTypeBadge.textContent = badgeText;
            contractTypeBadge.className = `contract-type-badge ${badgeColor} text-white`;
        }
        
        function calculateRates() {
            const now = Date.now();
            window.tickTimestamps = window.tickTimestamps.filter(ts => now - ts < 5000);
            window.tickRate = window.tickTimestamps.length / 5;
            document.getElementById('metricTickRate').textContent = `Ticks/sec: ${window.tickRate.toFixed(1)}`;
        }
        
        function toggleSound() {
            window.soundEnabled = !window.soundEnabled;
            localStorage.setItem('soundEnabled', window.soundEnabled);
            updateSoundButton();
            log(`üîä Sound ${window.soundEnabled ? 'ENABLED' : 'DISABLED'}`, 'INFO');
        }
        
        function updateSoundButton() {
            if (soundToggleButton) {
                soundToggleButton.textContent = window.soundEnabled ? 'üîä Sound ON' : 'üîá Sound OFF';
                soundToggleButton.className = window.soundEnabled ? 
                    'px-4 py-2 bg-blue-600 text-white font-bold rounded-lg shadow hover:bg-blue-700 transition' :
                    'px-4 py-2 bg-gray-600 text-white font-bold rounded-lg shadow hover:bg-gray-700 transition';
            }
        }
        
        async function initTone() {
            if (!window.soundEnabled) return;
            
            if (typeof Tone === 'undefined') {
                console.error("Tone.js not loaded");
                return;
            }
            
            try {
                await Tone.start();
                window.synth = new Tone.Synth().toDestination();
                window.ToneInitialized = true;
            } catch (e) {
                console.error("Audio init error:", e);
            }
        }
        
        function playAudioFeedback(type) {
            if (!window.soundEnabled || !window.ToneInitialized || !window.synth) return;
            
            try {
                if (type === 'WIN') {
                    window.synth.triggerAttackRelease("C6", "8n");
                } else if (type === 'BIG_WIN') {
                    window.synth.triggerAttackRelease("C6", "8n");
                    window.synth.triggerAttackRelease("E6", "8n", Tone.now() + 0.1);
                } else if (type === 'LOSS') {
                    window.synth.triggerAttackRelease("C3", "16n");
                } else if (type === 'TICK') {
                    window.synth.triggerAttackRelease("C5", "32n");
                } else if (type === 'EXECUTION') {
                    window.synth.triggerAttackRelease("E5", "32n");
                } else if (type === 'INSTANT_WIN') {
                    window.synth.triggerAttackRelease("C6", "8n");
                    window.synth.triggerAttackRelease("G6", "8n", Tone.now() + 0.1);
                    window.synth.triggerAttackRelease("C7", "8n", Tone.now() + 0.2);
                }
            } catch (e) {
                console.error("Audio error:", e);
            }
        }
        
        function log(message, type = 'INFO') {
            const logArea = document.getElementById('log-area');
            const timestamp = new Date().toLocaleTimeString('en-US', { 
                hour12: false, 
                hour: '2-digit', 
                minute: '2-digit', 
                second: '2-digit',
                fractionalSecondDigits: 3 
            });
            
            let color = 'text-lime-400';
            if (type === 'ERROR') color = 'text-red-500 font-bold'; 
            if (type === 'WARNING') color = 'text-yellow-400';
            if (type === 'TRADE') color = 'text-green-300';
            if (type === 'WIN') color = 'text-green-400 font-bold';
            if (type === 'LOSS') color = 'text-red-400 font-bold';
            if (type === 'QUEUE') color = 'text-blue-400';
            if (type === 'TICK') color = 'text-cyan-300';
            if (type === 'MARTINGALE') color = 'text-purple-400';
            if (type === 'CONTRACT') color = 'text-pink-400';
            if (type === 'REAL_TRADE') color = 'text-yellow-300 font-bold';
            if (type === 'CRITICAL') color = 'text-red-400 font-bold';
            if (type === 'SYSTEM') color = 'text-white';
            if (type === 'STRATEGY') color = 'text-green-300 font-bold';
            if (type === 'INSTANT') color = 'text-green-400 font-bold';
            if (type === 'PNL') color = 'text-yellow-300 font-bold';
            if (type === 'ANALYSIS') color = 'text-cyan-300 font-bold';
            if (type === 'SMART') color = 'text-blue-300 font-bold';
            if (type === 'SESSION') color = 'text-purple-300 font-bold';
            
            logArea.innerHTML += `\n[${timestamp}] <span class="${color}">${message}</span>`;
            logArea.scrollTop = logArea.scrollHeight;
        }
        
        function updateButtonState() {
            if (!toggleButton) return;
            
            if (window.isBotRunning) {
                toggleButton.innerHTML = '<span class="flex items-center justify-center"><span class="mr-2">‚èπÔ∏è</span> STOP BOT</span>';
                toggleButton.classList.remove('bg-green-600', 'hover:bg-green-700', 'start-button-active');
                toggleButton.classList.add('stop-button-active', 'hover:bg-red-700');
            } else {
                toggleButton.innerHTML = '<span class="flex items-center justify-center"><span class="mr-2">üöÄ</span> START BOT</span>';
                toggleButton.classList.remove('stop-button-active', 'hover:bg-red-700');
                toggleButton.classList.add('bg-green-600', 'hover:bg-green-700', 'start-button-active');
            }
        }
        
        function updateTradeResultStatus() {
            const tradeResultElem = document.getElementById('metricTradeResult');
            const previousResultElem = document.getElementById('metricPreviousResult');
            const nextActionElem = document.getElementById('metricNextAction');
            const tradeResultContainer = document.getElementById('trade-result-container');
            
            if (window.stopAfterWin) {
                tradeResultElem.textContent = 'WIN';
                tradeResultElem.className = 'text-xs font-bold text-green-400';
                previousResultElem.textContent = `‚úÖ WIN - Strategy successful!`;
                nextActionElem.textContent = 'STOPPING BOT';
                tradeResultContainer.classList.add('trade-completed');
                tradeResultContainer.classList.remove('trade-failed');
            } else if (window.executionLock) {
                tradeResultElem.textContent = 'TRADING';
                tradeResultElem.className = 'text-xs font-bold text-yellow-400';
                previousResultElem.textContent = `Executing trade #${window.tradeCount}`;
                nextActionElem.textContent = 'Processing...';
                tradeResultContainer.classList.remove('trade-completed', 'trade-failed');
            } else {
                tradeResultElem.textContent = 'READY';
                tradeResultElem.className = 'text-xs font-bold text-gray-400';
                previousResultElem.textContent = 'Waiting for ticks...';
                nextActionElem.textContent = sessionState.mode === 'smart' ? 'Smart Mode: Analyzing...' : 'Execute on each tick';
                tradeResultContainer.classList.remove('trade-completed', 'trade-failed');
            }
        }
        
        function updateProbability() {
            if (!window.isBotRunning || window.digitsHistory.length < 10) return;
            
            const predictedDigit = parseInt(document.getElementById('predictedDigit').value);
            
            const frequency = window.digitsHistory.filter(d => d === predictedDigit).length;
            const probability = (frequency / window.digitsHistory.length) * 100;
            
            const probabilityElem = document.getElementById('metricProbability');
            probabilityElem.textContent = `Probability: ${probability.toFixed(1)}%`;
            
            if (probability > 15) {
                probabilityElem.className = 'text-xs font-bold probability-high';
            } else if (probability > 8) {
                probabilityElem.className = 'text-xs font-bold probability-medium';
            } else {
                probabilityElem.className = 'text-xs font-bold probability-low';
            }
        }
        
        function updateStrategyDisplay() {
            const currentMaxTrades = sessionState.active ? sessionState.maxTrades : window.maxTrades;
            const tradesLeft = currentMaxTrades - window.tradeCount;
            const tradesDone = window.tradeCount;
            
            document.getElementById('metricTradesDone').textContent = `${tradesDone}/${currentMaxTrades}`;
            document.getElementById('metricTradesLeft').textContent = tradesLeft;
            document.getElementById('metricTradesRemaining').textContent = currentMaxTrades;
            
            const progressPercent = Math.min(100, (window.tradeCount / currentMaxTrades) * 100);
            document.getElementById('executionBar').style.width = `${progressPercent}%`;
            document.getElementById('metricExecutedTrades').textContent = window.tradeCount;
        }
        
        function startQueueProcessor() {
            setInterval(() => {
                if (!window.isBotRunning || window.stopAfterWin) return;
                
                while (window.tickQueue.length > 0 && !window.executionLock && window.nextTradeAllowed) {
                    const tick = window.tickQueue.shift();
                    processTickImmediately(tick);
                }
            }, 50);
        }
        
        function addTickToQueue(tick) {
            window.digitsHistory.push(parseInt(tick.digit));
            if (window.digitsHistory.length > window.MAX_HISTORY) {
                window.digitsHistory.shift();
            }
            
            window.tickQueue.push(tick);
            
            if (window.tickQueue.length > window.maxQueueSize) {
                window.tickQueue.shift();
            }
            
            return true;
        }
        
        function checkForImmediateWin(tick) {
            if (!window.isBotRunning || window.stopAfterWin) return false;
            
            let predictedDigit;
            if (sessionState.active && sessionState.mode === 'smart') {
                predictedDigit = sessionState.targetDigit;
            } else {
                predictedDigit = parseInt(document.getElementById('predictedDigit').value);
            }
            
            const tickDigit = parseInt(tick.digit);
            
            if (tickDigit === predictedDigit) {
                log(`üéØ WIN DETECTED! Tick digit ${tickDigit} matches predicted ${predictedDigit}.`, 'IMMEDIATE_WIN');
                log(`‚úÖ STRATEGY SUCCESSFUL in ${window.tradeCount + 1} trades`, 'STRATEGY');
                
                window.lastTradeResult = 'win';
                window.stopAfterWin = true;
                window.stats.wins++;
                window.stats.digitMatches++;
                window.tradeCount++;
                
                const processingDigit = document.getElementById('processingTickDigit');
                processingDigit.textContent = tickDigit;
                processingDigit.classList.add('instant-win-detected');
                
                const tradeResultContainer = document.getElementById('trade-result-container');
                tradeResultContainer.classList.add('trade-completed');
                
                playAudioFeedback('INSTANT_WIN');
                updateTradeResultStatus();
                
                // Update stake for win
                updateStake('win');
                
                log(`üìä Waiting for balance update to calculate actual PnL...`, 'INFO');
                
                return true;
            }
            
            window.stats.digitNonMatches++;
            return false;
        }
        
        function updateProcessingTickDisplay(tick) {
            if (!tick) return;
            
            document.getElementById('processingTickDigit').textContent = tick.digit;
            document.getElementById('processingTickInfo').textContent = `Price: ${tick.price.toFixed(3)}`;
            document.getElementById('processingTickTime').textContent = new Date(tick.time).toLocaleTimeString();
            document.getElementById('processingTickDigit').classList.add('instant-tick');
            
            document.getElementById('metricPreviousResult').textContent = `Executing trade #${window.tradeCount}`;
            
            if (sessionState.active && sessionState.mode === 'smart') {
                document.getElementById('metricNextAction').textContent = `Smart: Digit ${sessionState.targetDigit}`;
            } else {
                document.getElementById('metricNextAction').textContent = `Digit: ${tick.digit}`;
            }
        }
        
        function updatePnL() {
            if (window.startingBalance > 0 && window.currentBalance > 0) {
                window.netProfit = window.currentBalance - window.startingBalance;
                
                const profitElem = document.getElementById('metricTotalProfit');
                profitElem.textContent = `$${window.netProfit.toFixed(2)}`;
                
                if (window.netProfit > 0) {
                    profitElem.className = 'text-lg font-bold profit-green success-pulse';
                } else if (window.netProfit < 0) {
                    profitElem.className = 'text-lg font-bold profit-red';
                } else {
                    profitElem.className = 'text-lg font-bold text-gray-300';
                }
                
                const now = Date.now();
                if (now - window.lastBalanceUpdate > 5000) {
                    log(`üìä PnL Update: $${window.netProfit.toFixed(2)} (Balance: $${window.currentBalance.toFixed(2)})`, 'PNL');
                    window.lastBalanceUpdate = now;
                }
            }
        }
        
        function onTradeComplete(isSuccess = true) {
            window.executionLock = false;
            window.nextTradeAllowed = true;
            
            updateStrategyDisplay();
            
            if (!isSuccess) {
                updateStake('loss');
            }
            
            if (window.stopAfterWin) {
                log(`‚úÖ WIN DETECTED! Strategy successful.`, 'STRATEGY');
                setTimeout(() => {
                    stopBot();
                }, 100);
                return;
            }
            
            const currentMaxTrades = sessionState.active ? sessionState.maxTrades : window.maxTrades;
            if (window.tradeCount >= currentMaxTrades) {
                log(`üõë Max trades reached (${currentMaxTrades}). Strategy complete.`, 'CRITICAL');
                stopBot();
                return;
            }
        }
        
        function sendRequest(request) {
            if (window.ws && window.ws.readyState === WebSocket.OPEN) {
                const message = JSON.stringify(request);
                window.ws.send(message);
                return request.req_id;
            }
            return null;
        }
        
        function getNextReqId() {
            return ++window.req_id;
        }
        
        function handleAPIResponse(data) {
            if (data.error) {
                log(`API Error: ${data.error.message}`, 'ERROR');
                if (data.error.code === 'InvalidToken') {
                    log('‚ùå Invalid API Token. Please check your token.', 'CRITICAL');
                    stopBot();
                }
                return;
            }
        
            if (data.msg_type === 'authorize') {
                if (data.authorize) {
                    log(`üîê Authorized as ${data.authorize.loginid}`, 'SYSTEM');
                    subscribeToTicks(document.getElementById('symbol').value);
                    subscribeToBalance();
                }
            } else if (data.msg_type === 'tick') {
                handleTick(data.tick);
            } else if (data.msg_type === 'proposal') {
                handleProposalResponse(data.proposal, data.req_id);
            } else if (data.msg_type === 'buy') {
                handleBuyResponse(data.buy);
            } else if (data.msg_type === 'balance') {
                handleBalanceUpdate(data.balance);
            } else if (data.msg_type === 'contract_update') {
                handleContractUpdate(data.contract_update);
            } else if (data.msg_type === 'ping') {
                window.lastPingTime = Date.now();
            }
        }
        
        function subscribeToBalance() {
            sendRequest({
                balance: 1,
                subscribe: 1,
                req_id: getNextReqId()
            });
            log('Subscribed to balance updates', 'SYSTEM');
        }
        
        function handleBalanceUpdate(balanceData) {
            const newBalance = parseFloat(balanceData.balance);
            
            if (window.startingBalance === 0) {
                window.startingBalance = newBalance;
                log(`üí∞ Starting Balance: $${window.startingBalance.toFixed(2)}`, 'PNL');
            }
            
            window.currentBalance = newBalance;
            
            const balanceElem = document.getElementById('metricAccountBalance');
            balanceElem.textContent = `$${window.currentBalance.toFixed(2)}`;
            
            updatePnL();
            
            if (window.netProfit > 0) {
                balanceElem.className = 'text-lg font-bold account-balance-green';
            } else if (window.netProfit < 0) {
                balanceElem.className = 'text-lg font-bold text-red-400';
            } else if (window.currentBalance > 50) {
                balanceElem.className = 'text-lg font-bold text-green-400';
            } else if (window.currentBalance > 25) {
                balanceElem.className = 'text-lg font-bold text-yellow-400';
            } else {
                balanceElem.className = 'text-lg font-bold text-red-400';
            }
            
            const bankrollLimit = parseFloat(document.getElementById('bankrollLimit').value) || 25.0;
            let currentStakeToCheck = sessionState.active ? sessionState.currentStake : window.currentStake;
            
            if (currentStakeToCheck > window.currentBalance || window.currentBalance <= bankrollLimit) {
                log(`üõë Bankroll Limit Reached. Stopping bot.`, 'CRITICAL');
                stopBot();
            }
        }
        
        function handleContractUpdate(contractUpdate) {
            if (contractUpdate.status === 'sold') {
                const profit = parseFloat(contractUpdate.profit);
                const contractId = contractUpdate.contract_id;
                
                if (profit > 0) {
                    log(`‚úÖ Contract ${contractId} WON: $${profit.toFixed(2)}`, 'WIN');
                } else if (profit < 0) {
                    log(`‚ùå Contract ${contractId} LOST: $${Math.abs(profit).toFixed(2)}`, 'LOSS');
                }
                
                if (profit > 0 && window.stopAfterWin) {
                    log(`üèÜ Winning contract settled!`, 'STRATEGY');
                }
            }
        }
        
        function subscribeToTicks(symbol) {
            if (window.tickSubscriptionSent) return;
            
            sendRequest({
                ticks: symbol,
                subscribe: 1,
                req_id: getNextReqId()
            });
            window.tickSubscriptionSent = true;
            log(`‚úÖ Subscribed to ticks for ${symbol}`, 'SYSTEM');
        }
        
        function handleProposalResponse(proposal, req_id) {
            if (!proposal || !proposal.id) {
                log(`‚ùå Proposal request failed`, 'ERROR');
                onTradeComplete(false);
                return;
            }
        
            const pending = window.pendingProposals.get(req_id);
            if (!pending) {
                log(`‚ùå No pending proposal found`, 'ERROR');
                onTradeComplete(false);
                return;
            }
        
            window.pendingProposals.delete(req_id);
            executeBuy(proposal.id, proposal.ask_price, pending);
        }
        
        function executeBuy(proposal_id, ask_price, pending) {
            const buyRequest = {
                buy: proposal_id,
                price: ask_price,
                req_id: getNextReqId()
            };
            
            log(`‚úÖ Buying contract for $${pending.stake.toFixed(2)}`, 'TRADE');
            
            window.pendingProposals.set(buyRequest.req_id, {
                ...pending,
                proposal_id: proposal_id,
                buyStartTime: Date.now()
            });
            
            sendRequest(buyRequest);
        }
        
        function handleBuyResponse(buyData) {
            if (buyData.contract_id) {
                const buyTime = Date.now() - (window.pendingProposals.get(buyData.req_id)?.buyStartTime || Date.now());
                log(`‚úÖ Trade executed in ${buyTime}ms`, 'INSTANT');
                
                // Update stake for loss (since wins are detected from tick)
                updateStake('loss');
                
                // If smart session is active, update its stake too
                if (sessionState.active && sessionState.mode === 'smart') {
                    updateSmartStakeAfterTrade('loss');
                }
                
                onTradeComplete(true);
            } else {
                log(`‚ùå Trade execution failed`, 'ERROR');
                onTradeComplete(false);
            }
        }
        
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 px-4 py-3 rounded-lg shadow-lg z-50 ${
                type === 'error' ? 'bg-red-600 text-white' :
                type === 'success' ? 'bg-green-600 text-white' :
                'bg-blue-600 text-white'
            }`;
            notification.innerHTML = `
                <div class="flex items-center">
                    <span class="mr-2">${type === 'error' ? '‚ùå' : type === 'success' ? '‚úÖ' : '‚ÑπÔ∏è'}</span>
                    <span>${message}</span>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }
        
        function toggleBot() {
            if (window.isBotRunning) {
                stopBot();
            } else {
                startBot();
            }
        }
        
        function resetAllState() {
            updateStake('initial');
            
            window.startingBalance = 0.0;
            window.currentBalance = 0.0;
            window.netProfit = 0.0;
            window.lastBalanceUpdate = 0;
            
            const profitElem = document.getElementById('metricTotalProfit');
            profitElem.textContent = '$0.00';
            profitElem.className = 'text-lg font-bold text-gray-300';
            
            document.getElementById('metricTradeCount').textContent = '0';
            
            const balanceElem = document.getElementById('metricAccountBalance');
            balanceElem.textContent = '$---';
            balanceElem.className = 'text-lg font-bold text-white';
            
            document.getElementById('metricLiveTick').textContent = '---';
            document.getElementById('metricLastDigit').textContent = 'Digit: ?';
            
            window.stats = {
                totalTicks: 0,
                tradesExecuted: 0,
                wins: 0,
                losses: 0,
                digitMatches: 0,
                digitNonMatches: 0
            };
            
            window.tickQueue = [];
            window.digitsHistory = [];
            
            window.lastTick = null;
            window.lastTradeResult = null;
            window.tradeCount = 0;
            window.martingaleStep = 0;
            window.pendingProposals.clear();
            window.activeContracts.clear();
            window.tickTimestamps = [];
            
            window.executionLock = false;
            window.waitingForTradeResult = false;
            window.nextTradeAllowed = true;
            window.stopAfterWin = false;
            window.currentlyProcessingTick = null;
            
            const logArea = document.getElementById('log-area');
            logArea.innerHTML = '[00:00:00] ü§ñ Starting with SMART ANALYSIS ENGINE...';
            
            updateTradeResultStatus();
            updateStrategyDisplay();
            
            log('üîÑ ALL STATE RESET: Ready for new session', 'SYSTEM');
        }
        
        function startWebSocketKeepAlive() {
            stopWebSocketKeepAlive();
            window.wsPingInterval = setInterval(() => {
                if (window.ws && window.ws.readyState === WebSocket.OPEN) {
                    if (Date.now() - window.lastPingTime > 10000) {
                        sendRequest({ ping: 1, req_id: getNextReqId() });
                    }
                }
            }, 5000);
        }
        
        function stopWebSocketKeepAlive() {
            if (window.wsPingInterval) {
                clearInterval(window.wsPingInterval);
                window.wsPingInterval = null;
            }
        }
    </script>
</body>
</html>
