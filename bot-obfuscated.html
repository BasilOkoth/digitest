<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>DigitMatchStar Pro‚Ñ¢ - Private Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <style>
        /* ORIGINAL STYLES PRESERVED */
        #log-area::-webkit-scrollbar { width: 4px; }
        #log-area::-webkit-scrollbar-thumb { background: #4ade80; border-radius: 2px; }
        body { font-family: 'Inter', sans-serif; background-color: #111827; }
        @keyframes pulse-once { 0% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.03); opacity: 0.9; } 100% { transform: scale(1); opacity: 1; } }
        .stop-button-active { background-color: #dc2626 !important; border: 2px solid #fca5a5 !important; animation: pulse-once 0.5s infinite; }
        .profit-green { color: #10B981 !important; font-weight: bold; }
        .profit-red { color: #ef4444 !important; font-weight: bold; }
        
        /* Account Switcher UI */
        .switch { position: relative; display: inline-block; width: 44px; height: 20px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; inset: 0; background-color: #374151; transition: .4s; border-radius: 34px; border: 1px solid #4ade80; }
        .slider:before { position: absolute; content: ""; height: 14px; width: 14px; left: 3px; bottom: 2px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #10b981; }
        input:checked + .slider:before { transform: translateX(24px); }
    </style>
</head>
<body class="min-h-screen p-4 sm:p-8 flex items-start justify-center">

    <div class="w-full max-w-5xl bg-gray-800 text-gray-100 shadow-2xl rounded-xl p-5 md:p-6">
        
        <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4 border-b border-gray-700 pb-4">
            <div>
                <h1 class="text-2xl font-black text-green-400">DigitMatchStar Pro‚Ñ¢</h1>
                <div class="flex items-center gap-2 mt-1">
                    <span id="status-badge" class="px-2 py-0.5 text-[10px] rounded-full bg-red-600 uppercase font-bold">Disconnected</span>
                    <span id="account-id-display" class="text-xs text-gray-400 font-mono">Guest Mode</span>
                </div>
            </div>

            <div class="flex items-center gap-4 bg-gray-900/50 p-2 px-4 rounded-xl border border-gray-700">
                <div class="flex items-center gap-2">
                    <span class="text-[10px] font-bold text-gray-400 uppercase">Demo</span>
                    <label class="switch">
                        <input type="checkbox" id="account-toggle" onchange="switchAccount()">
                        <span class="slider"></span>
                    </label>
                    <span class="text-[10px] font-bold text-green-400 uppercase">Real</span>
                </div>
                
                <div class="h-6 w-[1px] bg-gray-700 mx-2"></div>

                <a href="https://track.deriv.com/_0rfpRaHuZeFMjdsyM5hasGNd7ZgqdRLk/1/" target="_blank" class="text-[10px] font-bold text-blue-400 hover:underline uppercase">Sign Up (Affiliate)</a>
                <button onclick="logout()" class="text-red-400 hover:text-red-300 transition text-[10px] font-bold uppercase">Logout</button>
            </div>
        </div>

        <div class="flex flex-col md:flex-row gap-4 mb-6">
            <div id="controls-section" class="md:w-2/3 grid grid-cols-2 lg:grid-cols-3 gap-3">
                <input type="hidden" id="derivToken">

                <div>
                    <label for="symbol" class="block text-xs font-semibold text-gray-300 mb-1">Symbol</label>
                    <select id="symbol" class="block w-full rounded-md bg-gray-700 border border-gray-600 text-white py-1.5 px-2 text-sm">
                        <option value="R_10">V. 10 Index</option>
                        <option value="R_100">V. 100 Index</option>
                        <option value="R_25">V. 25 Index</option>
                        <option value="R_50">V. 50 Index</option>
                        <option value="R_75">V. 75 Index</option>
                    </select>
                </div>
                
                <div>
                    <label for="predictedDigit" class="block text-xs font-semibold text-gray-300 mb-1">Predicted Digit</label>
                    <input type="number" id="predictedDigit" value="5" min="0" max="9" class="block w-full rounded-md bg-gray-700 border-gray-600 text-white py-1.5 px-2 text-sm text-center">
                </div>

                <div>
                    <label class="block text-xs font-semibold text-gray-300 mb-1">Contract</label>
                    <div class="bg-purple-900/30 text-purple-400 border border-purple-500/50 rounded-md py-1.5 px-2 text-[10px] font-bold text-center uppercase">DigitMatch</div>
                </div>

                <div>
                    <label for="baseStake" class="block text-xs font-semibold text-gray-300 mb-1">Base Stake</label>
                    <input type="number" id="baseStake" value="1.0" class="block w-full rounded-md bg-gray-700 border-gray-600 text-white py-1.5 px-2 text-sm">
                </div>

                <div>
                    <label for="multiplier" class="block text-xs font-semibold text-gray-300 mb-1">Martingale</label>
                    <input type="number" id="multiplier" value="1.15" step="0.01" class="block w-full rounded-md bg-gray-700 border-gray-600 text-white py-1.5 px-2 text-sm">
                </div>

                <div>
                    <label for="maxTrades" class="block text-xs font-semibold text-gray-300 mb-1">Max Trades</label>
                    <input type="number" id="maxTrades" value="10" class="block w-full rounded-md bg-gray-700 border-gray-600 text-white py-1.5 px-2 text-sm">
                </div>
                
                <div class="col-span-2 lg:col-span-3 bg-gray-900/50 p-3 rounded-lg border border-gray-700">
                    <p class="text-[10px] text-green-400 font-bold uppercase mb-1">‚ö° Instant Execution Mode</p>
                    <p class="text-[10px] text-gray-400 italic">Bot executes trades on every tick and stops on a match. TICK QUEUE visualization removed for clarity.</p>
                </div>
            </div>

            <div id="metrics-column" class="md:w-1/3">
                <div class="grid grid-cols-2 gap-3">
                    <div class="bg-gray-900 p-3 rounded-lg border border-green-500/30 text-center col-span-2">
                        <p class="text-[10px] text-gray-400 uppercase">Live Tick</p>
                        <p id="metricLiveTick" class="text-2xl font-black text-white">---</p>
                        <p id="metricLastDigit" class="text-xs font-bold text-green-400">Digit: ?</p>
                    </div>
                    <div class="bg-gray-700 p-2 rounded-lg text-center">
                        <p class="text-[9px] text-gray-400 uppercase">Balance</p>
                        <p id="metricAccountBalance" class="text-sm font-bold text-white">$---</p>
                    </div>
                    <div class="bg-gray-700 p-2 rounded-lg text-center">
                        <p class="text-[9px] text-gray-400 uppercase">PnL</p>
                        <p id="metricTotalProfit" class="text-sm font-bold text-gray-300">$0.00</p>
                    </div>
                </div>
                
                <div id="trade-result-container" class="mt-3 bg-gray-900 p-3 rounded-lg border border-yellow-500/50">
                    <div class="flex justify-between items-center">
                        <p class="text-[10px] text-yellow-500 font-bold uppercase">Bot Status</p>
                        <p id="metricTradeResult" class="text-[10px] font-bold text-gray-500">STANDBY</p>
                    </div>
                    <p id="metricPreviousResult" class="text-xs mt-1 text-gray-300 font-medium italic">Login to start...</p>
                </div>
            </div>
        </div>
        
        <button id="toggleButton" onclick="toggleBot()" class="w-full py-4 bg-green-600 text-white font-black text-xl rounded-xl shadow-2xl hover:bg-green-700 transition-all uppercase tracking-widest">
            Start Trading
        </button>

        <div id="log-area" class="mt-6 h-60 bg-gray-900 text-lime-400 p-4 rounded-xl overflow-y-scroll text-[11px] font-mono border border-gray-700">
            [SYSTEM] Bot Initialized. Authenticate via login page to enable trading.
        </div>
    </div>

    <script>
        // --- AUTHENTICATION LOGIC ---
        let accounts = JSON.parse(localStorage.getItem('deriv_accounts')) || [];

        function checkAuthentication() {
            if (accounts.length === 0) {
                log('‚ùå AUTH ERROR: Please login via index.html', 'ERROR');
                document.getElementById('metricPreviousResult').textContent = 'Authentication Required';
                // Redirect to login if not authenticated
                setTimeout(() => { window.location.href = 'index.html'; }, 3000);
                return;
            }
            // Auto-select first account (usually Demo by default)
            switchAccount();
        }

        function switchAccount() {
            if (window.isBotRunning) {
                alert("Please stop the bot before switching accounts.");
                document.getElementById('account-toggle').checked = !document.getElementById('account-toggle').checked;
                return;
            }
            const isReal = document.getElementById('account-toggle').checked;
            const targetAccount = accounts.find(acc => isReal ? !acc.is_virtual : acc.is_virtual);
            
            if (targetAccount) {
                window.DERIV_TOKEN = targetAccount.token;
                document.getElementById('derivToken').value = targetAccount.token;
                document.getElementById('account-id-display').textContent = `Account: ${targetAccount.loginid}`;
                log(`Switched to ${isReal ? 'REAL' : 'DEMO'} account: ${targetAccount.loginid}`, 'SYSTEM');
            } else {
                alert(`No ${isReal ? 'Real' : 'Demo'} account found in your login session.`);
                document.getElementById('account-toggle').checked = !isReal;
            }
        }

        function logout() {
            localStorage.clear();
            window.location.href = 'index.html';
        }

        // --- CORE TRADING LOGIC ---
        window.ws = null;
        window.isBotRunning = false;
        window.tradeCount = 0;
        window.currentStake = 1.0;
        window.executionLock = false;
        window.stopAfterWin = false;
        window.startingBalance = 0;

        // Correct digit extraction logic preserved
        function extractLastDigitBySymbol(price) {
            const symbol = document.getElementById('symbol').value;
            let decimalPlaces = (symbol === 'R_100') ? 2 : 3;
            const formatted = price.toFixed(decimalPlaces);
            return formatted.charAt(formatted.length - 1);
        }

        function handleTick(tick) {
            if (!window.isBotRunning) return;
            const price = parseFloat(tick.quote);
            const digit = extractLastDigitBySymbol(price);
            
            document.getElementById('metricLiveTick').textContent = price.toFixed(3);
            document.getElementById('metricLastDigit').textContent = `Digit: ${digit}`;
            
            // Logic: Immediate Match Detection
            if (parseInt(digit) === parseInt(document.getElementById('predictedDigit').value)) {
                log(`üéØ MATCH! Digit ${digit} detected. Strategy Successful.`, 'WIN');
                window.stopAfterWin = true;
                updateTradeResultStatus();
                return;
            }
            
            // Logic: Execute Trade if not locked
            if (!window.executionLock && !window.stopAfterWin) {
                if (window.tradeCount < parseInt(document.getElementById('maxTrades').value)) {
                    executeTrade(digit, price);
                } else {
                    log('üõë Max trades reached. Stopping.', 'SYSTEM');
                    stopBot();
                }
            }
        }

        function executeTrade(digit, price) {
            window.executionLock = true;
            window.tradeCount++;
            
            const req = {
                proposal: 1,
                amount: window.currentStake.toFixed(2),
                basis: "stake",
                contract_type: "DIGITMATCH",
                currency: "USD",
                duration: 1,
                duration_unit: "t",
                symbol: document.getElementById('symbol').value,
                barrier: document.getElementById('predictedDigit').value
            };
            
            sendRequest(req);
            log(`‚ö° Execution #${window.tradeCount} ($${window.currentStake.toFixed(2)})`, 'TRADE');
            
            // Apply Martingale Stake
            const mult = parseFloat(document.getElementById('multiplier').value);
            window.currentStake = parseFloat((window.currentStake * mult).toFixed(2));
        }

        function connectWebSocket() {
            const token = document.getElementById('derivToken').value;
            window.ws = new WebSocket('wss://ws.binaryws.com/websockets/v3?app_id=1089');
            
            window.ws.onopen = () => {
                sendRequest({ authorize: token });
            };

            window.ws.onmessage = (msg) => {
                const data = JSON.parse(msg.data);
                if (data.msg_type === 'authorize') {
                    sendRequest({ ticks: document.getElementById('symbol').value, subscribe: 1 });
                    sendRequest({ balance: 1, subscribe: 1 });
                    log('‚úÖ WebSocket Connected & Authorized', 'SYSTEM');
                    document.getElementById('status-badge').textContent = 'Connected';
                    document.getElementById('status-badge').className = 'px-2 py-0.5 text-[10px] rounded-full bg-green-600 uppercase font-bold';
                }
                if (data.msg_type === 'tick') handleTick(data.tick);
                if (data.msg_type === 'balance') updateBalanceMetrics(data.balance);
                if (data.msg_type === 'buy') { window.executionLock = false; }
            };
        }

        function updateBalanceMetrics(data) {
            const bal = parseFloat(data.balance);
            if (window.startingBalance === 0) window.startingBalance = bal;
            const profit = bal - window.startingBalance;
            
            document.getElementById('metricAccountBalance').textContent = `$${bal.toFixed(2)}`;
            const profEl = document.getElementById('metricTotalProfit');
            profEl.textContent = `$${profit.toFixed(2)}`;
            profEl.className = profit >= 0 ? 'text-sm font-bold profit-green' : 'text-sm font-bold profit-red';
        }

        function sendRequest(req) { if (window.ws?.readyState === 1) window.ws.send(JSON.stringify(req)); }

        function toggleBot() { window.isBotRunning ? stopBot() : startBot(); }

        function startBot() {
            if (!document.getElementById('derivToken').value) {
                alert("Authentication missing. Please login.");
                return;
            }
            window.isBotRunning = true;
            window.tradeCount = 0;
            window.stopAfterWin = false;
            window.currentStake = parseFloat(document.getElementById('baseStake').value);
            updateButtonUI();
            connectWebSocket();
            log('üöÄ Bot Started - Running Instant Execution', 'SYSTEM');
        }

        function stopBot() {
            window.isBotRunning = false;
            updateButtonUI();
            if (window.ws) window.ws.close();
            log('‚èπÔ∏è Bot Stopped', 'SYSTEM');
            document.getElementById('status-badge').textContent = 'Disconnected';
            document.getElementById('status-badge').className = 'px-2 py-0.5 text-[10px] rounded-full bg-red-600 uppercase font-bold';
        }

        function updateButtonUI() {
            const btn = document.getElementById('toggleButton');
            if (window.isBotRunning) {
                btn.textContent = 'STOP BOT';
                btn.classList.add('stop-button-active');
            } else {
                btn.textContent = 'START TRADING';
                btn.classList.remove('stop-button-active');
            }
        }

        function updateTradeResultStatus() {
            if (window.stopAfterWin) {
                document.getElementById('metricTradeResult').textContent = 'WIN DETECTED';
                document.getElementById('metricTradeResult').className = 'text-[10px] font-bold text-green-400';
                setTimeout(stopBot, 1500);
            }
        }

        function log(msg, type) {
            const area = document.getElementById('log-area');
            const time = new Date().toLocaleTimeString();
            area.innerHTML += `\n[${time}] ${msg}`;
            area.scrollTop = area.scrollHeight;
        }

        window.onload = checkAuthentication;
    </script>
</body>
</html>
