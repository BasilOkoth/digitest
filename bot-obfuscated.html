<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Deriv DigitMatchStar Bot - MULTI-DIGIT QUEUE</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <style>
        #log-area::-webkit-scrollbar { width: 4px; }
        #log-area::-webkit-scrollbar-thumb { background: #4ade80; border-radius: 2px; }
        #log-area::-webkit-scrollbar-track { background: #374151; }
        body { font-family: 'Inter', sans-serif; background-color: #111827; }
        @keyframes pulse-once { 0% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.03); opacity: 0.9; } 100% { transform: scale(1); opacity: 1; } }
        .tick-flash { animation: pulse-once 0.1s ease-out; }
        @keyframes win-pulse { 
            0% { 
                box-shadow: 0 0 5px #10B981, 0 0 10px rgba(16, 185, 129, 0.5); 
                border-color: #10B981;
                background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(16, 185, 129, 0.2)) !important;
            } 
            50% { 
                box-shadow: 0 0 30px #10B981, 0 0 50px rgba(16, 185, 129, 0.8); 
                border-color: #34d399;
                background: linear-gradient(135deg, rgba(16, 185, 129, 0.3), rgba(16, 185, 129, 0.4)) !important;
            } 
            100% { 
                box-shadow: 0 0 5px #10B981, 0 0 10px rgba(16, 185, 129, 0.5); 
                border-color: #10B981;
                background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(16, 185, 129, 0.2)) !important;
            } 
        }
        .win-glow {
            animation: win-pulse 1s infinite;
        }
        .pnl-update-animation {
            animation: pnl-pulse 0.5s ease-in-out;
        }
        @keyframes pnl-pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        .queue-digit { 
            width: 32px; 
            height: 32px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            border-radius: 50%; 
            font-weight: bold; 
            margin: 0 2px;
        }
        .contract-type-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: bold;
            margin-left: 5px;
        }
        .stop-button-active {
            background-color: #dc2626 !important;
            border: 2px solid #fca5a5 !important;
            animation: pulse-once 0.5s infinite;
        }
        .start-button-active {
            background-color: #16a34a !important;
            border: 2px solid #86efac !important;
            animation: pulse-once 0.5s;
        }
        .analysis-active {
            border: 2px solid #00ffea !important;
            box-shadow: 0 0 10px rgba(0, 255, 234, 0.3) !important;
        }
        .analysis-complete {
            border: 2px solid #10b981 !important;
            background-color: #064e3b20 !important;
        }
        .connection-badge-connected {
            background: linear-gradient(90deg, #10b981, #059669) !important;
        }
        .connection-badge-disconnected {
            background: linear-gradient(90deg, #dc2626, #b91c1c) !important;
        }
        .connection-badge-connecting {
            background: linear-gradient(90deg, #f59e0b, #d97706) !important;
        }
        /* Account Toggle */
        .account-toggle-container {
            display: inline-flex;
            align-items: center;
            margin-left: 15px;
            background: rgba(0, 0, 0, 0.3);
            padding: 2px 10px;
            border-radius: 20px;
        }
        .account-toggle {
            position: relative;
            display: inline-block;
            width: 44px;
            height: 22px;
            margin: 0 8px;
        }
        .account-toggle input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .account-toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #1e40af;
            border-radius: 34px;
            transition: .4s;
        }
        .account-toggle-slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            border-radius: 50%;
            transition: .4s;
        }
        input:checked + .account-toggle-slider {
            background-color: #059669;
        }
        input:checked + .account-toggle-slider:before {
            transform: translateX(22px);
        }
        .account-label {
            font-size: 12px;
            font-weight: 600;
        }
        .account-label-demo {
            color: #3b82f6;
        }
        .account-label-real {
            color: #10b981;
        }
        .profit-positive {
            color: #10b981 !important;
            font-weight: bold !important;
        }
        .profit-negative {
            color: #ef4444 !important;
            font-weight: bold !important;
        }
        .profit-neutral {
            color: #d1d5db !important;
            font-weight: bold !important;
        }
        .session-digit-locked {
            background: linear-gradient(135deg, #1e3a8a, #1e40af) !important;
            border: 2px solid #3b82f6 !important;
            color: white !important;
        }
        .status-win {
            color: #10b981 !important;
            font-weight: bold !important;
            text-shadow: 0 0 10px rgba(16, 185, 129, 0.5);
        }
        .status-loss {
            color: #ef4444 !important;
            font-weight: bold !important;
        }
        .status-trade {
            color: #f59e0b !important;
            font-weight: bold !important;
        }
        /* Calculator Styles */
        .calculator-highlight {
            background: linear-gradient(135deg, #7c3aed, #8b5cf6) !important;
            border: 1px solid #a78bfa !important;
            color: white !important;
        }
        .calculator-warning {
            background: linear-gradient(135deg, #dc2626, #ef4444) !important;
            border: 1px solid #f87171 !important;
            color: white !important;
        }
        .calculator-safe {
            background: linear-gradient(135deg, #059669, #10b981) !important;
            border: 1px solid #34d399 !important;
            color: white !important;
        }
        @keyframes calculator-pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.02); }
            100% { transform: scale(1); }
        }
        .calculator-pulse {
            animation: calculator-pulse 0.5s ease-out;
        }
        /* Recheck Badge */
        .recheck-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: bold;
            margin-left: 5px;
            background: linear-gradient(90deg, #8b5cf6, #7c3aed);
            color: white;
        }
        .loss-streak-high {
            color: #ef4444 !important;
            animation: pulse-once 0.5s infinite;
        }
        /* Digit Queue Styles */
        .digit-queue-container {
            background: rgba(30, 41, 59, 0.5);
            border-radius: 10px;
            padding: 10px;
            border: 1px solid #374151;
        }
        .digit-queue-item {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            margin: 2px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
        }
        .digit-queue-item:hover {
            transform: scale(1.1);
        }
        .digit-queue-active {
            border: 2px solid #10B981 !important;
            box-shadow: 0 0 10px rgba(16, 185, 129, 0.5);
            background: linear-gradient(135deg, #10b981, #059669) !important;
        }
        .digit-queue-next {
            border: 2px solid #f59e0b !important;
            background: linear-gradient(135deg, #f59e0b, #d97706) !important;
        }
        .queue-mode-active {
            background: linear-gradient(135deg, #8b5cf6, #7c3aed) !important;
            border-color: #8b5cf6 !important;
        }
        .queue-input-highlight {
            animation: pulse-once 0.5s;
        }
        .queue-status-box {
            background: rgba(30, 41, 59, 0.8);
            border: 1px solid #4b5563;
            border-radius: 8px;
            padding: 8px;
            font-size: 11px;
        }
        .balance-green {
            color: #10b981 !important;
            font-weight: bold !important;
        }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght400;600;700&display=swap" rel="stylesheet">
</head>
<body class="min-h-screen p-4 sm:p-8 flex items-start justify-center">

    <div class="w-full max-w-6xl bg-gray-800 text-gray-100 shadow-2xl rounded-xl p-5 md:p-6">
        <div class="flex justify-between items-center mb-4">
            <h1 class="text-3xl font-extrabold text-green-400 border-b border-gray-700 pb-2">
                Deriv DigitMatchStar Bot 
                <span id="status-badge" class="ml-3 inline-flex items-center px-3 py-1 text-sm font-medium rounded-full connection-badge-disconnected text-white shadow-md">
                    üî¥ DISCONNECTED
                </span>
                <span id="contract-type-badge" class="contract-type-badge bg-purple-600 text-white">DIGITMATCH</span>
                <span id="recheck-badge" class="recheck-badge hidden">QUEUE SYSTEM</span>
                <!-- Account toggle -->
                <div class="account-toggle-container ml-3">
                    <span class="account-label account-label-demo">DEMO</span>
                    <label class="account-toggle">
                        <input type="checkbox" id="accTypeToggle" onchange="switchAccount()">
                        <span class="account-toggle-slider"></span>
                    </label>
                    <span class="account-label account-label-real">REAL</span>
                </div>
            </h1>
            <div class="flex items-center space-x-2">
                <button id="soundToggle" onclick="toggleSound()" 
                    class="px-4 py-2 bg-blue-600 text-white font-bold rounded-lg shadow hover:bg-blue-700 transition">
                    üîä Sound ON
                </button>
            </div>
        </div>
        
        <!-- DIGIT QUEUE CONTROL PANEL -->
        <div class="mb-6 p-4 bg-gray-900 rounded-xl border border-blue-500/50 shadow-lg">
            <h2 class="text-lg font-bold text-blue-400 mb-3 pb-2 border-b border-gray-700 flex items-center">
                üî¢ DIGIT QUEUE SYSTEM
                <button onclick="toggleQueuePanel()" class="ml-auto text-xs bg-gray-700 hover:bg-gray-600 px-2 py-1 rounded">
                    <span id="queueToggleIcon">‚àí</span>
                </button>
            </h2>
            
            <div id="queuePanelContent" class="transition-all duration-300">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <!-- Left Column: Queue Input & Controls -->
                    <div class="space-y-4">
                        <div>
                            <label class="block text-xs font-semibold text-gray-300 mb-2">Add Digits to Queue</label>
                            <div class="flex items-center gap-2">
                                <input type="text" id="digitInput" placeholder="0,2,5,7" 
                                    class="flex-1 rounded-md bg-gray-700 border border-gray-600 text-white shadow-sm focus:border-blue-500 focus:ring-blue-500 py-2 px-3 text-sm">
                                <button onclick="addDigitsToQueue()" 
                                    class="px-4 py-2 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 transition">
                                    Add
                                </button>
                                <button onclick="clearDigitQueue()" 
                                    class="px-4 py-2 bg-red-600 text-white font-bold rounded-lg hover:bg-red-700 transition">
                                    Clear
                                </button>
                            </div>
                            <p class="text-xs text-gray-400 mt-1">Enter digits separated by commas (0-9)</p>
                        </div>
                        
                        <div class="queue-status-box">
                            <div class="flex justify-between items-center mb-2">
                                <div class="text-xs font-semibold text-blue-300">Queue Status</div>
                                <div class="text-xs">
                                    <span id="queueCount">0</span> digits in queue
                                </div>
                            </div>
                            <div class="flex flex-wrap gap-1" id="digitQueueDisplay">
                                <!-- Digits will be displayed here -->
                                <div class="text-xs text-gray-500 italic">No digits in queue</div>
                            </div>
                        </div>
                        
                        <div>
                            <div class="text-xs font-semibold text-gray-300 mb-2">Current Queue Position</div>
                            <div class="flex items-center justify-between">
                                <div>
                                    <div class="text-xs text-gray-400">Current Digit:</div>
                                    <div id="currentQueueDigit" class="text-xl font-bold text-green-400">-</div>
                                </div>
                                <div>
                                    <div class="text-xs text-gray-400">Position:</div>
                                    <div id="queuePosition" class="text-lg font-bold text-blue-400">-/-</div>
                                </div>
                                <div>
                                    <div class="text-xs text-gray-400">Mode:</div>
                                    <div id="queueModeDisplay" class="text-sm font-bold text-purple-400">-</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Right Column: Execution Settings -->
                    <div class="space-y-4">
                        <div>
                            <label class="block text-xs font-semibold text-gray-300 mb-3">Execution Mode</label>
                            <div class="grid grid-cols-2 gap-2">
                                <button id="queueModeSequential" onclick="setQueueMode('sequential')" 
                                    class="px-4 py-3 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 transition flex flex-col items-center justify-center">
                                    <span class="text-lg">üî¢</span>
                                    <span class="text-xs mt-1">SEQUENTIAL</span>
                                </button>
                                <button id="queueModeRandom" onclick="setQueueMode('random')" 
                                    class="px-4 py-3 bg-purple-600 text-white font-bold rounded-lg hover:bg-purple-700 transition flex flex-col items-center justify-center">
                                    <span class="text-lg">üé≤</span>
                                    <span class="text-xs mt-1">RANDOM</span>
                                </button>
                            </div>
                            <p id="queueModeDescription" class="text-xs text-gray-400 mt-2">
                                Sequential: Execute digits in order
                            </p>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-2">
                            <button onclick="skipToNextDigit()" 
                                class="px-3 py-2 bg-yellow-600 text-white font-bold rounded-lg hover:bg-yellow-700 transition text-sm">
                                ‚è≠Ô∏è Skip Digit
                            </button>
                            <button onclick="resetQueuePosition()" 
                                class="px-3 py-2 bg-gray-600 text-white font-bold rounded-lg hover:bg-gray-700 transition text-sm">
                                üîÑ Reset Position
                            </button>
                        </div>
                        
                        <div class="queue-status-box">
                            <div class="text-xs font-semibold text-gray-300 mb-2">Queue Settings</div>
                            <div class="space-y-1">
                                <div class="flex items-center justify-between">
                                    <span class="text-xs text-gray-400">Cycle on win:</span>
                                    <input type="checkbox" id="queueCycleOnWin" checked 
                                        class="rounded bg-gray-700 border-gray-600 text-green-600 focus:ring-green-500">
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="text-xs text-gray-400">Restart at end:</span>
                                    <input type="checkbox" id="queueRestartAtEnd" checked 
                                        class="rounded bg-gray-700 border-gray-600 text-green-600 focus:ring-green-500">
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="text-xs text-gray-400">Max cycles:</span>
                                    <input type="number" id="queueMaxCycles" value="1" min="1" max="10" 
                                        class="ml-2 w-16 rounded-md bg-gray-700 border border-gray-600 text-white text-center py-0.5 px-1 text-xs">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Quick Digit Presets -->
                <div class="mt-4 pt-4 border-t border-gray-700">
                    <div class="text-xs font-semibold text-gray-300 mb-2">Quick Presets</div>
                    <div class="flex flex-wrap gap-2">
                        <button onclick="loadDigitPreset('even')" class="px-3 py-1.5 bg-gray-700 hover:bg-gray-600 text-white text-xs rounded">
                            Even (0,2,4,6,8)
                        </button>
                        <button onclick="loadDigitPreset('odd')" class="px-3 py-1.5 bg-gray-700 hover:bg-gray-600 text-white text-xs rounded">
                            Odd (1,3,5,7,9)
                        </button>
                        <button onclick="loadDigitPreset('low')" class="px-3 py-1.5 bg-gray-700 hover:bg-gray-600 text-white text-xs rounded">
                            Low (0-4)
                        </button>
                        <button onclick="loadDigitPreset('high')" class="px-3 py-1.5 bg-gray-700 hover:bg-gray-600 text-white text-xs rounded">
                            High (5-9)
                        </button>
                        <button onclick="loadDigitPreset('random5')" class="px-3 py-1.5 bg-purple-700 hover:bg-purple-600 text-white text-xs rounded">
                            Random 5
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
            <!-- LEFT COLUMN: SMART ANALYSIS ENGINE -->
            <div class="lg:col-span-1">
                <div class="bg-gray-900 border border-gray-700 rounded-xl p-4 shadow-lg analysis-settings-container">
                    <h2 class="text-lg font-bold text-cyan-400 mb-4 pb-2 border-b border-gray-700">
                        üß† SMART DIGIT ANALYSIS
                    </h2>
                    
                    <!-- Connection Status -->
                    <div class="mb-4 p-3 bg-gray-800 rounded-lg border border-gray-600">
                        <h3 class="text-sm font-bold text-gray-300 mb-2">Market Status</h3>
                        <div class="grid grid-cols-2 gap-2 text-xs">
                            <div>
                                <span class="text-gray-400">Connection:</span>
                                <span id="market_status" class="ml-2 font-bold text-red-400">Offline</span>
                            </div>
                            <div>
                                <span class="text-gray-400">Symbol:</span>
                                <span id="current_symbol" class="ml-2 font-bold text-cyan-400">V. 10 Index</span>
                            </div>
                            <div>
                                <span class="text-gray-400">Ticks Received:</span>
                                <span id="ticks_received" class="ml-2 font-bold text-green-400">0</span>
                            </div>
                            <div>
                                <span class="text-gray-400">Tick Rate:</span>
                                <span id="current_tick_rate" class="ml-2 font-bold text-blue-400">0/s</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Smart Predictor Settings -->
                    <div class="mb-4 p-3 bg-gray-800 rounded-lg border border-cyan-500/30">
                        <h3 class="text-sm font-bold text-cyan-300 mb-3">Analysis Settings</h3>
                        
                        <div class="mb-3">
                            <label class="block text-xs font-semibold text-gray-300 mb-1">Analysis Window</label>
                            <div class="flex items-center gap-2">
                                <input type="number" id="tick_window_input" value="50" min="10" max="200" 
                                    class="flex-1 rounded-md bg-gray-700 border border-gray-600 text-white shadow-sm focus:border-cyan-500 focus:ring-cyan-500 py-1.5 px-2 text-sm">
                                <button id="apply_tick_window" 
                                    class="px-3 py-1.5 bg-cyan-600 text-white font-bold rounded-md hover:bg-cyan-700 transition text-sm">
                                    Apply
                                </button>
                            </div>
                            <p class="text-xs text-gray-400 mt-1">Analyze last N ticks for digit patterns</p>
                        </div>
                        
                        <div id="tick_progress" class="mb-4 p-3 bg-gray-900 rounded text-center border border-gray-700">
                            <div class="text-cyan-400 font-bold mb-1">‚è≥ Waiting for Connection</div>
                            <div class="text-2xl font-bold mb-1">
                                <span id="tick_counter">0</span> / <span id="window_size">50</span>
                            </div>
                            <div class="w-full bg-gray-700 rounded-full h-3 mb-2">
                                <div id="tick_progress_bar" class="bg-cyan-600 h-3 rounded-full" style="width: 0%"></div>
                            </div>
                            <div class="text-xs text-gray-400">
                                <span id="analysis_status">Start bot to begin</span>
                            </div>
                        </div>
                        
                        <div id="prediction_box" class="p-3 bg-gray-800 rounded border border-cyan-500/50 text-sm">
                            <div class="text-cyan-300 font-bold mb-1">Top 5 Digits Analysis:</div>
                            <div class="text-gray-300" id="prediction_text">Connect to market first</div>
                            <div id="top5_digits_display" class="mt-2 hidden">
                                <div class="text-xs font-semibold text-green-400 mb-1">Recommended Queue:</div>
                                <div class="flex flex-wrap gap-1" id="top5_digits"></div>
                            </div>
                        </div>
                        
                        <!-- Session Status Display -->
                        <div id="session_display" class="mt-4 p-3 bg-gray-800 rounded border border-blue-500/30 hidden">
                            <h3 class="text-sm font-bold text-blue-300 mb-2">Active Session</h3>
                            <div class="flex items-center justify-between">
                                <div>
                                    <div class="text-xs text-gray-300">Digit:</div>
                                    <div id="session_digit" class="text-xl font-bold text-green-400">-</div>
                                </div>
                                <div>
                                    <div class="text-xs text-gray-300">Mode:</div>
                                    <div id="session_mode" class="text-sm font-bold text-blue-400">-</div>
                                </div>
                                <div>
                                    <div class="text-xs text-gray-300">Trades:</div>
                                    <div id="session_trades" class="text-sm font-bold text-yellow-400">0/10</div>
                                </div>
                            </div>
                            <button id="new_analysis_btn" onclick="startNewAnalysis()" 
                                class="mt-2 w-full px-3 py-1.5 bg-purple-600 text-white font-bold rounded-md hover:bg-purple-700 transition text-sm">
                                üîÑ Run New Analysis
                            </button>
                        </div>
                    </div>
                    
                    <!-- Queue Integration Settings -->
                    <div class="mt-4 p-3 bg-gray-800 rounded-lg border border-purple-500/30">
                        <h3 class="text-sm font-bold text-purple-300 mb-3">Queue Integration</h3>
                        
                        <div class="mb-3">
                            <label class="block text-xs font-semibold text-gray-300 mb-1">
                                Auto-populate queue with top 5 digits
                            </label>
                            <div class="flex items-center gap-2">
                                <input type="checkbox" id="autoPopulateQueue" checked 
                                    class="rounded bg-gray-700 border-gray-600 text-purple-600 focus:ring-purple-500">
                                <label for="autoPopulateQueue" class="text-xs text-gray-300">Enable auto-queue from analysis</label>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="block text-xs font-semibold text-gray-300 mb-1">
                                Rotate to next digit on loss:
                            </label>
                            <div class="flex items-center gap-2">
                                <input type="checkbox" id="rotateOnLoss" checked 
                                    class="rounded bg-gray-700 border-gray-600 text-purple-600 focus:ring-purple-500">
                                <label for="rotateOnLoss" class="text-xs text-gray-300">Auto-rotate queue after each loss</label>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="block text-xs font-semibold text-gray-300 mb-1">
                                Stop bot on win:
                            </label>
                            <div class="flex items-center gap-2">
                                <input type="checkbox" id="stopOnWin" checked 
                                    class="rounded bg-gray-700 border-gray-600 text-purple-600 focus:ring-purple-500">
                                <label for="stopOnWin" class="text-xs text-gray-300">Stop trading after a win</label>
                            </div>
                        </div>
                        
                        <div class="text-xs text-gray-400 mt-2 pt-2 border-t border-gray-700">
                            <div class="flex justify-between">
                                <span>Queue Strategy:</span>
                                <span id="queueStrategyStatus" class="font-bold text-purple-300">ACTIVE</span>
                            </div>
                            <div class="flex justify-between mt-1">
                                <span>Losses this cycle:</span>
                                <span id="lossesThisCycle" class="font-bold text-gray-300">0</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- MIDDLE COLUMN: MAIN CONTROLS -->
            <div class="lg:col-span-2">
                <!-- MARTINGALE CALCULATOR -->
                <div class="mb-6 p-4 bg-gray-900 rounded-xl border border-purple-500/50 shadow-lg">
                    <h2 class="text-lg font-bold text-purple-400 mb-3 pb-2 border-b border-gray-700 flex items-center">
                        üßÆ MARTINGALE CALCULATOR
                        <button onclick="toggleCalculator()" class="ml-auto text-xs bg-gray-700 hover:bg-gray-600 px-2 py-1 rounded">
                            <span id="calcToggleIcon">‚àí</span>
                        </button>
                    </h2>
                    
                    <div id="calculatorContent" class="transition-all duration-300">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <!-- Left Column: Inputs -->
                            <div class="space-y-3">
                                <div>
                                    <label class="block text-xs font-semibold text-gray-300 mb-1">Base Stake ($)</label>
                                    <input type="number" id="calc_base_stake" value="1.0" min="0.1" step="0.1" 
                                        class="w-full rounded-md bg-gray-700 border border-gray-600 text-white shadow-sm focus:border-purple-500 focus:ring-purple-500 py-1.5 px-2 text-sm calculator-highlight">
                                </div>
                                
                                <div>
                                    <label class="block text-xs font-semibold text-gray-300 mb-1">Multiplier</label>
                                    <input type="number" id="calc_multiplier" value="1.15" min="1.0" step="0.01" 
                                        class="w-full rounded-md bg-gray-700 border border-gray-600 text-white shadow-sm focus:border-purple-500 focus:ring-purple-500 py-1.5 px-2 text-sm">
                                </div>
                                
                                <div>
                                    <label class="block text-xs font-semibold text-gray-300 mb-1">Max Trades</label>
                                    <input type="number" id="calc_max_trades" value="10" min="1" max="100" 
                                        class="w-full rounded-md bg-gray-700 border border-gray-600 text-white shadow-sm focus:border-purple-500 focus:ring-purple-500 py-1.5 px-2 text-sm">
                                </div>
                                
                                <div>
                                    <label class="block text-xs font-semibold text-gray-300 mb-1">Bankroll Limit ($)</label>
                                    <input type="number" id="calc_bankroll_limit" value="50.0" min="1.0" step="0.1" 
                                        class="w-full rounded-md bg-gray-700 border border-gray-600 text-white shadow-sm focus:border-purple-500 focus:ring-purple-500 py-1.5 px-2 text-sm">
                                </div>
                                
                                <button onclick="calculateMartingale()" 
                                    class="w-full mt-2 px-4 py-2 bg-purple-600 text-white font-bold rounded-lg hover:bg-purple-700 transition">
                                    üßÆ CALCULATE
                                </button>
                            </div>
                            
                            <!-- Right Column: Results -->
                            <div class="space-y-3">
                                <div class="p-3 bg-gray-800 rounded-lg border border-green-500/50">
                                    <div class="text-xs font-semibold text-green-400 mb-1">Total Required</div>
                                    <div id="calc_total_required" class="text-xl font-bold text-white">$0.00</div>
                                    <div class="text-xs text-gray-400 mt-1">For all trades</div>
                                </div>
                                
                                <div class="p-3 bg-gray-800 rounded-lg border border-blue-500/50">
                                    <div class="text-xs font-semibold text-blue-400 mb-1">Final Stake</div>
                                    <div id="calc_final_stake" class="text-lg font-bold text-white">$0.00</div>
                                    <div class="text-xs text-gray-400 mt-1">Last trade amount</div>
                                </div>
                                
                                <div class="p-3 bg-gray-800 rounded-lg border border-yellow-500/50">
                                    <div class="text-xs font-semibold text-yellow-400 mb-1">Bankroll Status</div>
                                    <div id="calc_bankroll_status" class="text-lg font-bold text-white">-</div>
                                    <div class="text-xs text-gray-400 mt-1">vs. your limit</div>
                                </div>
                                
                                <div class="p-3 bg-gray-800 rounded-lg border border-cyan-500/50">
                                    <div class="text-xs font-semibold text-cyan-400 mb-1">Profit on Win</div>
                                    <div id="calc_profit_on_win" class="text-lg font-bold text-white">$0.00</div>
                                    <div class="text-xs text-gray-400 mt-1">9x payout minus investment</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Stake Progression Table -->
                        <div class="mt-4">
                            <div class="text-xs font-semibold text-gray-300 mb-2">Stake Progression</div>
                            <div id="calc_progression" class="text-xs text-gray-400 italic">Click CALCULATE to see stake progression</div>
                        </div>
                    </div>
                </div>
                
                <!-- Main Trading Controls -->
                <div class="grid grid-cols-2 lg:grid-cols-3 gap-3 mb-6">
                    <!-- Symbol -->
                    <div>
                        <label for="symbol" class="block text-xs font-semibold text-gray-300 mb-1">Symbol</label>
                        <select id="symbol" class="block w-full rounded-md bg-gray-700 border border-gray-600 text-white shadow-sm focus:border-green-500 focus:ring-green-500 py-1.5 px-2 text-sm">
                            <option value="R_10">V. 10 Index</option>
                            <option value="R_100">V. 100 Index</option>
                            <option value="R_25">V. 25 Index</option>
                            <option value="R_50">V. 50 Index</option>
                            <option value="R_75">V. 75 Index</option>
                        </select>
                    </div>
                    
                    <!-- Predicted Digit (now shows current from queue) -->
                    <div>
                        <label for="predictedDigit" class="block text-xs font-semibold text-gray-300 mb-1">
                            Current Digit <span class="text-blue-400">(from queue)</span>
                        </label>
                        <input type="number" id="predictedDigit" value="5" min="0" max="9" 
                            class="block w-full rounded-md bg-gray-700 border border-gray-600 text-white shadow-sm focus:border-green-500 focus:ring-green-500 py-1.5 px-2 text-sm text-center">
                    </div>

                    <!-- Contract Type -->
                    <div>
                        <label for="contractType" class="block text-xs font-semibold text-gray-300 mb-1">Contract Type</label>
                        <select id="contractType" class="block w-full rounded-md bg-gray-700 border border-gray-600 text-white shadow-sm focus:border-green-500 focus:ring-green-500 py-1.5 px-2 text-sm">
                            <option value="DIGITMATCH">DIGITMATCH</option>
                        </select>
                    </div>

                    <!-- Base Stake -->
                    <div>
                        <label for="baseStake" class="block text-xs font-semibold text-gray-300 mb-1">Base Stake</label>
                        <input type="number" id="baseStake" value="1.0" min="0.1" step="0.1" 
                            class="block w-full rounded-md bg-gray-700 border border-gray-600 text-white shadow-sm focus:border-green-500 focus:ring-green-500 py-1.5 px-2 text-sm">
                    </div>

                    <!-- Multiplier -->
                    <div>
                        <label for="multiplier" class="block text-xs font-semibold text-gray-300 mb-1">Multiplier</label>
                        <input type="number" id="multiplier" value="1.15" min="1.0" step="0.01" 
                            class="block w-full rounded-md bg-gray-700 border border-gray-600 text-white shadow-sm focus:border-green-500 focus:ring-green-500 py-1.5 px-2 text-sm">
                    </div>

                    <!-- Max Trades -->
                    <div>
                        <label for="maxTrades" class="block text-xs font-semibold text-gray-300 mb-1">Max Trades</label>
                        <input type="number" id="maxTrades" value="10" min="1" max="100" 
                            class="block w-full rounded-md bg-gray-700 border border-gray-600 text-white shadow-sm focus:border-green-500 focus:ring-green-500 py-1.5 px-2 text-sm">
                    </div>
                    
                    <!-- Mode Toggle -->
                    <div class="col-span-2 lg:col-span-3">
                        <label class="block text-xs font-semibold text-gray-300 mb-1">Execution Mode</label>
                        <div class="grid grid-cols-2 gap-2">
                            <button id="mode_instant" onclick="switchMode('instant')" 
                                class="px-4 py-2 bg-green-600 text-white font-bold rounded-lg hover:bg-green-700 transition">
                                ‚ö° INSTANT
                            </button>
                            <button id="mode_smart" onclick="switchMode('smart')" 
                                class="px-4 py-2 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 transition">
                                üß† SMART
                            </button>
                        </div>
                        <p id="mode_description" class="text-xs text-gray-400 mt-1">
                            ‚ö° INSTANT: Trade on each tick
                        </p>
                    </div>
                </div>
                
                <!-- METRICS -->
                <div class="grid grid-cols-3 gap-3">
                    <div class="bg-gray-700 rounded-lg p-2 shadow-inner border border-green-500/50 col-span-2">
                        <p class="text-[10px] font-semibold text-green-500 uppercase">Current Tick</p>
                        <p id="metricLiveTick" class="text-xl font-extrabold text-white">---</p>
                        <p id="metricLastDigit" class="text-lg font-bold text-green-300">Digit: ?</p>
                        <p id="metricTickRate" class="text-xs font-bold text-blue-400">Ticks/sec: --</p>
                    </div>
                    
                    <div class="bg-gray-700 rounded-lg p-2 shadow-inner border border-green-500/50">
                        <p class="text-[10px] font-semibold text-green-500 uppercase">Balance</p>
                        <p id="metricAccountBalance" class="text-lg font-bold balance-green">$---</p>
                    </div>
                    
                    <div class="bg-gray-700 rounded-lg p-2 shadow-inner">
                        <p class="text-[10px] font-semibold text-green-500 uppercase">Trade #</p>
                        <p id="metricTradeCount" class="text-lg font-bold text-white">0</p>
                    </div>
                    
                    <div class="bg-gray-700 rounded-lg p-2 shadow-inner">
                        <p class="text-[10px] font-semibold text-lime-400 uppercase">P/L</p>
                        <p id="metricTotalProfit" class="text-lg font-bold profit-neutral">$0.00</p>
                    </div>
                    
                    <div class="bg-gray-700 rounded-lg p-2 shadow-inner">
                        <p class="text-[10px] font-semibold text-green-500 uppercase">Stake</p>
                        <p id="metricCurrentStake" class="text-lg font-bold text-white">$0.00</p>
                    </div>
                    
                    <!-- Queue Status Section -->
                    <div class="bg-gray-700 rounded-lg p-2 shadow-inner border border-blue-500/50 col-span-3">
                        <div class="flex justify-between items-center mb-1">
                            <p class="text-[10px] font-semibold text-blue-500 uppercase">QUEUE STATUS</p>
                            <div class="text-xs">
                                <span id="metricQueuePosition" class="font-bold text-blue-300">-</span>
                                <span class="text-gray-400"> | Cycle </span>
                                <span id="metricQueueCycle" class="font-bold text-purple-300">1</span>
                            </div>
                        </div>
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-[10px] font-semibold text-gray-400 uppercase">Current:</p>
                                <p id="metricCurrentQueueDigit" class="text-lg font-bold text-green-400">-</p>
                            </div>
                            <div>
                                <p class="text-[10px] font-semibold text-gray-400 uppercase">Next:</p>
                                <p id="metricNextQueueDigit" class="text-lg font-bold text-yellow-400">-</p>
                            </div>
                            <div>
                                <p class="text-[10px] font-semibold text-gray-400 uppercase">Mode:</p>
                                <p id="metricQueueMode" class="text-sm font-bold text-purple-400">-</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- TRADE STATUS SECTION -->
                    <div id="trade-result-container" class="bg-gray-900 rounded-lg p-3 shadow-inner border border-yellow-500/50 col-span-3">
                        <div class="flex justify-between items-center mb-2">
                            <p class="text-[10px] font-semibold text-yellow-500 uppercase">TRADE STATUS</p>
                            <p id="metricTradeResult" class="text-xs font-bold text-gray-400">READY</p>
                        </div>
                        <div class="mb-2">
                            <p class="text-[10px] font-semibold text-gray-400 uppercase mb-1">Status:</p>
                            <p id="metricPreviousResult" class="text-sm font-bold text-gray-300">Waiting for connection...</p>
                        </div>
                        <div>
                            <p class="text-[10px] font-semibold text-gray-400 uppercase mb-1">Action:</p>
                            <p id="metricNextAction" class="text-sm font-bold text-yellow-400">Start bot to begin</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- START/STOP BUTTON -->
        <div class="flex justify-center mb-5">
            <button id="toggleButton" onclick="toggleBot()" 
                class="w-full md:w-1/2 px-6 py-3 bg-green-600 text-white font-bold text-lg rounded-lg shadow-xl hover:bg-green-700 transition duration-150">
                üöÄ START BOT
            </button>
        </div>

        <!-- LOG AREA -->
        <div id="log-column" class="w-full flex flex-col">
            <h2 class="text-lg font-bold text-gray-300 mb-2 border-b border-gray-700 pb-1">Live Log</h2>
            <div id="log-area" class="flex-grow h-80 bg-gray-900 text-lime-400 p-2.5 rounded-lg overflow-y-scroll text-xs whitespace-pre-wrap shadow-inner">
[00:00:00] ü§ñ Deriv Bot Initialized
[00:00:00] üìä Ready to connect to live market
[00:00:00] üî¢ Digit Queue System Ready
[00:00:00] üß† Smart analysis engine ready
[00:00:00] üîÑ Queue strategy enabled
            </div>
        </div>
    </div>

    <script>
        // ============================================================================
        // CORE BOT STATE
        // ============================================================================
        
        // Global State
        window.ws = null;
        window.req_id = 0;
        window.isBotRunning = false;
        window.isConnecting = false;
        window.soundEnabled = true;
        window.ToneInitialized = false;
        window.synth = null;
        
        // Trading State
        window.baseStake = 1.0;
        window.currentStake = 1.0;
        window.multiplier = 1.15;
        window.maxTrades = 10;
        window.tradeCount = 0;
        window.martingaleStep = 0;
        window.accountBalance = 0.0;
        window.startingBalance = 0.0;
        window.currentBalance = 0.0;
        window.netProfit = 0.0;
        
        // PnL Tracking
        window.pnlTracker = {
            totalInvestment: 0.0,
            totalPayout: 0.0,
            netProfit: 0.0,
            trades: []
        };
        
        // Execution State
        window.lastTick = null;
        window.nextTradeAllowed = true;
        window.stopAfterWin = false;
        window.pendingProposals = new Map();
        window.executionLock = false;
        
        // Statistics
        window.stats = {
            totalTicks: 0,
            tradesExecuted: 0,
            wins: 0,
            losses: 0
        };
        
        // Rate tracking
        window.botTickTimestamps = [];
        
        // Tick Queue
        window.tickQueue = [];
        window.maxQueueSize = 30;
        
        // Analysis Engine
        let analysisDigits = [];
        let analysisWindowSize = 50;
        let analysisComplete = false;
        let totalTicksReceived = 0;
        let lastTickTime = 0;
        let tickTimestamps = [];
        
        // Session State
        let sessionState = {
            active: false,
            mode: 'instant',
            sessionDigit: null,
            sessionStarted: false,
            manualOverride: false
        };
        
        // Queue State - FULLY INTEGRATED
        window.digitQueue = {
            digits: [],            // Array of digits to cycle through
            position: 0,           // Current position in queue
            mode: 'sequential',    // 'sequential' or 'random'
            active: false,         // Whether queue is active
            currentDigit: null,    // Current digit being used
            cyclesCompleted: 0,    // Number of cycles completed
            maxCycles: 1,          // Maximum cycles before stopping
            cycleOnWin: true,      // Move to next digit on win
            restartAtEnd: true,    // Restart from beginning when queue ends
            queueExpanded: true,   // UI state
            shuffledDigits: [],    // For random mode
            shufflePosition: 0,    // For random mode
            lossesThisCycle: 0,    // Track losses in current cycle
            isAutoPopulated: false // Whether queue was auto-populated from analysis
        };
        
        // Queue Settings
        window.queueSettings = {
            autoPopulate: true,
            rotateOnLoss: true,
            stopOnWin: true
        };
        
        // ============================================================================
        // DOM ELEMENTS
        // ============================================================================
        
        const toggleButton = document.getElementById('toggleButton');
        const soundToggleButton = document.getElementById('soundToggle');
        const sessionDisplay = document.getElementById('session_display');
        const tradeResultContainer = document.getElementById('trade-result-container');
        const metricPreviousResult = document.getElementById('metricPreviousResult');
        const metricNextAction = document.getElementById('metricNextAction');
        const metricTradeResult = document.getElementById('metricTradeResult');
        const metricTotalProfit = document.getElementById('metricTotalProfit');
        
        // ============================================================================
        // CORE INTEGRATED FUNCTIONS
        // ============================================================================
        
        // 1. SMART ANALYSIS THAT PROVIDES TOP 5 DIGITS
        function performSmartAnalysis() {
            if (analysisDigits.length < analysisWindowSize) return;
            
            // Calculate frequency of each digit (0-9)
            const digitFrequency = Array(10).fill(0);
            analysisDigits.forEach(digit => {
                if (digit >= 0 && digit <= 9) {
                    digitFrequency[digit]++;
                }
            });
            
            // Create array of digits with their frequencies
            const digitStats = [];
            for (let i = 0; i < 10; i++) {
                digitStats.push({
                    digit: i,
                    frequency: digitFrequency[i],
                    percentage: (digitFrequency[i] / analysisWindowSize * 100).toFixed(1)
                });
            }
            
            // Sort by frequency (highest first)
            digitStats.sort((a, b) => b.frequency - a.frequency);
            
            // Get top 5 most frequent digits
            const top5Digits = digitStats.slice(0, 5).map(item => item.digit);
            
            // Update prediction display
            updatePredictionDisplay(digitStats, top5Digits);
            
            // Auto-populate queue if enabled
            if (window.queueSettings.autoPopulate) {
                autoPopulateQueueFromAnalysis(top5Digits);
            }
            
            analysisComplete = true;
            log(`üß† Analysis Complete: Top 5 digits identified`, 'ANALYSIS');
        }
        
        function updatePredictionDisplay(digitStats, top5Digits) {
            const box = document.getElementById('prediction_box');
            const top5Display = document.getElementById('top5_digits_display');
            const top5DigitsElem = document.getElementById('top5_digits');
            
            // Create HTML for top 5 display
            let html = '<div class="text-cyan-300 font-bold mb-1">Top 5 Most Likely Digits:</div>';
            html += '<div class="text-xs text-gray-300 mb-2">Based on ' + analysisWindowSize + ' recent ticks</div>';
            
            // Show top 5 digits
            html += '<div class="flex flex-wrap gap-1 mb-2">';
            top5Digits.forEach((digit, index) => {
                const stat = digitStats.find(d => d.digit === digit);
                html += `
                    <div class="digit-queue-item bg-blue-600 text-white" title="Frequency: ${stat.frequency} (${stat.percentage}%)">
                        ${digit}
                    </div>
                `;
            });
            html += '</div>';
            
            // Show statistics
            html += '<div class="text-xs text-gray-400">';
            digitStats.slice(0, 3).forEach(stat => {
                html += `<div>Digit ${stat.digit}: ${stat.frequency} times (${stat.percentage}%)</div>`;
            });
            html += '</div>';
            
            box.innerHTML = html;
            box.classList.add('analysis-complete');
            
            // Update queue recommendation
            top5DigitsElem.innerHTML = '';
            top5Digits.forEach(digit => {
                top5DigitsElem.innerHTML += `<div class="digit-queue-item bg-green-600 text-white">${digit}</div>`;
            });
            top5Display.classList.remove('hidden');
        }
        
        // 2. AUTO-POPULATE QUEUE FROM ANALYSIS
        function autoPopulateQueueFromAnalysis(top5Digits) {
            if (top5Digits.length === 0) return;
            
            // Clear existing queue if it was auto-populated
            if (window.digitQueue.isAutoPopulated) {
                window.digitQueue.digits = [];
            }
            
            // Add top 5 digits to queue
            window.digitQueue.digits = [...top5Digits];
            window.digitQueue.position = 0;
            window.digitQueue.active = true;
            window.digitQueue.isAutoPopulated = true;
            window.digitQueue.lossesThisCycle = 0;
            
            // Set current digit
            const initialDigit = window.digitQueue.digits[0];
            window.digitQueue.currentDigit = initialDigit;
            document.getElementById('predictedDigit').value = initialDigit;
            
            // Update UI
            updateDigitQueueDisplay();
            updateQueueStatus();
            
            log(`‚úÖ Queue auto-populated with top 5 digits: ${top5Digits.join(', ')}`, 'QUEUE');
        }
        
        // 3. INTEGRATED TRADE HANDLER WITH QUEUE ROTATION
        function handleTradeResult(isWin) {
            if (isWin) {
                // WIN HANDLING
                window.stats.wins++;
                window.consecutiveLosses = 0;
                window.digitQueue.lossesThisCycle = 0;
                
                // Track payout
                const payout = window.currentStake * 9;
                trackTradePayout(payout);
                
                log(`üéØ WIN! Payout: $${payout.toFixed(2)}`, 'WIN');
                updateTradeStatus(
                    'WIN üéØ',
                    `Digit matched! Payout: $${payout.toFixed(2)}`,
                    window.queueSettings.stopOnWin ? 'Bot stopping...' : 'Preparing next trade',
                    'win'
                );
                
                // Reset stake
                window.currentStake = window.baseStake;
                window.martingaleStep = 0;
                
                // Handle queue rotation on win
                if (window.digitQueue.cycleOnWin && window.digitQueue.digits.length > 1) {
                    rotateToNextDigit();
                }
                
                // Stop bot on win if enabled
                if (window.queueSettings.stopOnWin) {
                    window.stopAfterWin = true;
                    setTimeout(() => {
                        if (window.isBotRunning) {
                            stopBot();
                        }
                    }, 3000); // 3-second PnL update before stopping
                }
                
            } else {
                // LOSS HANDLING
                window.stats.losses++;
                window.consecutiveLosses++;
                window.digitQueue.lossesThisCycle++;
                
                log(`‚ùå LOSS! Loss streak: ${window.consecutiveLosses}`, 'LOSS');
                updateTradeStatus(
                    'LOSS ‚ùå',
                    `Loss streak: ${window.consecutiveLosses}`,
                    'Increasing stake and rotating digit',
                    'loss'
                );
                
                // Increase stake (martingale)
                window.currentStake = window.currentStake * window.multiplier;
                window.martingaleStep++;
                
                // Handle queue rotation on loss
                if (window.queueSettings.rotateOnLoss && window.digitQueue.digits.length > 1) {
                    rotateToNextDigit();
                }
                
                // Check max trades
                if (window.martingaleStep >= window.maxTrades) {
                    log(`üõë Max trades reached (${window.maxTrades})`, 'CRITICAL');
                    updateTradeStatus('MAX TRADES', `Maximum trades reached`, 'Bot stopping', 'loss');
                    stopBot();
                }
            }
            
            // Update metrics
            updateMetricsUI();
            updatePnL();
        }
        
        // 4. ROTATE TO NEXT DIGIT IN QUEUE
        function rotateToNextDigit() {
            if (window.digitQueue.digits.length === 0) {
                log("‚ö†Ô∏è Queue is empty. Cannot rotate.", "QUEUE");
                return;
            }
            
            const oldDigit = window.digitQueue.currentDigit;
            
            if (window.digitQueue.mode === 'random') {
                // Random mode: get random digit (not repeating until all used)
                if (window.digitQueue.shuffledDigits.length === 0) {
                    window.digitQueue.shuffledDigits = [...window.digitQueue.digits];
                    shuffleArray(window.digitQueue.shuffledDigits);
                    window.digitQueue.shufflePosition = 0;
                }
                
                window.digitQueue.currentDigit = window.digitQueue.shuffledDigits[window.digitQueue.shufflePosition];
                window.digitQueue.shufflePosition++;
                
                if (window.digitQueue.shufflePosition >= window.digitQueue.shuffledDigits.length) {
                    window.digitQueue.shuffledDigits = [];
                    window.digitQueue.cyclesCompleted++;
                }
                
            } else {
                // Sequential mode
                window.digitQueue.position = (window.digitQueue.position + 1) % window.digitQueue.digits.length;
                window.digitQueue.currentDigit = window.digitQueue.digits[window.digitQueue.position];
                
                // Check if cycle completed
                if (window.digitQueue.position === 0) {
                    window.digitQueue.cyclesCompleted++;
                    log(`üîÑ Queue cycle ${window.digitQueue.cyclesCompleted} completed`, 'QUEUE');
                    
                    if (window.digitQueue.cyclesCompleted >= window.digitQueue.maxCycles) {
                        log(`‚èπÔ∏è Max cycles reached (${window.digitQueue.maxCycles})`, 'QUEUE');
                        stopBot();
                        return;
                    }
                }
            }
            
            // Update UI
            document.getElementById('predictedDigit').value = window.digitQueue.currentDigit;
            updateDigitQueueDisplay();
            updateQueueStatus();
            
            log(`‚è≠Ô∏è Digit rotated: ${oldDigit} ‚Üí ${window.digitQueue.currentDigit}`, 'QUEUE');
        }
        
        // 5. PnL UPDATE SYSTEM
        function updatePnL() {
            const pnlElem = document.getElementById('metricTotalProfit');
            
            // Calculate net profit
            window.netProfit = window.pnlTracker.totalPayout - window.pnlTracker.totalInvestment;
            const formattedProfit = window.netProfit.toFixed(2);
            const isPositive = window.netProfit > 0;
            const isNegative = window.netProfit < 0;
            
            pnlElem.textContent = `${isPositive ? '+' : ''}$${formattedProfit}`;
            pnlElem.classList.remove('profit-positive', 'profit-negative', 'profit-neutral');
            
            if (isPositive) {
                pnlElem.classList.add('profit-positive');
            } else if (isNegative) {
                pnlElem.classList.add('profit-negative');
            } else {
                pnlElem.classList.add('profit-neutral');
            }
            
            // Update balance if available
            if (window.currentBalance > 0) {
                const balanceProfit = window.currentBalance - window.startingBalance;
                if (window.startingBalance > 0) {
                    document.getElementById('metricAccountBalance').textContent = `$${window.currentBalance.toFixed(2)}`;
                    document.getElementById('metricAccountBalance').className = 
                        balanceProfit >= 0 ? 'text-lg font-bold balance-green' : 'text-lg font-bold text-red-400';
                }
            }
            
            return window.netProfit;
        }
        
        function trackTradeInvestment(amount) {
            window.pnlTracker.totalInvestment += parseFloat(amount);
            window.pnlTracker.trades.push({
                type: 'investment',
                amount: parseFloat(amount),
                timestamp: Date.now()
            });
            updatePnL();
            log(`üí∞ Investment: $${amount.toFixed(2)}`, 'PNL');
        }
        
        function trackTradePayout(amount) {
            window.pnlTracker.totalPayout += parseFloat(amount);
            window.pnlTracker.trades.push({
                type: 'payout',
                amount: parseFloat(amount),
                timestamp: Date.now()
            });
            updatePnL();
            log(`üí∞ Payout: $${amount.toFixed(2)}`, 'PNL');
        }
        
        // ============================================================================
        // QUEUE SYSTEM FUNCTIONS
        // ============================================================================
        
        function toggleQueuePanel() {
            const queueContent = document.getElementById('queuePanelContent');
            const toggleIcon = document.getElementById('queueToggleIcon');
            
            if (window.digitQueue.queueExpanded) {
                queueContent.classList.add('hidden');
                toggleIcon.textContent = '+';
                window.digitQueue.queueExpanded = false;
            } else {
                queueContent.classList.remove('hidden');
                toggleIcon.textContent = '‚àí';
                window.digitQueue.queueExpanded = true;
            }
        }
        
        function addDigitsToQueue() {
            const input = document.getElementById('digitInput');
            const value = input.value.trim();
            
            if (!value) {
                log('‚ùå Please enter digits', 'ERROR');
                return;
            }
            
            const digitStrings = value.split(/[,\s]+/);
            const newDigits = [];
            
            digitStrings.forEach(str => {
                const num = parseInt(str.trim());
                if (!isNaN(num) && num >= 0 && num <= 9) {
                    newDigits.push(num);
                }
            });
            
            if (newDigits.length === 0) {
                log('‚ùå No valid digits (0-9) found', 'ERROR');
                return;
            }
            
            // Add to queue
            window.digitQueue.digits = [...window.digitQueue.digits, ...newDigits];
            window.digitQueue.active = true;
            window.digitQueue.isAutoPopulated = false;
            
            // Update UI
            updateDigitQueueDisplay();
            updateQueueStatus();
            
            log(`‚úÖ Added ${newDigits.length} digits to queue`, 'QUEUE');
            input.value = '';
            
            // Set first digit if none set
            if (window.digitQueue.currentDigit === null && window.digitQueue.digits.length > 0) {
                window.digitQueue.currentDigit = window.digitQueue.digits[0];
                document.getElementById('predictedDigit').value = window.digitQueue.currentDigit;
            }
        }
        
        function clearDigitQueue() {
            if (window.digitQueue.digits.length === 0) return;
            
            const confirmClear = confirm('Clear all digits from queue?');
            if (!confirmClear) return;
            
            window.digitQueue.digits = [];
            window.digitQueue.position = 0;
            window.digitQueue.currentDigit = null;
            window.digitQueue.cyclesCompleted = 0;
            window.digitQueue.active = false;
            window.digitQueue.shuffledDigits = [];
            window.digitQueue.shufflePosition = 0;
            window.digitQueue.isAutoPopulated = false;
            
            updateDigitQueueDisplay();
            updateQueueStatus();
            
            log('üîÑ Digit queue cleared', 'QUEUE');
        }
        
        function setQueueMode(mode) {
            window.digitQueue.mode = mode;
            
            // Update UI buttons
            document.getElementById('queueModeSequential').classList.remove('queue-mode-active');
            document.getElementById('queueModeRandom').classList.remove('queue-mode-active');
            
            if (mode === 'sequential') {
                document.getElementById('queueModeSequential').classList.add('queue-mode-active');
                document.getElementById('queueModeDescription').textContent = 
                    'Sequential: Execute digits in order from first to last';
            } else {
                document.getElementById('queueModeRandom').classList.add('queue-mode-active');
                document.getElementById('queueModeDescription').textContent = 
                    'Random: Execute digits in random order (shuffled each cycle)';
            }
            
            document.getElementById('queueModeDisplay').textContent = mode.toUpperCase();
            document.getElementById('metricQueueMode').textContent = mode.toUpperCase();
            
            log(`üîÑ Queue mode set to: ${mode}`, 'QUEUE');
        }
        
        function updateDigitQueueDisplay() {
            const displayElem = document.getElementById('digitQueueDisplay');
            const countElem = document.getElementById('queueCount');
            
            countElem.textContent = window.digitQueue.digits.length;
            
            if (window.digitQueue.digits.length === 0) {
                displayElem.innerHTML = '<div class="text-xs text-gray-500 italic">No digits in queue</div>';
                return;
            }
            
            let html = '';
            const currentDigit = window.digitQueue.currentDigit;
            
            window.digitQueue.digits.forEach((digit, index) => {
                let className = 'digit-queue-item';
                let bgColor = 'bg-gray-700';
                
                // Check if this is the current active digit
                if (digit === currentDigit) {
                    className += ' digit-queue-active';
                    bgColor = 'bg-green-600';
                } else if (window.digitQueue.mode === 'sequential' && index === window.digitQueue.position) {
                    // Show next digit for sequential mode
                    className += ' digit-queue-next';
                    bgColor = 'bg-yellow-600';
                }
                
                html += `<div class="${className} ${bgColor} text-white" title="Digit ${digit}">${digit}</div>`;
            });
            
            displayElem.innerHTML = html;
        }
        
        function updateQueueStatus() {
            const currentDigitElem = document.getElementById('currentQueueDigit');
            const positionElem = document.getElementById('queuePosition');
            const modeElem = document.getElementById('queueModeDisplay');
            
            const queuePositionElem = document.getElementById('metricQueuePosition');
            const queueCycleElem = document.getElementById('metricQueueCycle');
            const currentQueueDigitElem = document.getElementById('metricCurrentQueueDigit');
            const nextQueueDigitElem = document.getElementById('metricNextQueueDigit');
            const queueModeElem = document.getElementById('metricQueueMode');
            
            if (window.digitQueue.digits.length > 0 && window.digitQueue.currentDigit !== null) {
                currentDigitElem.textContent = window.digitQueue.currentDigit;
                positionElem.textContent = `${window.digitQueue.position + 1}/${window.digitQueue.digits.length}`;
                modeElem.textContent = window.digitQueue.mode.toUpperCase();
                
                queuePositionElem.textContent = `${window.digitQueue.position + 1}/${window.digitQueue.digits.length}`;
                queueCycleElem.textContent = window.digitQueue.cyclesCompleted + 1;
                currentQueueDigitElem.textContent = window.digitQueue.currentDigit;
                
                // Show next digit for sequential mode
                if (window.digitQueue.mode === 'sequential' && window.digitQueue.digits.length > 1) {
                    const nextIndex = (window.digitQueue.position + 1) % window.digitQueue.digits.length;
                    nextQueueDigitElem.textContent = window.digitQueue.digits[nextIndex];
                } else {
                    nextQueueDigitElem.textContent = '?';
                }
                
                queueModeElem.textContent = window.digitQueue.mode.toUpperCase();
            } else {
                currentDigitElem.textContent = '-';
                positionElem.textContent = '-/-';
                modeElem.textContent = '-';
                
                queuePositionElem.textContent = '-';
                queueCycleElem.textContent = '1';
                currentQueueDigitElem.textContent = '-';
                nextQueueDigitElem.textContent = '-';
                queueModeElem.textContent = '-';
            }
            
            // Update losses this cycle
            document.getElementById('lossesThisCycle').textContent = window.digitQueue.lossesThisCycle;
        }
        
        function skipToNextDigit() {
            if (window.digitQueue.digits.length === 0) {
                log('‚ùå No digits in queue', 'ERROR');
                return;
            }
            
            rotateToNextDigit();
            log(`‚è≠Ô∏è Manually skipped to next digit`, 'QUEUE');
        }
        
        function resetQueuePosition() {
            window.digitQueue.position = 0;
            window.digitQueue.cyclesCompleted = 0;
            window.digitQueue.shuffledDigits = [];
            window.digitQueue.shufflePosition = 0;
            window.digitQueue.lossesThisCycle = 0;
            
            if (window.digitQueue.digits.length > 0) {
                window.digitQueue.currentDigit = window.digitQueue.digits[0];
                document.getElementById('predictedDigit').value = window.digitQueue.currentDigit;
                updateDigitQueueDisplay();
                updateQueueStatus();
            }
            
            log('üîÑ Queue position reset to start', 'QUEUE');
        }
        
        function loadDigitPreset(preset) {
            let digits = [];
            
            switch(preset) {
                case 'even':
                    digits = [0, 2, 4, 6, 8];
                    break;
                case 'odd':
                    digits = [1, 3, 5, 7, 9];
                    break;
                case 'low':
                    digits = [0, 1, 2, 3, 4];
                    break;
                case 'high':
                    digits = [5, 6, 7, 8, 9];
                    break;
                case 'random5':
                    const allDigits = [0,1,2,3,4,5,6,7,8,9];
                    shuffleArray(allDigits);
                    digits = allDigits.slice(0, 5);
                    break;
            }
            
            // Add to queue
            window.digitQueue.digits = [...window.digitQueue.digits, ...digits];
            window.digitQueue.active = true;
            window.digitQueue.isAutoPopulated = false;
            
            updateDigitQueueDisplay();
            
            // Set first digit if queue was empty
            if (window.digitQueue.position === 0 && window.digitQueue.digits.length > 0) {
                window.digitQueue.currentDigit = window.digitQueue.digits[0];
                document.getElementById('predictedDigit').value = window.digitQueue.currentDigit;
            }
            
            log(`‚úÖ Loaded ${preset} preset`, 'QUEUE');
            updateQueueStatus();
        }
        
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }
        
        // ============================================================================
        // CORE BOT FUNCTIONS
        // ============================================================================
        
        function updateTradeStatus(status, result, action, type = 'normal') {
            tradeResultContainer.classList.remove('win-glow');
            metricPreviousResult.textContent = result;
            metricNextAction.textContent = action;
            
            switch(type) {
                case 'win':
                    metricTradeResult.textContent = 'WIN üéØ';
                    metricTradeResult.className = 'text-xs font-bold status-win';
                    metricPreviousResult.className = 'text-sm font-bold status-win';
                    metricNextAction.className = 'text-sm font-bold text-green-400';
                    tradeResultContainer.classList.add('win-glow');
                    break;
                case 'loss':
                    metricTradeResult.textContent = 'LOSS ‚ùå';
                    metricTradeResult.className = 'text-xs font-bold status-loss';
                    metricPreviousResult.className = 'text-sm font-bold status-loss';
                    metricNextAction.className = 'text-sm font-bold text-red-400';
                    break;
                case 'trade':
                    metricTradeResult.textContent = 'TRADING ‚ö°';
                    metricTradeResult.className = 'text-xs font-bold status-trade';
                    metricPreviousResult.className = 'text-sm font-bold status-trade';
                    metricNextAction.className = 'text-sm font-bold text-yellow-400';
                    break;
                default:
                    metricTradeResult.textContent = status || 'READY';
                    metricTradeResult.className = 'text-xs font-bold text-gray-400';
                    metricPreviousResult.className = 'text-sm font-bold text-gray-300';
                    metricNextAction.className = 'text-sm font-bold text-yellow-400';
                    break;
            }
        }
        
        function processTickForAnalysis(tick) {
            try {
                const price = parseFloat(tick.quote);
                const symbol = document.getElementById('symbol').value;
                let decimalPlaces = 3;
                if (symbol === 'R_100') decimalPlaces = 2;
                const formattedPrice = price.toFixed(decimalPlaces);
                const digit = parseInt(formattedPrice.charAt(formattedPrice.length - 1), 10);
                
                if (isNaN(digit) || digit < 0 || digit > 9) return;
                
                totalTicksReceived++;
                lastTickTime = Date.now();
                tickTimestamps.push(lastTickTime);
                
                // Clean old timestamps
                const tenSecondsAgo = Date.now() - 10000;
                tickTimestamps = tickTimestamps.filter(ts => ts > tenSecondsAgo);
                
                // Add to analysis
                analysisDigits.push(digit);
                if (analysisDigits.length > analysisWindowSize) {
                    analysisDigits.shift();
                }
                
                // Update UI
                updateAnalysisUI();
                
                // Perform analysis when we have enough data
                if (!analysisComplete && analysisDigits.length >= analysisWindowSize) {
                    performSmartAnalysis();
                }
                
            } catch (error) {
                console.error('Tick processing error:', error);
            }
        }
        
        function updateAnalysisUI() {
            document.getElementById('tick_counter').textContent = analysisDigits.length;
            const progressPercent = Math.min(100, (analysisDigits.length / analysisWindowSize) * 100);
            document.getElementById('tick_progress_bar').style.width = `${progressPercent}%`;
            
            const statusElem = document.getElementById('analysis_status');
            if (analysisDigits.length < analysisWindowSize) {
                statusElem.textContent = `Collecting: ${analysisDigits.length}/${analysisWindowSize}`;
                statusElem.className = 'text-xs text-cyan-400';
            } else {
                statusElem.textContent = '‚úÖ Analysis complete';
                statusElem.className = 'text-xs text-green-400';
            }
        }
        
        function handleTick(tick) {
            if (!window.isBotRunning) return;
            
            processTickForAnalysis(tick);
            
            const price = parseFloat(tick.quote);
            const symbol = document.getElementById('symbol').value;
            let decimalPlaces = 3;
            if (symbol === 'R_100') decimalPlaces = 2;
            const formattedPrice = price.toFixed(decimalPlaces);
            const digit = formattedPrice.charAt(formattedPrice.length - 1);
            
            const tickData = { 
                digit: digit, 
                price: price, 
                time: Date.now() 
            };
            
            window.lastTick = tickData;
            
            // Update metrics
            document.getElementById('metricLiveTick').textContent = price.toFixed(3);
            document.getElementById('metricLastDigit').textContent = `Digit: ${digit}`;
            document.getElementById('metricLiveTick').classList.add('tick-flash');
            setTimeout(() => document.getElementById('metricLiveTick').classList.remove('tick-flash'), 50);
            
            window.stats.totalTicks++;
            window.botTickTimestamps.push(Date.now());
            
            // Add to processing queue
            window.tickQueue.push(tickData);
            if (window.tickQueue.length > window.maxQueueSize) {
                window.tickQueue.shift();
            }
            
            // Check for immediate win
            checkForImmediateWin(tickData);
            
            playAudioFeedback('TICK');
        }
        
        function checkForImmediateWin(tick) {
            if (!window.isBotRunning || window.stopAfterWin) return false;
            
            const predictedDigit = getPredictedDigit();
            const tickDigit = parseInt(tick.digit);
            
            if (tickDigit === predictedDigit) {
                log(`üéØ IMMEDIATE WIN! Digit ${tickDigit} matches ${predictedDigit}`, 'WIN');
                handleTradeResult(true);
                return true;
            }
            
            return false;
        }
        
        function getPredictedDigit() {
            // Priority: Queue digit > Manual input
            if (window.digitQueue.active && window.digitQueue.currentDigit !== null) {
                return window.digitQueue.currentDigit;
            }
            
            return parseInt(document.getElementById('predictedDigit').value) || 5;
        }
        
        function startBot() {
            if (window.isBotRunning) {
                stopBot();
                return;
            }
            
            const token = localStorage.getItem('active_token') || localStorage.getItem('derivToken');
            if (!token) {
                log('‚ùå No API token found. Please authenticate first.', 'CRITICAL');
                updateTradeStatus('ERROR', 'No API token found', 'Please authenticate first', 'loss');
                return;
            }
            
            resetAllState();
            
            window.isBotRunning = true;
            updateButtonState();
            
            log('üöÄ Starting bot...', 'SYSTEM');
            log(`üìä Mode: ${sessionState.mode}`, 'SYSTEM');
            log(`üîÑ Queue System: ${window.queueSettings.autoPopulate ? 'Auto-populate ON' : 'Manual'}`, 'SYSTEM');
            
            updateTradeStatus('STARTING', 'Initializing bot...', 'Connecting to market', 'normal');
            initTone();
            connectWebSocket();
            
            // Disable controls
            document.querySelectorAll('#symbol, #predictedDigit, #contractType, #baseStake, #multiplier, #maxTrades').forEach(control => {
                control.disabled = true;
                control.classList.add('opacity-50', 'cursor-not-allowed');
            });
        }
        
        function stopBot() {
            if (!window.isBotRunning) return;
            
            window.isBotRunning = false;
            updateButtonState();
            
            log('‚èπÔ∏è Bot stopped', 'SYSTEM');
            
            if (window.ws) {
                window.ws.close();
                window.ws = null;
            }
            
            window.pendingProposals.clear();
            window.executionLock = false;
            window.stopAfterWin = false;
            
            // Enable controls
            document.querySelectorAll('#symbol, #predictedDigit, #contractType, #baseStake, #multiplier, #maxTrades').forEach(control => {
                control.disabled = false;
                control.classList.remove('opacity-50', 'cursor-not-allowed');
            });
            
            // Final PnL update
            const finalPnL = updatePnL();
            updateTradeStatus(
                'STOPPED',
                `Final PnL: ${finalPnL >= 0 ? '+' : ''}$${finalPnL.toFixed(2)}`,
                'Ready for new session',
                finalPnL > 0 ? 'win' : 'normal'
            );
        }
        
        function toggleBot() {
            if (window.isBotRunning) {
                stopBot();
            } else {
                startBot();
            }
        }
        
        function resetAllState() {
            // Reset trading state
            window.baseStake = parseFloat(document.getElementById('baseStake').value) || 1.0;
            window.currentStake = window.baseStake;
            window.multiplier = parseFloat(document.getElementById('multiplier').value) || 1.15;
            window.maxTrades = parseInt(document.getElementById('maxTrades').value) || 10;
            window.tradeCount = 0;
            window.martingaleStep = 0;
            window.consecutiveLosses = 0;
            
            // Reset PnL
            window.pnlTracker = { totalInvestment: 0.0, totalPayout: 0.0, netProfit: 0.0, trades: [] };
            window.startingBalance = 0.0;
            window.currentBalance = 0.0;
            window.netProfit = 0.0;
            
            // Reset stats
            window.stats = { totalTicks: 0, tradesExecuted: 0, wins: 0, losses: 0 };
            window.tickQueue = [];
            window.lastTick = null;
            window.pendingProposals.clear();
            window.botTickTimestamps = [];
            
            // Reset analysis
            analysisDigits = [];
            analysisComplete = false;
            totalTicksReceived = 0;
            tickTimestamps = [];
            
            // Reset queue if not manually populated
            if (window.digitQueue.isAutoPopulated) {
                window.digitQueue.digits = [];
                window.digitQueue.currentDigit = null;
                window.digitQueue.active = false;
            }
            window.digitQueue.lossesThisCycle = 0;
            
            // Update UI
            updatePnL();
            updateDigitQueueDisplay();
            updateQueueStatus();
            document.getElementById('metricTradeCount').textContent = '0';
            document.getElementById('metricCurrentStake').textContent = `$${window.currentStake.toFixed(2)}`;
            document.getElementById('metricAccountBalance').textContent = '$---';
            document.getElementById('metricAccountBalance').className = 'text-lg font-bold balance-green';
            
            log('üîÑ Bot state reset', 'SYSTEM');
        }
        
        // ============================================================================
        // WEBSOCKET AND TRADING FUNCTIONS
        // ============================================================================
        
        function connectWebSocket() {
            if (window.ws) {
                try {
                    window.ws.close();
                } catch (e) {}
            }
            
            window.isConnecting = true;
            updateConnectionStatus();
            
            const wsUrl = 'wss://ws.binaryws.com/websockets/v3?app_id=118332';
            log('üîó Connecting to Deriv API...', 'SYSTEM');
            
            window.ws = new WebSocket(wsUrl);
            
            window.ws.onopen = () => {
                window.isConnecting = false;
                log('‚úÖ WebSocket connected', 'SYSTEM');
                updateConnectionStatus();
                
                const token = localStorage.getItem('active_token') || localStorage.getItem('derivToken');
                if (!token) {
                    log('‚ùå No API token found in storage', 'ERROR');
                    stopBot();
                    return;
                }
                
                sendRequest({ 
                    authorize: token, 
                    req_id: getNextReqId() 
                });
            };
            
            window.ws.onmessage = (msg) => {
                try {
                    const data = JSON.parse(msg.data);
                    handleAPIResponse(data);
                } catch (e) {
                    console.error('WebSocket message error:', e);
                }
            };
            
            window.ws.onclose = () => {
                window.isConnecting = false;
                updateConnectionStatus();
                log('üîå WebSocket disconnected', 'SYSTEM');
                
                if (window.isBotRunning) {
                    setTimeout(() => {
                        if (window.isBotRunning) {
                            connectWebSocket();
                        }
                    }, 2000);
                }
            };
            
            window.ws.onerror = (error) => {
                console.error('WebSocket error:', error);
                log('‚ùå WebSocket connection error', 'ERROR');
            };
        }
        
        function handleAPIResponse(data) {
            if (data.error) {
                log(`API Error: ${data.error.message}`, 'ERROR');
                if (data.error.code === 'InvalidToken') {
                    log('‚ùå Invalid API Token. Please check your authentication.', 'CRITICAL');
                    stopBot();
                }
                return;
            }
        
            if (data.msg_type === 'authorize') {
                if (data.authorize) {
                    log(`üîê Authorized as ${data.authorize.loginid}`, 'SYSTEM');
                    subscribeToTicks(document.getElementById('symbol').value);
                    subscribeToBalance();
                }
            } else if (data.msg_type === 'tick') {
                handleTick(data.tick);
            } else if (data.msg_type === 'proposal') {
                handleProposalResponse(data.proposal, data.req_id);
            } else if (data.msg_type === 'buy') {
                handleBuyResponse(data.buy);
            } else if (data.msg_type === 'balance') {
                handleBalanceUpdate(data.balance);
            }
        }
        
        function sendRequest(request) {
            if (window.ws && window.ws.readyState === WebSocket.OPEN) {
                const message = JSON.stringify(request);
                window.ws.send(message);
                return request.req_id;
            }
            return null;
        }
        
        function getNextReqId() {
            return ++window.req_id;
        }
        
        function subscribeToBalance() {
            sendRequest({ balance: 1, subscribe: 1, req_id: getNextReqId() });
        }
        
        function handleBalanceUpdate(balanceData) {
            const newBalance = parseFloat(balanceData.balance);
            
            if (window.startingBalance === 0) {
                window.startingBalance = newBalance;
                log(`üí∞ Starting Balance: $${window.startingBalance.toFixed(2)}`, 'PNL');
            }
            
            window.currentBalance = newBalance;
            updatePnL();
        }
        
        function subscribeToTicks(symbol) {
            sendRequest({ ticks: symbol, subscribe: 1, req_id: getNextReqId() });
            log(`‚úÖ Subscribed to ${symbol} ticks`, 'SYSTEM');
        }
        
        function processTickImmediately(tick) {
            if (window.stopAfterWin || window.executionLock) return;
            
            if (sessionState.mode === 'smart' && !analysisComplete && !sessionState.sessionDigit) {
                return;
            }
            
            if (window.tradeCount >= window.maxTrades) {
                log(`üõë Max trades reached (${window.maxTrades})`, 'CRITICAL');
                updateTradeStatus('MAX TRADES', `Maximum trades reached`, 'Bot stopped', 'loss');
                stopBot();
                return;
            }
            
            window.executionLock = true;
            
            try {
                window.tradeCount++;
                document.getElementById('metricTradeCount').textContent = window.tradeCount;
                
                log(`‚ö° Trade #${window.tradeCount}: $${window.currentStake.toFixed(2)} on digit ${getPredictedDigit()}`, 'TRADE');
                updateTradeStatus(
                    'TRADING',
                    `Trade #${window.tradeCount}: $${window.currentStake.toFixed(2)} on digit ${getPredictedDigit()}`,
                    'Executing trade...',
                    'trade'
                );
                
                playAudioFeedback('EXECUTION');
                executeTrade(tick);
                
            } catch (error) {
                log(`‚ùå Error: ${error}`, 'ERROR');
                window.executionLock = false;
            }
        }
        
        function executeTrade(tick) {
            const contractType = document.getElementById('contractType').value;
            const symbol = document.getElementById('symbol').value;
            const predictedDigit = getPredictedDigit();
            
            // Track investment
            trackTradeInvestment(window.currentStake);
            
            const proposalRequest = {
                proposal: 1,
                amount: window.currentStake.toFixed(2),
                basis: "stake",
                contract_type: contractType,
                currency: "USD",
                duration: 1,
                duration_unit: "t",
                symbol: symbol,
                barrier: predictedDigit.toString(),
                req_id: getNextReqId()
            };
            
            window.pendingProposals.set(proposalRequest.req_id, {
                tick: tick,
                stake: window.currentStake,
                predictedDigit: predictedDigit,
                tradeNumber: window.tradeCount
            });
            
            sendRequest(proposalRequest);
        }
        
        function handleProposalResponse(proposal, req_id) {
            if (!proposal || !proposal.id) {
                log(`‚ùå Proposal failed`, 'ERROR');
                updateTradeStatus('ERROR', 'Proposal failed', 'Retrying...', 'loss');
                window.executionLock = false;
                return;
            }
        
            const pending = window.pendingProposals.get(req_id);
            if (!pending) {
                window.executionLock = false;
                return;
            }
        
            window.pendingProposals.delete(req_id);
            executeBuy(proposal.id, proposal.ask_price, pending);
        }
        
        function executeBuy(proposal_id, ask_price, pending) {
            const buyRequest = {
                buy: proposal_id,
                price: ask_price,
                req_id: getNextReqId()
            };
            
            log(`‚úÖ Buying: $${pending.stake.toFixed(2)} on digit ${pending.predictedDigit}`, 'TRADE');
            
            window.pendingProposals.set(buyRequest.req_id, {
                ...pending,
                proposal_id: proposal_id
            });
            
            sendRequest(buyRequest);
        }
        
        function handleBuyResponse(buyData) {
            window.executionLock = false;
            
            if (buyData.contract_id) {
                log(`‚úÖ Trade executed successfully`, 'TRADE');
                
                // Check if win or loss
                const wasWin = buyData.longcode && buyData.longcode.includes("win");
                handleTradeResult(wasWin);
                
            } else {
                log(`‚ùå Trade failed`, 'ERROR');
                updateTradeStatus('ERROR', 'Trade execution failed', 'Retrying...', 'loss');
            }
        }
        
        // ============================================================================
        // UTILITY FUNCTIONS
        // ============================================================================
        
        function updateConnectionStatus() {
            const isConnected = window.ws && window.ws.readyState === WebSocket.OPEN;
            const isConnecting = window.isConnecting;
            
            if (isConnected) {
                document.getElementById('status-badge').textContent = 'üü¢ CONNECTED';
                document.getElementById('status-badge').className = 'ml-3 inline-flex items-center px-3 py-1 text-sm font-medium rounded-full connection-badge-connected text-white shadow-md';
                document.getElementById('market_status').textContent = 'Live';
                document.getElementById('market_status').className = 'ml-2 font-bold text-green-400';
            } else if (isConnecting) {
                document.getElementById('status-badge').textContent = 'üü° CONNECTING';
                document.getElementById('status-badge').className = 'ml-3 inline-flex items-center px-3 py-1 text-sm font-medium rounded-full connection-badge-connecting text-white shadow-md';
                document.getElementById('market_status').textContent = 'Connecting...';
                document.getElementById('market_status').className = 'ml-2 font-bold text-yellow-400';
            } else {
                document.getElementById('status-badge').textContent = 'üî¥ DISCONNECTED';
                document.getElementById('status-badge').className = 'ml-3 inline-flex items-center px-3 py-1 text-sm font-medium rounded-full connection-badge-disconnected text-white shadow-md';
                document.getElementById('market_status').textContent = 'Offline';
                document.getElementById('market_status').className = 'ml-2 font-bold text-red-400';
            }
            
            // Update tick rate
            const now = Date.now();
            const recentTicks = tickTimestamps.filter(ts => now - ts < 5000);
            const tickRate = recentTicks.length / 5;
            document.getElementById('current_tick_rate').textContent = tickRate.toFixed(1) + '/s';
            document.getElementById('ticks_received').textContent = totalTicksReceived;
        }
        
        function updateMetricsUI() {
            document.getElementById('metricCurrentStake').textContent = `$${window.currentStake.toFixed(2)}`;
            document.getElementById('metricTradeCount').textContent = window.tradeCount;
            
            // Calculate tick rate
            const now = Date.now();
            window.botTickTimestamps = window.botTickTimestamps.filter(ts => now - ts < 5000);
            const tickRate = window.botTickTimestamps.length / 5;
            document.getElementById('metricTickRate').textContent = `Ticks/sec: ${tickRate.toFixed(1)}`;
        }
        
        function updateButtonState() {
            if (!toggleButton) return;
            
            if (window.isBotRunning) {
                toggleButton.innerHTML = '<span class="flex items-center justify-center"><span class="mr-2">‚èπÔ∏è</span> STOP BOT</span>';
                toggleButton.classList.remove('bg-green-600', 'hover:bg-green-700', 'start-button-active');
                toggleButton.classList.add('stop-button-active', 'hover:bg-red-700');
            } else {
                toggleButton.innerHTML = '<span class="flex items-center justify-center"><span class="mr-2">üöÄ</span> START BOT</span>';
                toggleButton.classList.remove('stop-button-active', 'hover:bg-red-700');
                toggleButton.classList.add('bg-green-600', 'hover:bg-green-700', 'start-button-active');
            }
        }
        
        function startQueueProcessor() {
            setInterval(() => {
                if (!window.isBotRunning || window.stopAfterWin) return;
                
                while (window.tickQueue.length > 0 && !window.executionLock) {
                    const tick = window.tickQueue.shift();
                    processTickImmediately(tick);
                }
            }, 50);
        }
        
        function log(message, type = 'INFO') {
            const logArea = document.getElementById('log-area');
            const timestamp = new Date().toLocaleTimeString('en-US', { 
                hour12: false, 
                hour: '2-digit', 
                minute: '2-digit', 
                second: '2-digit' 
            });
            
            let color = 'text-lime-400';
            if (type === 'ERROR') color = 'text-red-500 font-bold'; 
            if (type === 'WARNING') color = 'text-yellow-400';
            if (type === 'TRADE') color = 'text-green-300';
            if (type === 'WIN') color = 'text-green-400 font-bold';
            if (type === 'LOSS') color = 'text-red-400 font-bold';
            if (type === 'TICK') color = 'text-cyan-300';
            if (type === 'SYSTEM') color = 'text-white';
            if (type === 'ANALYSIS') color = 'text-cyan-300 font-bold';
            if (type === 'PNL') color = 'text-purple-300 font-bold';
            if (type === 'QUEUE') color = 'text-blue-300 font-bold';
            
            logArea.innerHTML += `\n[${timestamp}] <span class="${color}">${message}</span>`;
            logArea.scrollTop = logArea.scrollHeight;
        }
        
        function toggleSound() {
            window.soundEnabled = !window.soundEnabled;
            updateSoundButton();
            log(`üîä Sound ${window.soundEnabled ? 'ON' : 'OFF'}`, 'SYSTEM');
        }
        
        function updateSoundButton() {
            if (soundToggleButton) {
                soundToggleButton.textContent = window.soundEnabled ? 'üîä Sound ON' : 'üîá Sound OFF';
                soundToggleButton.className = window.soundEnabled ? 
                    'px-4 py-2 bg-blue-600 text-white font-bold rounded-lg shadow hover:bg-blue-700 transition' :
                    'px-4 py-2 bg-gray-600 text-white font-bold rounded-lg shadow hover:bg-gray-700 transition';
            }
        }
        
        async function initTone() {
            if (!window.soundEnabled) return;
            
            if (typeof Tone === 'undefined') {
                console.error("Tone.js not loaded");
                return;
            }
            
            try {
                await Tone.start();
                window.synth = new Tone.Synth().toDestination();
                window.ToneInitialized = true;
            } catch (e) {
                console.error("Audio init error:", e);
            }
        }
        
        function playAudioFeedback(type) {
            if (!window.soundEnabled || !window.ToneInitialized || !window.synth) return;
            
            try {
                if (type === 'WIN') {
                    window.synth.triggerAttackRelease("C5", "8n");
                    setTimeout(() => window.synth.triggerAttackRelease("E5", "8n"), 100);
                    setTimeout(() => window.synth.triggerAttackRelease("G5", "8n"), 200);
                } else if (type === 'TICK') {
                    window.synth.triggerAttackRelease("C4", "32n", Tone.now(), 0.3);
                } else if (type === 'EXECUTION') {
                    window.synth.triggerAttackRelease("E5", "16n", Tone.now(), 0.5);
                }
            } catch (e) {
                console.error("Audio error:", e);
            }
        }
        
        function switchMode(mode) {
            sessionState.mode = mode;
            
            document.getElementById('mode_instant').classList.remove('bg-green-600', 'bg-blue-600');
            document.getElementById('mode_smart').classList.remove('bg-green-600', 'bg-blue-600');
            
            if (mode === 'instant') {
                document.getElementById('mode_instant').classList.add('bg-green-600');
                document.getElementById('mode_smart').classList.add('bg-blue-600');
                document.getElementById('mode_description').textContent = '‚ö° INSTANT: Trade on each tick';
                log('üîÑ Switched to INSTANT mode', 'SYSTEM');
            } else {
                document.getElementById('mode_smart').classList.add('bg-green-600');
                document.getElementById('mode_instant').classList.add('bg-blue-600');
                document.getElementById('mode_description').textContent = 'üß† SMART: Analyze first, then trade';
                log('üîÑ Switched to SMART mode', 'SYSTEM');
            }
        }
        
        function startNewAnalysis() {
            if (!window.isBotRunning) {
                log('‚ùå Bot is not running', 'ERROR');
                return;
            }
            
            analysisDigits = [];
            analysisComplete = false;
            updateAnalysisUI();
            log('üîÑ Starting new analysis...', 'ANALYSIS');
        }
        
        function calculateMartingale() {
            try {
                const baseStake = parseFloat(document.getElementById('calc_base_stake').value) || 1.0;
                const multiplier = parseFloat(document.getElementById('calc_multiplier').value) || 1.15;
                const maxTrades = parseInt(document.getElementById('calc_max_trades').value) || 10;
                const bankrollLimit = parseFloat(document.getElementById('calc_bankroll_limit').value) || 50.0;
                
                let currentStake = baseStake;
                let totalRequired = 0;
                let progression = [];
                
                for (let i = 1; i <= maxTrades; i++) {
                    if (i === 1) {
                        currentStake = baseStake;
                    } else {
                        currentStake *= multiplier;
                    }
                    
                    currentStake = Math.round(currentStake * 100) / 100;
                    totalRequired += currentStake;
                    
                    progression.push({
                        trade: i,
                        stake: currentStake.toFixed(2),
                        cumulative: Math.round(totalRequired * 100) / 100
                    });
                }
                
                totalRequired = Math.round(totalRequired * 100) / 100;
                const profitOnWin = (currentStake * 9) - totalRequired;
                
                // Update UI
                document.getElementById('calc_total_required').textContent = `$${totalRequired.toFixed(2)}`;
                document.getElementById('calc_final_stake').textContent = `$${currentStake.toFixed(2)}`;
                document.getElementById('calc_profit_on_win').textContent = `$${profitOnWin.toFixed(2)}`;
                
                // Bankroll status
                const bankrollStatusElem = document.getElementById('calc_bankroll_status');
                if (totalRequired <= bankrollLimit) {
                    bankrollStatusElem.textContent = '‚úÖ Within Limit';
                    bankrollStatusElem.classList.add('calculator-safe');
                } else if (totalRequired <= bankrollLimit * 1.5) {
                    bankrollStatusElem.textContent = '‚ö†Ô∏è Close to Limit';
                    bankrollStatusElem.classList.add('calculator-warning');
                } else {
                    bankrollStatusElem.textContent = '‚ùå Over Limit';
                    bankrollStatusElem.classList.add('calculator-warning');
                }
                
                // Update progression
                const progressionElem = document.getElementById('calc_progression');
                let progressionHTML = '<div class="grid grid-cols-4 gap-1 text-xs mb-1 font-semibold text-gray-300">';
                progressionHTML += '<div>Trade #</div><div>Stake</div><div>Cumulative</div><div>Status</div>';
                progressionHTML += '</div>';
                
                progression.forEach(item => {
                    const status = item.cumulative <= bankrollLimit ? '‚úÖ' : '‚ùå';
                    progressionHTML += `
                        <div class="grid grid-cols-4 gap-1 text-xs py-1 ${item.trade % 2 === 0 ? 'bg-gray-800/50' : ''}">
                            <div class="text-gray-300">${item.trade}</div>
                            <div class="text-green-400">$${item.stake}</div>
                            <div class="text-blue-400">$${item.cumulative.toFixed(2)}</div>
                            <div class="${status === '‚úÖ' ? 'text-green-400' : 'text-red-400'}">${status}</div>
                        </div>
                    `;
                });
                
                progressionElem.innerHTML = progressionHTML;
                
                log(`üßÆ Calculated martingale progression`, 'CALCULATOR');
                
            } catch (error) {
                console.error('Calculator error:', error);
                alert('Error in calculation. Please check your inputs.');
            }
        }
        
        // ============================================================================
        // INITIALIZATION
        // ============================================================================
        
        document.addEventListener('DOMContentLoaded', () => {
            console.log('ü§ñ Bot initialized');
            
            // Initialize queue system
            setQueueMode('sequential');
            updateDigitQueueDisplay();
            updateQueueStatus();
            
            // Load queue settings from UI
            window.queueSettings.autoPopulate = document.getElementById('autoPopulateQueue').checked;
            window.queueSettings.rotateOnLoss = document.getElementById('rotateOnLoss').checked;
            window.queueSettings.stopOnWin = document.getElementById('stopOnWin').checked;
            
            // Event listeners for queue settings
            document.getElementById('autoPopulateQueue').addEventListener('change', function() {
                window.queueSettings.autoPopulate = this.checked;
                log(`Queue auto-populate: ${this.checked ? 'ON' : 'OFF'}`, 'SETTINGS');
            });
            
            document.getElementById('rotateOnLoss').addEventListener('change', function() {
                window.queueSettings.rotateOnLoss = this.checked;
                log(`Rotate on loss: ${this.checked ? 'ON' : 'OFF'}`, 'SETTINGS');
            });
            
            document.getElementById('stopOnWin').addEventListener('change', function() {
                window.queueSettings.stopOnWin = this.checked;
                log(`Stop on win: ${this.checked ? 'ON' : 'OFF'}`, 'SETTINGS');
            });
            
            // Initialize queue settings
            window.digitQueue.cycleOnWin = document.getElementById('queueCycleOnWin').checked;
            window.digitQueue.restartAtEnd = document.getElementById('queueRestartAtEnd').checked;
            window.digitQueue.maxCycles = parseInt(document.getElementById('queueMaxCycles').value) || 1;
            
            // Analysis window
            document.getElementById('apply_tick_window').addEventListener('click', function() {
                const newSize = parseInt(document.getElementById('tick_window_input').value);
                if (newSize >= 10 && newSize <= 200) {
                    analysisWindowSize = newSize;
                    document.getElementById('window_size').textContent = newSize;
                    analysisDigits = [];
                    analysisComplete = false;
                    updateAnalysisUI();
                    log(`üìä Analysis window set to ${newSize} ticks`, 'ANALYSIS');
                }
            });
            
            // Start queue processor
            startQueueProcessor();
            
            // Calculate initial martingale
            calculateMartingale();
            
            // Show queue badge
            document.getElementById('recheck-badge').classList.remove('hidden');
            document.getElementById('recheck-badge').textContent = 'QUEUE SYSTEM';
            
            log('ü§ñ Bot ready with fully integrated Queue System', 'SYSTEM');
            log('üî¢ Smart Analysis ‚Üí Top 5 Digits ‚Üí Queue Integration ‚Üí Auto-Rotation', 'SYSTEM');
        });
        
        function switchAccount() {
            const isRealRequested = document.getElementById('accTypeToggle').checked;
            const allAccounts = JSON.parse(localStorage.getItem('deriv_accounts')) || [];
            
            const targetAccount = allAccounts.find(acc => 
                isRealRequested ? !acc.account.startsWith('VR') : acc.account.startsWith('VR')
            );
        
            if (targetAccount) {
                localStorage.setItem('active_token', targetAccount.token);
                log(`Switched to ${isRealRequested ? 'REAL' : 'DEMO'} account`, 'SYSTEM');
                
                if (window.isBotRunning) {
                    stopBot();
                    setTimeout(() => startBot(), 1000);
                }
            } else {
                alert(`No ${isRealRequested ? 'Real' : 'Demo'} account found`);
                document.getElementById('accTypeToggle').checked = !isRealRequested;
            }
        }
        
        function checkAuthToken() {
            return localStorage.getItem('active_token') || localStorage.getItem('derivToken');
        }
        
        function initializeToggleState() {
            const token = localStorage.getItem('active_token');
            const allAccounts = JSON.parse(localStorage.getItem('deriv_accounts')) || [];
            
            if (token && allAccounts.length > 0) {
                const currentAccount = allAccounts.find(acc => acc.token === token);
                if (currentAccount) {
                    const isReal = !currentAccount.account.startsWith('VR');
                    document.getElementById('accTypeToggle').checked = isReal;
                }
            }
        }
    </script>
</body>
</html>
