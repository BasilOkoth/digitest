<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>DigitMatchStar Pro‚Ñ¢ - Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <style>
        /* ALL ORIGINAL STYLES PRESERVED */
        #log-area::-webkit-scrollbar { width: 4px; }
        #log-area::-webkit-scrollbar-thumb { background: #4ade80; border-radius: 2px; }
        body { font-family: 'Inter', sans-serif; background-color: #111827; }
        @keyframes pulse-once { 0% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.03); opacity: 0.9; } 100% { transform: scale(1); opacity: 1; } }
        .stop-button-active { background-color: #dc2626 !important; border: 2px solid #fca5a5 !important; animation: pulse-once 0.5s infinite; }
        .profit-green { color: #10B981 !important; font-weight: bold; }
        .profit-red { color: #ef4444 !important; font-weight: bold; }
        
        /* Account Switcher Styling */
        .switch { position: relative; display: inline-block; width: 44px; height: 20px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; inset: 0; background-color: #374151; transition: .4s; border-radius: 34px; border: 1px solid #4ade80; }
        .slider:before { position: absolute; content: ""; height: 14px; width: 14px; left: 3px; bottom: 2px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #10b981; }
        input:checked + .slider:before { transform: translateX(24px); }
    </style>
</head>
<body class="min-h-screen p-4 sm:p-8 flex items-start justify-center">

    <div class="w-full max-w-5xl bg-gray-800 text-gray-100 shadow-2xl rounded-xl p-5 md:p-6">
        
        <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4 border-b border-gray-700 pb-4">
            <div>
                <h1 class="text-2xl font-black text-green-400">DigitMatchStar Pro‚Ñ¢</h1>
                <div class="flex items-center gap-2 mt-1">
                    <span id="status-badge" class="px-2 py-0.5 text-[10px] rounded-full bg-red-600">Disconnected</span>
                    <span id="account-id-display" class="text-xs text-gray-400 font-mono">Not Authenticated</span>
                </div>
            </div>

            <div class="flex items-center gap-4 bg-gray-900/50 p-2 px-4 rounded-xl border border-gray-700">
                <div class="flex items-center gap-2">
                    <span class="text-[10px] font-bold text-gray-400 uppercase">Demo</span>
                    <label class="switch">
                        <input type="checkbox" id="account-toggle" onchange="switchAccount()">
                        <span class="slider"></span>
                    </label>
                    <span class="text-[10px] font-bold text-green-400 uppercase">Real</span>
                </div>
                
                <div class="h-6 w-[1px] bg-gray-700 mx-2"></div>

                <a href="https://track.deriv.com/_0rfpRaHuZeFMjdsyM5hasGNd7ZgqdRLk/1/" target="_blank" class="text-[10px] font-bold text-blue-400 hover:underline">CREATE ACCOUNT</a>
                <button onclick="logout()" class="text-red-400 hover:text-red-300 transition text-[10px] font-bold">LOGOUT</button>
            </div>
        </div>

        <div class="flex flex-col md:flex-row gap-4 mb-6">
            <div id="controls-section" class="md:w-2/3 grid grid-cols-2 lg:grid-cols-3 gap-3">
                <input type="hidden" id="derivToken">

                <div>
                    <label for="symbol" class="block text-xs font-semibold text-gray-300 mb-1">Symbol</label>
                    <select id="symbol" class="block w-full rounded-md bg-gray-700 border border-gray-600 text-white py-1.5 px-2 text-sm">
                        <option value="R_10">V. 10 Index</option>
                        <option value="R_100">V. 100 Index</option>
                        <option value="R_25">V. 25 Index</option>
                        <option value="R_50">V. 50 Index</option>
                        <option value="R_75">V. 75 Index</option>
                    </select>
                </div>
                
                <div>
                    <label for="predictedDigit" class="block text-xs font-semibold text-gray-300 mb-1">Predicted Digit</label>
                    <input type="number" id="predictedDigit" value="5" min="0" max="9" class="block w-full rounded-md bg-gray-700 border-gray-600 text-white py-1.5 px-2 text-sm text-center">
                </div>

                <div>
                    <label class="block text-xs font-semibold text-gray-300 mb-1">Type</label>
                    <div class="bg-purple-900/30 text-purple-400 border border-purple-500/50 rounded-md py-1.5 px-2 text-[10px] font-bold text-center uppercase">DigitMatch</div>
                </div>

                <div>
                    <label for="baseStake" class="block text-xs font-semibold text-gray-300 mb-1">Base Stake</label>
                    <input type="number" id="baseStake" value="1.0" class="block w-full rounded-md bg-gray-700 border-gray-600 text-white py-1.5 px-2 text-sm">
                </div>

                <div>
                    <label for="multiplier" class="block text-xs font-semibold text-gray-300 mb-1">Martingale</label>
                    <input type="number" id="multiplier" value="1.15" step="0.01" class="block w-full rounded-md bg-gray-700 border-gray-600 text-white py-1.5 px-2 text-sm">
                </div>

                <div>
                    <label for="maxTrades" class="block text-xs font-semibold text-gray-300 mb-1">Max Trades</label>
                    <input type="number" id="maxTrades" value="10" class="block w-full rounded-md bg-gray-700 border-gray-600 text-white py-1.5 px-2 text-sm">
                </div>
                
                <div class="col-span-2 lg:col-span-3 bg-gray-900/50 p-3 rounded-lg border border-gray-700">
                    <p class="text-[10px] text-green-400 font-bold uppercase mb-1">‚ö° Instant Execution Mode</p>
                    <p class="text-[10px] text-gray-400">Trade executes on every tick. Stops immediately on match.</p>
                </div>
            </div>

            <div id="metrics-column" class="md:w-1/3">
                <div class="grid grid-cols-2 gap-3">
                    <div class="bg-gray-900 p-3 rounded-lg border border-green-500/30 text-center col-span-2">
                        <p class="text-[10px] text-gray-400 uppercase">Live Tick</p>
                        <p id="metricLiveTick" class="text-2xl font-black text-white">---</p>
                        <p id="metricLastDigit" class="text-xs font-bold text-green-400">Digit: ?</p>
                    </div>
                    <div class="bg-gray-700 p-2 rounded-lg text-center">
                        <p class="text-[9px] text-gray-400 uppercase">Balance</p>
                        <p id="metricAccountBalance" class="text-sm font-bold text-white">$---</p>
                    </div>
                    <div class="bg-gray-700 p-2 rounded-lg text-center">
                        <p class="text-[9px] text-gray-400 uppercase">PnL</p>
                        <p id="metricTotalProfit" class="text-sm font-bold text-gray-300">$0.00</p>
                    </div>
                </div>
                
                <div id="trade-result-container" class="mt-3 bg-gray-900 p-3 rounded-lg border border-yellow-500/50">
                    <div class="flex justify-between items-center">
                        <p class="text-[10px] text-yellow-500 font-bold uppercase">Status</p>
                        <p id="metricTradeResult" class="text-[10px] font-bold text-gray-500">READY</p>
                    </div>
                    <p id="metricPreviousResult" class="text-xs mt-1 text-gray-300 font-medium italic">Waiting...</p>
                </div>
            </div>
        </div>
        
        <button id="toggleButton" onclick="toggleBot()" class="w-full py-4 bg-green-600 text-white font-black text-xl rounded-xl shadow-2xl hover:bg-green-700 transition-all uppercase tracking-widest">
            Start Trading
        </button>

        <div id="log-area" class="mt-6 h-64 bg-gray-900 text-lime-400 p-4 rounded-xl overflow-y-scroll text-[11px] font-mono border border-gray-700">
            [SYSTEM] System Ready. Select account type and press START.
        </div>
    </div>

    <script>
        // --- AUTHENTICATION & ACCOUNT LOGIC (New) ---
        let accounts = JSON.parse(localStorage.getItem('deriv_accounts')) || [];

        function initAuth() {
            if (accounts.length === 0) {
                log('‚ùå No session found. Please login via index.html', 'ERROR');
                setTimeout(() => window.location.href = 'index.html', 2000);
                return;
            }
            switchAccount(); 
        }

        function switchAccount() {
            if (window.isBotRunning) {
                alert("Please stop the bot before switching accounts.");
                document.getElementById('account-toggle').checked = !document.getElementById('account-toggle').checked;
                return;
            }
            const isReal = document.getElementById('account-toggle').checked;
            const selected = accounts.find(acc => isReal ? !acc.is_virtual : acc.is_virtual);
            if (selected) {
                window.DERIV_TOKEN = selected.token;
                document.getElementById('derivToken').value = selected.token;
                document.getElementById('account-id-display').textContent = `ID: ${selected.loginid}`;
                log(`Switched to ${isReal ? 'REAL' : 'DEMO'}: ${selected.loginid}`, 'SYSTEM');
            } else {
                alert(`No ${isReal ? 'Real' : 'Demo'} account available.`);
                document.getElementById('account-toggle').checked = !isReal;
            }
        }

        function logout() { localStorage.clear(); window.location.href = 'index.html'; }
        window.onload = initAuth;

        // --- ENTIRE ORIGINAL TRADING LOGIC PRESERVED ---
        window.ws = null;
        window.isBotRunning = false;
        window.stats = { wins: 0, losses: 0, tradesExecuted: 0 };
        window.netProfit = 0;
        window.startingBalance = 0;
        window.currentBalance = 0;
        window.tradeCount = 0;
        window.currentStake = 1.0;
        window.executionLock = false;
        window.nextTradeAllowed = true;
        window.stopAfterWin = false;
        window.pendingProposals = new Map();
        window.tickQueue = []; // Logic kept but visual removed

        function extractLastDigitBySymbol(price) {
            const symbol = document.getElementById('symbol').value;
            let decimalPlaces = (symbol === 'R_100') ? 2 : 3;
            return price.toFixed(decimalPlaces).charAt(price.toFixed(decimalPlaces).length - 1);
        }

        function handleTick(tick) {
            if (!window.isBotRunning) return;
            const price = parseFloat(tick.quote);
            const digit = extractLastDigitBySymbol(price);
            
            document.getElementById('metricLiveTick').textContent = price.toFixed(3);
            document.getElementById('metricLastDigit').textContent = `Digit: ${digit}`;
            
            // Logic: Instant Check
            if (parseInt(digit) === parseInt(document.getElementById('predictedDigit').value)) {
                log(`üéØ MATCH DETECTED! Digit ${digit}`, 'WIN');
                window.stopAfterWin = true;
                window.stats.wins++;
                updateTradeResultStatus();
                return;
            }
            
            // Auto-trigger trade based on your original queue logic
            if (!window.executionLock && window.nextTradeAllowed && !window.stopAfterWin) {
                if (window.tradeCount < parseInt(document.getElementById('maxTrades').value)) {
                    executeTrade(digit, price);
                } else {
                    stopBot();
                }
            }
        }

        function executeTrade(digit, price) {
            window.executionLock = true;
            window.nextTradeAllowed = false;
            window.tradeCount++;
            document.getElementById('metricTradeCount')?.textContent = window.tradeCount;
            
            const request = {
                proposal: 1,
                amount: window.currentStake.toFixed(2),
                basis: "stake",
                contract_type: "DIGITMATCH",
                currency: "USD",
                duration: 1,
                duration_unit: "t",
                symbol: document.getElementById('symbol').value,
                barrier: document.getElementById('predictedDigit').value,
                req_id: Math.floor(Math.random() * 10000)
            };
            
            log(`‚ö° Trade #${window.tradeCount} sent ($${window.currentStake})`, 'TRADE');
            sendRequest(request);
            
            // Martingale Logic from original
            updateStake('loss'); 
        }

        function updateStake(winOrLoss) {
            const base = parseFloat(document.getElementById('baseStake').value);
            const mult = parseFloat(document.getElementById('multiplier').value);
            if (winOrLoss === 'win') {
                window.currentStake = base;
            } else {
                window.currentStake = parseFloat((window.currentStake * mult).toFixed(2));
            }
        }

        // Supporting WebSocket functions from original bot.html
        function connectWebSocket() {
            window.ws = new WebSocket('wss://ws.binaryws.com/websockets/v3?app_id=1089');
            window.ws.onopen = () => {
                sendRequest({ authorize: document.getElementById('derivToken').value });
            };
            window.ws.onmessage = (msg) => {
                const data = JSON.parse(msg.data);
                if (data.msg_type === 'authorize') {
                    sendRequest({ ticks: document.getElementById('symbol').value, subscribe: 1 });
                    sendRequest({ balance: 1, subscribe: 1 });
                    log('‚úÖ Connected & Authorized', 'SYSTEM');
                }
                if (data.msg_type === 'tick') handleTick(data.tick);
                if (data.msg_type === 'balance') handleBalanceUpdate(data.balance);
                if (data.msg_type === 'buy') { window.executionLock = false; window.nextTradeAllowed = true; }
            };
        }

        function handleBalanceUpdate(balanceData) {
            const bal = parseFloat(balanceData.balance);
            if (window.startingBalance === 0) window.startingBalance = bal;
            window.currentBalance = bal;
            window.netProfit = bal - window.startingBalance;
            
            const balEl = document.getElementById('metricAccountBalance');
            const profEl = document.getElementById('metricTotalProfit');
            balEl.textContent = `$${bal.toFixed(2)}`;
            profEl.textContent = `$${window.netProfit.toFixed(2)}`;
            profEl.className = window.netProfit >= 0 ? 'text-sm font-bold profit-green' : 'text-sm font-bold profit-red';
        }

        function sendRequest(req) { if (window.ws?.readyState === 1) window.ws.send(JSON.stringify(req)); }

        function toggleBot() { window.isBotRunning ? stopBot() : startBot(); }

        function startBot() {
            window.isBotRunning = true;
            window.tradeCount = 0;
            window.stopAfterWin = false;
            window.currentStake = parseFloat(document.getElementById('baseStake').value);
            updateButtonState();
            connectWebSocket();
            log('üöÄ Bot Started', 'SYSTEM');
        }

        function stopBot() {
            window.isBotRunning = false;
            updateButtonState();
            if (window.ws) window.ws.close();
            log('‚èπÔ∏è Bot Stopped', 'SYSTEM');
        }

        function updateButtonState() {
            const btn = document.getElementById('toggleButton');
            if (window.isBotRunning) {
                btn.textContent = 'STOP BOT';
                btn.classList.add('stop-button-active');
            } else {
                btn.textContent = 'START TRADING';
                btn.classList.remove('stop-button-active');
            }
        }

        function updateTradeResultStatus() {
            const res = document.getElementById('metricTradeResult');
            const prev = document.getElementById('metricPreviousResult');
            if (window.stopAfterWin) {
                res.textContent = 'WIN';
                res.className = 'text-[10px] font-bold text-green-400';
                prev.textContent = 'üéØ Target Reached! Stopping...';
                setTimeout(stopBot, 1000);
            }
        }

        function log(msg, type) {
            const area = document.getElementById('log-area');
            const time = new Date().toLocaleTimeString();
            area.innerHTML += `\n[${time}] ${msg}`;
            area.scrollTop = area.scrollHeight;
        }
    </script>
</body>
</html>
