<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Deriv DigitMatchStar - Top 5 Queue Integrated</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <style>
        #log-area::-webkit-scrollbar { width: 4px; }
        #log-area::-webkit-scrollbar-thumb { background: #4ade80; border-radius: 2px; }
        #log-area::-webkit-scrollbar-track { background: #374151; }
        body { font-family: 'Inter', sans-serif; background-color: #111827; }
        .digit-queue-active {
            border: 2px solid #10B981 !important;
            box-shadow: 0 0 10px rgba(16, 185, 129, 0.5);
            background: linear-gradient(135deg, #10b981, #059669) !important;
        }
        .digit-queue-item {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            margin: 2px;
            font-weight: bold;
            transition: all 0.2s;
        }
    </style>
</head>
<body class="min-h-screen p-4 text-gray-100">
    <div class="max-w-4xl mx-auto bg-gray-800 rounded-xl shadow-2xl p-6">
        <h1 class="text-2xl font-bold text-green-400 mb-4 border-b border-gray-700 pb-2">
            ðŸš€ Top 5 Smart Queue Bot
        </h1>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
            <div class="space-y-4 bg-gray-900 p-4 rounded-lg border border-gray-700">
                <h2 class="text-blue-400 font-bold">Trading Settings</h2>
                <div class="grid grid-cols-2 gap-2">
                    <div>
                        <label class="block text-xs text-gray-400">Base Stake</label>
                        <input type="number" id="baseStake" value="1.0" class="w-full bg-gray-700 p-2 rounded">
                    </div>
                    <div>
                        <label class="block text-xs text-gray-400">Multiplier</label>
                        <input type="number" id="multiplier" value="11.0" class="w-full bg-gray-700 p-2 rounded">
                    </div>
                    <div>
                        <label class="block text-xs text-gray-400">Current Digit</label>
                        <input type="number" id="predictedDigit" value="5" class="w-full bg-gray-700 p-2 rounded text-center font-bold text-xl text-green-400" readonly>
                    </div>
                    <div>
                        <label class="block text-xs text-gray-400">Queue Mode</label>
                        <select id="queueMode" class="w-full bg-gray-700 p-2 rounded text-xs">
                            <option value="sequential">SEQUENTIAL</option>
                            <option value="random">RANDOM</option>
                        </select>
                    </div>
                </div>
                <button id="toggleButton" onclick="toggleBot()" class="w-full py-3 bg-green-600 hover:bg-green-700 font-bold rounded-lg transition">
                    START BOT
                </button>
            </div>

            <div class="space-y-4 bg-gray-900 p-4 rounded-lg border border-blue-500/30">
                <h2 class="text-cyan-400 font-bold">Smart Analysis Queue</h2>
                <div id="tick_progress" class="text-center">
                    <div class="text-xs text-gray-400">Analysis Progress</div>
                    <div class="text-xl font-bold"><span id="tick_counter">0</span> / 25</div>
                    <div class="w-full bg-gray-700 h-2 rounded-full mt-1">
                        <div id="tick_progress_bar" class="bg-cyan-500 h-2 rounded-full" style="width: 0%"></div>
                    </div>
                </div>
                <div class="p-2 bg-gray-800 rounded">
                    <div class="text-[10px] text-gray-500 uppercase mb-2">Top 5 Predicted Queue</div>
                    <div id="digitQueueDisplay" class="flex flex-wrap gap-1 justify-center">
                        <span class="text-xs italic text-gray-600">Waiting for analysis...</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-3 gap-2 mb-6 text-center">
            <div class="bg-gray-700 p-2 rounded">
                <div class="text-[10px] text-gray-400">PROFIT</div>
                <div id="metricTotalProfit" class="font-bold">$0.00</div>
            </div>
            <div class="bg-gray-700 p-2 rounded">
                <div class="text-[10px] text-gray-400">LAST TICK</div>
                <div id="metricLiveTick" class="font-bold text-green-400">-</div>
            </div>
            <div class="bg-gray-700 p-2 rounded">
                <div class="text-[10px] text-gray-400">STREAK</div>
                <div id="currentLossStreak" class="font-bold text-red-400">0</div>
            </div>
        </div>

        <div id="log-area" class="h-40 bg-black p-2 rounded font-mono text-[10px] text-green-500 overflow-y-auto"></div>
    </div>

    <script>
        // --- GLOBAL STATE ---
        let isRunning = false;
        let currentStake = 1.0;
        let baseStake = 1.0;
        let multiplier = 11.0;
        let consecutiveLosses = 0;
        let totalProfit = 0;
        let tickWindow = [];
        let analysisSize = 25;
        
        window.digitQueue = {
            digits: [],
            position: 0,
            active: false
        };

        // --- CORE FUNCTIONS ---

        function log(msg) {
            const area = document.getElementById('log-area');
            const time = new Date().toLocaleTimeString();
            area.innerHTML += `<div>[${time}] ${msg}</div>`;
            area.scrollTop = area.scrollHeight;
        }

        function toggleBot() {
            isRunning = !isRunning;
            const btn = document.getElementById('toggleButton');
            if (isRunning) {
                btn.innerText = "STOP BOT";
                btn.className = "w-full py-3 bg-red-600 font-bold rounded-lg";
                baseStake = parseFloat(document.getElementById('baseStake').value);
                multiplier = parseFloat(document.getElementById('multiplier').value);
                currentStake = baseStake;
                log("ðŸš€ Bot Started. Waiting for analysis...");
                startAnalysis();
            } else {
                btn.innerText = "START BOT";
                btn.className = "w-full py-3 bg-green-600 font-bold rounded-lg";
                log("ðŸ›‘ Bot Stopped.");
            }
        }

        // --- ANALYSIS INTEGRATION ---

        function startAnalysis() {
            tickWindow = [];
            updateAnalysisUI(0);
            // In a real environment, this is triggered by incoming WebSocket ticks
            // Simulating tick collection for this code sample:
            let simTicks = 0;
            let interval = setInterval(() => {
                if (!isRunning) { clearInterval(interval); return; }
                const randomTick = Math.floor(Math.random() * 10);
                tickWindow.push(randomTick);
                simTicks++;
                updateAnalysisUI(simTicks);
                document.getElementById('metricLiveTick').innerText = randomTick;

                if (simTicks >= analysisSize) {
                    clearInterval(interval);
                    finalizeTop5Queue();
                }
            }, 300);
        }

        function finalizeTop5Queue() {
            // Count frequencies
            const counts = {};
            tickWindow.forEach(d => counts[d] = (counts[d] || 0) + 1);
            
            // Sort by most frequent and pick top 5
            const sorted = Object.keys(counts).sort((a, b) => counts[b] - counts[a]);
            const top5 = sorted.slice(0, 5).map(Number);
            
            window.digitQueue.digits = top5;
            window.digitQueue.position = 0;
            window.digitQueue.active = true;
            
            log(`ðŸ§  Analysis Complete! Top 5 Queue: ${top5.join(', ')}`);
            updateQueueUI();
            updateTargetDigit();
            
            // Start the trade loop
            executeTrade();
        }

        // --- TRADE & LOSS HANDLING (Integrated) ---

        function executeTrade() {
            if (!isRunning) return;
            
            const target = window.digitQueue.digits[window.digitQueue.position];
            log(`ðŸŽ° Trading Digit: ${target} | Stake: $${currentStake.toFixed(2)}`);
            
            // Simulating Deriv Contract Result
            setTimeout(() => {
                const win = Math.random() < 0.1; // ~10% chance for Match
                processResult(win);
            }, 2000);
        }

        function processResult(isWin) {
            if (isWin) {
                log("ðŸ’° WIN! Resetting stake.");
                totalProfit += (currentStake * 9); // Simplified payout
                currentStake = baseStake;
                consecutiveLosses = 0;
            } else {
                consecutiveLosses++;
                totalProfit -= currentStake;
                currentStake *= multiplier;
                
                // INTEGRATION: Move to next digit in queue on LOSS
                log(`âŒ LOSS (${consecutiveLosses}). Skipping to next digit in Top 5.`);
                rotateQueue(); 
            }
            
            updateMetrics();
            if (isRunning) executeTrade();
        }

        function rotateQueue() {
            const mode = document.getElementById('queueMode').value;
            if (mode === 'random') {
                window.digitQueue.position = Math.floor(Math.random() * 5);
            } else {
                window.digitQueue.position = (window.digitQueue.position + 1) % 5;
            }
            updateTargetDigit();
            updateQueueUI();
        }

        // --- UI UPDATES ---

        function updateTargetDigit() {
            const digit = window.digitQueue.digits[window.digitQueue.position];
            document.getElementById('predictedDigit').value = digit;
        }

        function updateQueueUI() {
            const container = document.getElementById('digitQueueDisplay');
            container.innerHTML = window.digitQueue.digits.map((d, i) => {
                const activeClass = (i === window.digitQueue.position) ? 'digit-queue-active' : 'bg-gray-700';
                return `<div class="digit-queue-item ${activeClass}">${d}</div>`;
            }).join('');
        }

        function updateAnalysisUI(count) {
            document.getElementById('tick_counter').innerText = count;
            document.getElementById('tick_progress_bar').style.width = `${(count / analysisSize) * 100}%`;
        }

        function updateMetrics() {
            document.getElementById('metricTotalProfit').innerText = `$${totalProfit.toFixed(2)}`;
            document.getElementById('currentLossStreak').innerText = consecutiveLosses;
            const profitEl = document.getElementById('metricTotalProfit');
            profitEl.className = totalProfit >= 0 ? "font-bold text-green-400" : "font-bold text-red-400";
        }
    </script>
</body>
</html>
