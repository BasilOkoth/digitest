<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Deriv DigitMatchStar Bot - AI PREDICTION</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <!-- TensorFlow.js for AI/ML -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.20.0/dist/tf.min.js"></script>
    <!-- Chart.js for visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        #log-area::-webkit-scrollbar { width: 4px; }
        #log-area::-webkit-scrollbar-thumb { background: #4ade80; border-radius: 2px; }
        #log-area::-webkit-scrollbar-track { background: #374151; }
        body { font-family: 'Inter', sans-serif; background-color: #111827; }
        @keyframes pulse-once { 0% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.03); opacity: 0.9; } 100% { transform: scale(1); opacity: 1; } }
        .tick-flash { animation: pulse-once 0.1s ease-out; }
        @keyframes win-pulse { 
            0% { 
                box-shadow: 0 0 5px #10B981, 0 0 10px rgba(16, 185, 129, 0.5); 
                border-color: #10B981;
            } 
            50% { 
                box-shadow: 0 0 20px #10B981, 0 0 30px rgba(16, 185, 129, 0.8); 
                border-color: #34d399;
            } 
            100% { 
                box-shadow: 0 0 5px #10B981, 0 0 10px rgba(16, 185, 129, 0.5); 
                border-color: #10B981;
            } 
        }
        .win-glow {
            animation: win-pulse 1s infinite;
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(16, 185, 129, 0.2)) !important;
        }
        .queue-digit { 
            width: 32px; 
            height: 32px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            border-radius: 50%; 
            font-weight: bold; 
            margin: 0 2px;
        }
        .contract-type-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: bold;
            margin-left: 5px;
        }
        .stop-button-active {
            background-color: #dc2626 !important;
            border: 2px solid #fca5a5 !important;
            animation: pulse-once 0.5s infinite;
        }
        .start-button-active {
            background-color: #16a34a !important;
            border: 2px solid #86efac !important;
            animation: pulse-once 0.5s;
        }
        .analysis-active {
            border: 2px solid #00ffea !important;
            box-shadow: 0 0 10px rgba(0, 255, 234, 0.3) !important;
        }
        .analysis-complete {
            border: 2px solid #10b981 !important;
            background-color: #064e3b20 !important;
        }
        .connection-badge-connected {
            background: linear-gradient(90deg, #10b981, #059669) !important;
        }
        .connection-badge-disconnected {
            background: linear-gradient(90deg, #dc2626, #b91c1c) !important;
        }
        .connection-badge-connecting {
            background: linear-gradient(90deg, #f59e0b, #d97706) !important;
        }
        /* Account Toggle */
        .account-toggle-container {
            display: inline-flex;
            align-items: center;
            margin-left: 15px;
            background: rgba(0, 0, 0, 0.3);
            padding: 2px 10px;
            border-radius: 20px;
        }
        .account-toggle {
            position: relative;
            display: inline-block;
            width: 44px;
            height: 22px;
            margin: 0 8px;
        }
        .account-toggle input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .account-toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #1e40af;
            border-radius: 34px;
            transition: .4s;
        }
        .account-toggle-slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            border-radius: 50%;
            transition: .4s;
        }
        input:checked + .account-toggle-slider {
            background-color: #059669;
        }
        input:checked + .account-toggle-slider:before {
            transform: translateX(22px);
        }
        .account-label {
            font-size: 12px;
            font-weight: 600;
        }
        .account-label-demo {
            color: #3b82f6;
        }
        .account-label-real {
            color: #10b981;
        }
        .profit-positive {
            color: #10b981 !important;
            text-shadow: 0 0 5px rgba(16, 185, 129, 0.3);
        }
        .profit-negative {
            color: #ef4444 !important;
        }
        .profit-neutral {
            color: #d1d5db !important;
        }
        .session-digit-locked {
            background: linear-gradient(135deg, #1e3a8a, #1e40af) !important;
            border: 2px solid #3b82f6 !important;
            color: white !important;
        }
        .status-win {
            color: #10b981 !important;
            font-weight: bold !important;
        }
        .status-loss {
            color: #ef4444 !important;
            font-weight: bold !important;
        }
        .status-trade {
            color: #f59e0b !important;
            font-weight: bold !important;
        }
        /* Calculator Styles */
        .calculator-highlight {
            background: linear-gradient(135deg, #7c3aed, #8b5cf6) !important;
            border: 1px solid #a78bfa !important;
            color: white !important;
        }
        .calculator-warning {
            background: linear-gradient(135deg, #dc2626, #ef4444) !important;
            border: 1px solid #f87171 !important;
            color: white !important;
        }
        .calculator-safe {
            background: linear-gradient(135deg, #059669, #10b981) !important;
            border: 1px solid #34d399 !important;
            color: white !important;
        }
        @keyframes calculator-pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.02); }
            100% { transform: scale(1); }
        }
        .calculator-pulse {
            animation: calculator-pulse 0.5s ease-out;
        }
        /* Recheck Badge */
        .recheck-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: bold;
            margin-left: 5px;
            background: linear-gradient(90deg, #8b5cf6, #7c3aed);
            color: white;
        }
        .loss-streak-high {
            color: #ef4444 !important;
            animation: pulse-once 0.5s infinite;
        }
        
        /* AI PREDICTION STYLES */
        .ai-high-confidence {
            background: linear-gradient(135deg, #059669, #10b981) !important;
            border: 2px solid #34d399 !important;
            box-shadow: 0 0 15px rgba(16, 185, 129, 0.3) !important;
        }
        
        .ai-medium-confidence {
            background: linear-gradient(135deg, #d97706, #f59e0b) !important;
            border: 2px solid #fbbf24 !important;
            box-shadow: 0 0 10px rgba(245, 158, 11, 0.3) !important;
        }
        
        .ai-low-confidence {
            background: linear-gradient(135deg, #dc2626, #ef4444) !important;
            border: 2px solid #f87171 !important;
            box-shadow: 0 0 10px rgba(239, 68, 68, 0.3) !important;
        }
        
        .neural-network-node {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
            display: inline-block;
            margin: 1px;
            animation: pulse-node 2s infinite;
        }
        
        @keyframes pulse-node {
            0%, 100% { transform: scale(1); opacity: 0.7; }
            50% { transform: scale(1.1); opacity: 1; }
        }
        
        .model-training {
            background: linear-gradient(90deg, 
                #3b82f6 0%, 
                #8b5cf6 25%, 
                #ec4899 50%, 
                #ef4444 75%, 
                #f59e0b 100%) !important;
            background-size: 200% 100% !important;
            animation: training-gradient 2s infinite linear;
        }
        
        @keyframes training-gradient {
            0% { background-position: 200% 0; }
            100% { background-position: 0 0; }
        }
        
        .probability-bar {
            height: 20px;
            border-radius: 4px;
            margin: 2px 0;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            background: linear-gradient(90deg, #3b82f6, #8b5cf6);
        }
        
        .probability-bar::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, 
                transparent 0%, 
                rgba(255, 255, 255, 0.2) 50%, 
                transparent 100%);
            animation: shimmer 2s infinite;
        }
        
        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        
        .account-balance-green {
            color: #10b981 !important;
            font-weight: bold !important;
            text-shadow: 0 0 5px rgba(16, 185, 129, 0.3);
        }
        
        .trade-executing {
            background: linear-gradient(135deg, #f59e0b, #d97706) !important;
            border: 2px solid #fbbf24 !important;
            animation: pulse-once 0.5s infinite;
        }
        
        .trade-success {
            background: linear-gradient(135deg, #059669, #10b981) !important;
            border: 2px solid #34d399 !important;
            animation: pulse-once 1s;
        }
        
        .trade-failed {
            background: linear-gradient(135deg, #dc2626, #ef4444) !important;
            border: 2px solid #f87171 !important;
        }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght400;600;700&display=swap" rel="stylesheet">
</head>
<body class="min-h-screen p-4 sm:p-8 flex items-start justify-center">

    <div class="w-full max-w-6xl bg-gray-800 text-gray-100 shadow-2xl rounded-xl p-5 md:p-6">
        <div class="flex justify-between items-center mb-4">
            <h1 class="text-3xl font-extrabold text-green-400 border-b border-gray-700 pb-2">
                Deriv DigitMatchStar Bot 
                <span id="status-badge" class="ml-3 inline-flex items-center px-3 py-1 text-sm font-medium rounded-full connection-badge-disconnected text-white shadow-md">
                    üî¥ DISCONNECTED
                </span>
                <span id="contract-type-badge" class="contract-type-badge bg-purple-600 text-white">DIGITMATCH</span>
                <span id="recheck-badge" class="recheck-badge hidden">ADAPTIVE</span>
                <span id="ai-badge" class="contract-type-badge bg-pink-600 text-white hidden">AI ENABLED</span>
                <!-- Account toggle -->
                <div class="account-toggle-container ml-3">
                    <span class="account-label account-label-demo">DEMO</span>
                    <label class="account-toggle">
                        <input type="checkbox" id="accTypeToggle" onchange="switchAccount()">
                        <span class="account-toggle-slider"></span>
                    </label>
                    <span class="account-label account-label-real">REAL</span>
                </div>
            </h1>
            <div class="flex items-center space-x-2">
                <button id="aiToggleBtn" onclick="toggleAIPrediction()" 
                    class="px-4 py-2 bg-pink-600 text-white font-bold rounded-lg shadow hover:bg-pink-700 transition">
                    ü§ñ AI OFF
                </button>
                <button id="soundToggle" onclick="toggleSound()" 
                    class="px-4 py-2 bg-blue-600 text-white font-bold rounded-lg shadow hover:bg-blue-700 transition">
                    üîä Sound ON
                </button>
            </div>
        </div>
        
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
            <!-- LEFT COLUMN: SMART ANALYSIS ENGINE -->
            <div class="lg:col-span-1">
                <div class="bg-gray-900 border border-gray-700 rounded-xl p-4 shadow-lg analysis-settings-container">
                    <h2 class="text-lg font-bold text-cyan-400 mb-4 pb-2 border-b border-gray-700">
                        üß† SMART DIGIT ANALYSIS
                    </h2>
                    
                    <!-- AI Prediction Panel -->
                    <div id="ai-prediction-panel" class="mb-4 p-3 bg-gray-800 rounded-lg border border-pink-500/30 hidden">
                        <div class="flex justify-between items-center mb-2">
                            <h3 class="text-sm font-bold text-pink-300">AI Neural Network</h3>
                            <div class="flex space-x-1">
                                <div class="neural-network-node"></div>
                                <div class="neural-network-node" style="animation-delay: 0.2s"></div>
                                <div class="neural-network-node" style="animation-delay: 0.4s"></div>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-2 text-xs mb-3">
                            <div>
                                <span class="text-gray-400">Accuracy:</span>
                                <span id="ai-accuracy" class="ml-2 font-bold text-green-400">--%</span>
                            </div>
                            <div>
                                <span class="text-gray-400">Predictions:</span>
                                <span id="ai-prediction-count" class="ml-2 font-bold text-blue-400">0</span>
                            </div>
                        </div>
                        
                        <div class="w-full bg-gray-700 rounded-full h-2 mb-2">
                            <div id="ai-training-progress" class="bg-pink-600 h-2 rounded-full" style="width: 0%"></div>
                        </div>
                        <div class="text-xs text-gray-400 text-center">Model Confidence</div>
                        
                        <!-- AI Prediction Output -->
                        <div id="ai-prediction-output" class="mt-3 p-3 bg-gray-900 rounded border border-pink-500/50 text-sm hidden">
                            <div class="flex justify-between items-center mb-2">
                                <div class="text-pink-300 font-bold">AI Prediction:</div>
                                <div id="ai-confidence-badge" class="text-xs px-2 py-1 rounded-full bg-gray-700 text-gray-300">
                                    Confidence: --
                                </div>
                            </div>
                            <div class="text-center">
                                <div class="text-2xl font-bold text-white mb-1" id="ai-predicted-digit">--</div>
                                <div class="text-xs text-gray-400" id="ai-prediction-method">Analyzing patterns...</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Connection Status -->
                    <div class="mb-4 p-3 bg-gray-800 rounded-lg border border-gray-600">
                        <h3 class="text-sm font-bold text-gray-300 mb-2">Market Status</h3>
                        <div class="grid grid-cols-2 gap-2 text-xs">
                            <div>
                                <span class="text-gray-400">Connection:</span>
                                <span id="market_status" class="ml-2 font-bold text-red-400">Offline</span>
                            </div>
                            <div>
                                <span class="text-gray-400">Symbol:</span>
                                <span id="current_symbol" class="ml-2 font-bold text-cyan-400">V. 10 Index</span>
                            </div>
                            <div>
                                <span class="text-gray-400">Ticks Received:</span>
                                <span id="ticks_received" class="ml-2 font-bold text-green-400">0</span>
                            </div>
                            <div>
                                <span class="text-gray-400">Tick Rate:</span>
                                <span id="current_tick_rate" class="ml-2 font-bold text-blue-400">0/s</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Smart Predictor Settings -->
                    <div class="mb-4 p-3 bg-gray-800 rounded-lg border border-cyan-500/30">
                        <h3 class="text-sm font-bold text-cyan-300 mb-3">Analysis Settings</h3>
                        
                        <div class="mb-3">
                            <label class="block text-xs font-semibold text-gray-300 mb-1">Analysis Window</label>
                            <div class="flex items-center gap-2">
                                <input type="number" id="tick_window_input" value="20" min="3" max="100" 
                                    class="flex-1 rounded-md bg-gray-700 border border-gray-600 text-white shadow-sm focus:border-cyan-500 focus:ring-cyan-500 py-1.5 px-2 text-sm">
                                <button id="apply_tick_window" 
                                    class="px-3 py-1.5 bg-cyan-600 text-white font-bold rounded-md hover:bg-cyan-700 transition text-sm">
                                    Apply
                                </button>
                            </div>
                            <p class="text-xs text-gray-400 mt-1">Analyze last N ticks for digit patterns</p>
                        </div>
                        
                        <div id="tick_progress" class="mb-4 p-3 bg-gray-900 rounded text-center border border-gray-700">
                            <div class="text-cyan-400 font-bold mb-1">‚è≥ Waiting for Connection</div>
                            <div class="text-2xl font-bold mb-1">
                                <span id="tick_counter">0</span> / <span id="window_size">20</span>
                            </div>
                            <div class="w-full bg-gray-700 rounded-full h-3 mb-2">
                                <div id="tick_progress_bar" class="bg-cyan-600 h-3 rounded-full" style="width: 0%"></div>
                            </div>
                            <div class="text-xs text-gray-400">
                                <span id="analysis_status">Start bot to begin</span>
                            </div>
                        </div>
                        
                        <div id="prediction_box" class="p-3 bg-gray-800 rounded border border-cyan-500/50 text-sm">
                            <div class="text-cyan-300 font-bold mb-1">Prediction Analysis:</div>
                            <div class="text-gray-300" id="prediction_text">Connect to market first</div>
                        </div>
                        
                        <!-- Session Status Display -->
                        <div id="session_display" class="mt-4 p-3 bg-gray-800 rounded border border-blue-500/30 hidden">
                            <h3 class="text-sm font-bold text-blue-300 mb-2">Active Session</h3>
                            <div class="flex items-center justify-between">
                                <div>
                                    <div class="text-xs text-gray-300">Digit:</div>
                                    <div id="session_digit" class="text-xl font-bold text-green-400">-</div>
                                </div>
                                <div>
                                    <div class="text-xs text-gray-300">Mode:</div>
                                    <div id="session_mode" class="text-sm font-bold text-blue-400">-</div>
                                </div>
                                <div>
                                    <div class="text-xs text-gray-300">Trades:</div>
                                    <div id="session_trades" class="text-sm font-bold text-yellow-400">0/10</div>
                                </div>
                            </div>
                            <button id="new_analysis_btn" onclick="startNewAnalysis()" 
                                class="mt-2 w-full px-3 py-1.5 bg-purple-600 text-white font-bold rounded-md hover:bg-purple-700 transition text-sm">
                                üîÑ Run New Analysis
                            </button>
                        </div>
                    </div>
                    
                    <!-- Adaptive Recheck Settings -->
                    <div class="mt-4 p-3 bg-gray-800 rounded-lg border border-purple-500/30">
                        <h3 class="text-sm font-bold text-purple-300 mb-3">Adaptive Strategy</h3>
                        
                        <div class="mb-3">
                            <label class="block text-xs font-semibold text-gray-300 mb-1">
                                Recheck after consecutive losses:
                            </label>
                            <div class="flex items-center gap-2">
                                <input type="number" id="recheckThreshold" value="3" min="2" max="20" 
                                    class="flex-1 rounded-md bg-gray-700 border border-gray-600 text-white shadow-sm focus:border-purple-500 focus:ring-purple-500 py-1.5 px-2 text-sm">
                                <button onclick="updateRecheckSettings()" 
                                    class="px-3 py-1.5 bg-purple-600 text-white font-bold rounded-md hover:bg-purple-700 transition text-sm">
                                    Update
                                </button>
                            </div>
                            <p class="text-xs text-gray-400 mt-1">Reanalyze and adjust digit after X consecutive losses</p>
                        </div>
                        
                        <div class="flex items-center mb-2">
                            <input type="checkbox" id="enableRecheck" checked 
                                class="rounded bg-gray-700 border-gray-600 text-purple-600 focus:ring-purple-500">
                            <label for="enableRecheck" class="ml-2 text-xs text-gray-300">Enable adaptive reanalysis</label>
                        </div>
                        
                        <div class="text-xs text-gray-400 mb-2">
                            Max digit changes per session: 
                            <input type="number" id="maxDigitChanges" value="3" min="1" max="10" 
                                class="ml-2 w-12 rounded-md bg-gray-700 border border-gray-600 text-white text-center py-0.5 px-1">
                        </div>
                        
                        <div class="text-xs text-gray-400 mt-2 pt-2 border-t border-gray-700">
                            <div class="flex justify-between">
                                <span>Current loss streak:</span>
                                <span id="currentLossStreak" class="font-bold text-gray-300">0</span>
                            </div>
                            <div class="flex justify-between mt-1">
                                <span>Digit changes this session:</span>
                                <span id="digitChangesCount" class="font-bold text-gray-300">0</span>
                            </div>
                            <div class="flex justify-between mt-1">
                                <span>AI Accuracy:</span>
                                <span id="ai-accuracy-short" class="font-bold text-green-400">--%</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- MIDDLE COLUMN: MAIN CONTROLS -->
            <div class="lg:col-span-2">
                <!-- MARTINGALE CALCULATOR -->
                <div class="mb-6 p-4 bg-gray-900 rounded-xl border border-purple-500/50 shadow-lg">
                    <h2 class="text-lg font-bold text-purple-400 mb-3 pb-2 border-b border-gray-700 flex items-center">
                        üßÆ MARTINGALE CALCULATOR
                        <button onclick="toggleCalculator()" class="ml-auto text-xs bg-gray-700 hover:bg-gray-600 px-2 py-1 rounded">
                            <span id="calcToggleIcon">‚àí</span>
                        </button>
                    </h2>
                    
                    <div id="calculatorContent" class="transition-all duration-300">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <!-- Left Column: Inputs -->
                            <div class="space-y-3">
                                <div>
                                    <label class="block text-xs font-semibold text-gray-300 mb-1">Base Stake ($)</label>
                                    <input type="number" id="calc_base_stake" value="1.0" min="0.1" step="0.1" 
                                        class="w-full rounded-md bg-gray-700 border border-gray-600 text-white shadow-sm focus:border-purple-500 focus:ring-purple-500 py-1.5 px-2 text-sm calculator-highlight">
                                </div>
                                
                                <div>
                                    <label class="block text-xs font-semibold text-gray-300 mb-1">Multiplier</label>
                                    <input type="number" id="calc_multiplier" value="1.15" min="1.0" step="0.01" 
                                        class="w-full rounded-md bg-gray-700 border border-gray-600 text-white shadow-sm focus:border-purple-500 focus:ring-purple-500 py-1.5 px-2 text-sm">
                                </div>
                                
                                <div>
                                    <label class="block text-xs font-semibold text-gray-300 mb-1">Max Trades</label>
                                    <input type="number" id="calc_max_trades" value="10" min="1" max="100" 
                                        class="w-full rounded-md bg-gray-700 border border-gray-600 text-white shadow-sm focus:border-purple-500 focus:ring-purple-500 py-1.5 px-2 text-sm">
                                </div>
                                
                                <div>
                                    <label class="block text-xs font-semibold text-gray-300 mb-1">Bankroll Limit ($)</label>
                                    <input type="number" id="calc_bankroll_limit" value="50.0" min="1.0" step="0.1" 
                                        class="w-full rounded-md bg-gray-700 border border-gray-600 text-white shadow-sm focus:border-purple-500 focus:ring-purple-500 py-1.5 px-2 text-sm">
                                </div>
                                
                                <button onclick="calculateMartingale()" 
                                    class="w-full mt-2 px-4 py-2 bg-purple-600 text-white font-bold rounded-lg hover:bg-purple-700 transition">
                                    üßÆ CALCULATE
                                </button>
                            </div>
                            
                            <!-- Right Column: Results -->
                            <div class="space-y-3">
                                <div class="p-3 bg-gray-800 rounded-lg border border-green-500/50">
                                    <div class="text-xs font-semibold text-green-400 mb-1">Total Required</div>
                                    <div id="calc_total_required" class="text-xl font-bold text-white">$0.00</div>
                                    <div class="text-xs text-gray-400 mt-1">For all trades</div>
                                </div>
                                
                                <div class="p-3 bg-gray-800 rounded-lg border border-blue-500/50">
                                    <div class="text-xs font-semibold text-blue-400 mb-1">Final Stake</div>
                                    <div id="calc_final_stake" class="text-lg font-bold text-white">$0.00</div>
                                    <div class="text-xs text-gray-400 mt-1">Last trade amount</div>
                                </div>
                                
                                <div class="p-3 bg-gray-800 rounded-lg border border-yellow-500/50">
                                    <div class="text-xs font-semibold text-yellow-400 mb-1">Bankroll Status</div>
                                    <div id="calc_bankroll_status" class="text-lg font-bold text-white">-</div>
                                    <div class="text-xs text-gray-400 mt-1">vs. your limit</div>
                                </div>
                                
                                <div class="p-3 bg-gray-800 rounded-lg border border-cyan-500/50">
                                    <div class="text-xs font-semibold text-cyan-400 mb-1">Profit on Win</div>
                                    <div id="calc_profit_on_win" class="text-lg font-bold text-white">$0.00</div>
                                    <div class="text-xs text-gray-400 mt-1">9x payout minus investment</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Stake Progression Table -->
                        <div class="mt-4">
                            <div class="text-xs font-semibold text-gray-300 mb-2">Stake Progression</div>
                            <div id="calc_progression" class="text-xs text-gray-400 italic">Click CALCULATE to see stake progression</div>
                        </div>
                    </div>
                </div>
                
                <!-- Main Trading Controls -->
                <div class="grid grid-cols-2 lg:grid-cols-3 gap-3 mb-6">
                    <!-- Symbol -->
                    <div>
                        <label for="symbol" class="block text-xs font-semibold text-gray-300 mb-1">Symbol</label>
                        <select id="symbol" class="block w-full rounded-md bg-gray-700 border border-gray-600 text-white shadow-sm focus:border-green-500 focus:ring-green-500 py-1.5 px-2 text-sm">
                            <option value="R_10">V. 10 Index</option>
                            <option value="R_100">V. 100 Index</option>
                            <option value="R_25">V. 25 Index</option>
                            <option value="R_50">V. 50 Index</option>
                            <option value="R_75">V. 75 Index</option>
                        </select>
                    </div>
                    
                    <!-- Predicted Digit -->
                    <div>
                        <label for="predictedDigit" class="block text-xs font-semibold text-gray-300 mb-1">Predicted Digit</label>
                        <input type="number" id="predictedDigit" value="5" min="0" max="9" 
                            class="block w-full rounded-md bg-gray-700 border border-gray-600 text-white shadow-sm focus:border-green-500 focus:ring-green-500 py-1.5 px-2 text-sm text-center">
                    </div>

                    <!-- Contract Type -->
                    <div>
                        <label for="contractType" class="block text-xs font-semibold text-gray-300 mb-1">Contract Type</label>
                        <select id="contractType" class="block w-full rounded-md bg-gray-700 border border-gray-600 text-white shadow-sm focus:border-green-500 focus:ring-green-500 py-1.5 px-2 text-sm">
                            <option value="DIGITMATCH">DIGITMATCH</option>
                        </select>
                    </div>

                    <!-- Base Stake -->
                    <div>
                        <label for="baseStake" class="block text-xs font-semibold text-gray-300 mb-1">Base Stake</label>
                        <input type="number" id="baseStake" value="1.0" min="0.1" step="0.1" 
                            class="block w-full rounded-md bg-gray-700 border border-gray-600 text-white shadow-sm focus:border-green-500 focus:ring-green-500 py-1.5 px-2 text-sm">
                    </div>

                    <!-- Multiplier -->
                    <div>
                        <label for="multiplier" class="block text-xs font-semibold text-gray-300 mb-1">Multiplier</label>
                        <input type="number" id="multiplier" value="1.15" min="1.0" step="0.01" 
                            class="block w-full rounded-md bg-gray-700 border border-gray-600 text-white shadow-sm focus:border-green-500 focus:ring-green-500 py-1.5 px-2 text-sm">
                    </div>

                    <!-- Max Trades -->
                    <div>
                        <label for="maxTrades" class="block text-xs font-semibold text-gray-300 mb-1">Max Trades</label>
                        <input type="number" id="maxTrades" value="10" min="1" max="100" 
                            class="block w-full rounded-md bg-gray-700 border border-gray-600 text-white shadow-sm focus:border-green-500 focus:ring-green-500 py-1.5 px-2 text-sm">
                    </div>
                    
                    <!-- Mode Toggle -->
                    <div class="col-span-2 lg:col-span-3">
                        <label class="block text-xs font-semibold text-gray-300 mb-1">Execution Mode</label>
                        <div class="grid grid-cols-3 gap-2">
                            <button id="mode_instant" onclick="switchMode('instant')" 
                                class="px-4 py-2 bg-green-600 text-white font-bold rounded-lg hover:bg-green-700 transition">
                                ‚ö° INSTANT
                            </button>
                            <button id="mode_smart" onclick="switchMode('smart')" 
                                class="px-4 py-2 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 transition">
                                üß† SMART
                            </button>
                            <button id="mode_ai" onclick="switchMode('ai')" 
                                class="px-4 py-2 bg-pink-600 text-white font-bold rounded-lg hover:bg-pink-700 transition">
                                ü§ñ AI MODE
                            </button>
                        </div>
                        <p id="mode_description" class="text-xs text-gray-400 mt-1">
                            ‚ö° INSTANT: Trade on each tick
                        </p>
                    </div>
                </div>
                
                <!-- METRICS -->
                <div class="grid grid-cols-4 gap-3">
                    <div class="bg-gray-700 rounded-lg p-2 shadow-inner border border-green-500/50 col-span-2">
                        <p class="text-[10px] font-semibold text-green-500 uppercase">Current Tick</p>
                        <p id="metricLiveTick" class="text-xl font-extrabold text-white">---</p>
                        <p id="metricLastDigit" class="text-lg font-bold text-green-300">Digit: ?</p>
                        <p id="metricTickRate" class="text-xs font-bold text-blue-400">Ticks/sec: --</p>
                    </div>
                    
                    <div class="bg-gray-700 rounded-lg p-2 shadow-inner border border-purple-500/50">
                        <p class="text-[10px] font-semibold text-purple-500 uppercase">Balance</p>
                        <p id="metricAccountBalance" class="text-lg font-bold account-balance-green">$---</p>
                    </div>
                    
                    <div class="bg-gray-700 rounded-lg p-2 shadow-inner border border-pink-500/50">
                        <p class="text-[10px] font-semibold text-pink-500 uppercase">AI Confidence</p>
                        <p id="metricAIConfidence" class="text-lg font-bold text-white">--%</p>
                    </div>
                    
                    <div class="bg-gray-700 rounded-lg p-2 shadow-inner">
                        <p class="text-[10px] font-semibold text-green-500 uppercase">Trade #</p>
                        <p id="metricTradeCount" class="text-lg font-bold text-white">0</p>
                    </div>
                    
                    <div class="bg-gray-700 rounded-lg p-2 shadow-inner">
                        <p class="text-[10px] font-semibold text-lime-400 uppercase">P/L</p>
                        <p id="metricTotalProfit" class="text-lg font-bold profit-neutral">$0.00</p>
                    </div>
                    
                    <div class="bg-gray-700 rounded-lg p-2 shadow-inner">
                        <p class="text-[10px] font-semibold text-green-500 uppercase">Stake</p>
                        <p id="metricCurrentStake" class="text-lg font-bold text-white">$0.00</p>
                    </div>
                    
                    <div class="bg-gray-700 rounded-lg p-2 shadow-inner">
                        <p class="text-[10px] font-semibold text-yellow-500 uppercase">Win Rate</p>
                        <p id="metricWinRate" class="text-lg font-bold text-white">0%</p>
                    </div>
                    
                    <!-- TRADE STATUS SECTION - ONLY GLOW ON WINS -->
                    <div id="trade-result-container" class="bg-gray-900 rounded-lg p-3 shadow-inner border border-yellow-500/50 col-span-4">
                        <div class="flex justify-between items-center mb-2">
                            <p class="text-[10px] font-semibold text-yellow-500 uppercase">TRADE STATUS</p>
                            <p id="metricTradeResult" class="text-xs font-bold text-gray-400">READY</p>
                        </div>
                        <div class="mb-2">
                            <p class="text-[10px] font-semibold text-gray-400 uppercase mb-1">Status:</p>
                            <p id="metricPreviousResult" class="text-sm font-bold text-gray-300">Waiting for connection...</p>
                        </div>
                        <div>
                            <p class="text-[10px] font-semibold text-gray-400 uppercase mb-1">Action:</p>
                            <p id="metricNextAction" class="text-sm font-bold text-yellow-400">Start bot to begin</p>
                        </div>
                    </div>
                </div>
                
                <!-- AI ANALYSIS VISUALIZATION -->
                <div id="ai-visualization" class="mt-6 p-4 bg-gray-900 rounded-xl border border-pink-500/50 shadow-lg hidden">
                    <h2 class="text-lg font-bold text-pink-400 mb-3 pb-2 border-b border-gray-700">
                        ü§ñ AI PATTERN ANALYSIS
                    </h2>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <div class="text-xs font-semibold text-gray-300 mb-2">Digit Probabilities</div>
                            <div id="probability-distribution" class="space-y-1">
                                <!-- Probability bars will be inserted here -->
                            </div>
                        </div>
                        <div>
                            <div class="text-xs font-semibold text-gray-300 mb-2">Pattern Insights</div>
                            <div id="pattern-insights" class="text-xs text-gray-400">
                                <div class="mb-1">‚Ä¢ AI analyzing market patterns...</div>
                                <div class="mb-1">‚Ä¢ Waiting for sufficient data</div>
                                <div>‚Ä¢ Neural network learning active</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- START/STOP BUTTON -->
        <div class="flex justify-center mb-5">
            <button id="toggleButton" onclick="toggleBot()" 
                class="w-full md:w-1/2 px-6 py-3 bg-green-600 text-white font-bold text-lg rounded-lg shadow-xl hover:bg-green-700 transition duration-150">
                üöÄ START BOT
            </button>
        </div>

        <!-- LOG AREA -->
        <div id="log-column" class="w-full flex flex-col">
            <h2 class="text-lg font-bold text-gray-300 mb-2 border-b border-gray-700 pb-1">Live Log</h2>
            <div id="log-area" class="flex-grow h-80 bg-gray-900 text-lime-400 p-2.5 rounded-lg overflow-y-scroll text-xs whitespace-pre-wrap shadow-inner">
[00:00:00] ü§ñ Deriv Bot Initialized
[00:00:00] üìä Ready to connect to live market
[00:00:00] üß† Smart analysis engine ready
[00:00:00] üîÑ Adaptive strategy enabled
[00:00:00] ü§ñ AI Prediction System: DISABLED
            </div>
        </div>
    </div>

    <script>
        // ============================================================================
        // AI PREDICTION ENGINE
        // ============================================================================
        
        class AIPredictionEngine {
            constructor() {
                this.model = null;
                this.isEnabled = false;
                this.isTraining = false;
                this.trainingData = [];
                this.predictionHistory = [];
                this.accuracy = 0;
                this.totalPredictions = 0;
                this.correctPredictions = 0;
                this.lastPrediction = null;
                this.sequenceLength = 10;
                
                this.initializeModel();
            }
            
            initializeModel() {
                // Simple statistical model for pattern recognition
                this.model = {
                    digitFrequencies: Array(10).fill(0),
                    transitionMatrix: Array(10).fill().map(() => Array(10).fill(0)),
                    sequencePatterns: new Map(),
                    lastDigits: []
                };
                
                log('ü§ñ AI Engine initialized', 'AI');
            }
            
            analyzeDigits(digits) {
                if (!this.isEnabled || digits.length < 5) {
                    return this.basicAnalysis(digits);
                }
                
                // Update model with new data
                this.updateModel(digits);
                
                // Analyze patterns
                const analysis = this.advancedAnalysis(digits);
                
                // Calculate confidence
                const confidence = this.calculateConfidence(analysis);
                
                // Store prediction
                this.lastPrediction = {
                    digit: analysis.predictedDigit,
                    confidence: confidence,
                    method: analysis.method,
                    timestamp: Date.now()
                };
                
                return this.lastPrediction;
            }
            
            updateModel(digits) {
                // Update digit frequencies
                digits.slice(-20).forEach(digit => {
                    if (digit >= 0 && digit <= 9) {
                        this.model.digitFrequencies[digit]++;
                    }
                });
                
                // Update transition matrix
                for (let i = 1; i < digits.length; i++) {
                    const from = digits[i-1];
                    const to = digits[i];
                    if (from >= 0 && from <= 9 && to >= 0 && to <= 9) {
                        this.model.transitionMatrix[from][to]++;
                    }
                }
                
                // Store sequence patterns
                if (digits.length >= this.sequenceLength) {
                    const sequence = digits.slice(-this.sequenceLength).join('');
                    const count = this.model.sequencePatterns.get(sequence) || 0;
                    this.model.sequencePatterns.set(sequence, count + 1);
                }
                
                // Keep last digits for quick reference
                this.model.lastDigits = digits.slice(-50);
            }
            
            advancedAnalysis(digits) {
                const recentDigits = digits.slice(-20);
                
                // Method 1: Frequency analysis
                const freqAnalysis = this.frequencyAnalysis(recentDigits);
                
                // Method 2: Transition probability
                const transAnalysis = this.transitionAnalysis(recentDigits);
                
                // Method 3: Pattern recognition
                const patternAnalysis = this.patternRecognition(digits);
                
                // Method 4: Gap analysis
                const gapAnalysis = this.gapAnalysis(recentDigits);
                
                // Combine results with weights
                const combined = this.combineAnalyses(
                    freqAnalysis,
                    transAnalysis,
                    patternAnalysis,
                    gapAnalysis
                );
                
                return {
                    predictedDigit: combined.digit,
                    method: combined.method,
                    details: {
                        frequency: freqAnalysis,
                        transition: transAnalysis,
                        pattern: patternAnalysis,
                        gap: gapAnalysis
                    }
                };
            }
            
            frequencyAnalysis(digits) {
                const freq = Array(10).fill(0);
                digits.forEach(d => freq[d]++);
                
                // Find missing digits
                const missing = [];
                for (let i = 0; i < 10; i++) {
                    if (freq[i] === 0) missing.push(i);
                }
                
                if (missing.length > 0) {
                    return {
                        digit: missing[Math.floor(Math.random() * missing.length)],
                        confidence: 0.7,
                        method: 'frequency_missing'
                    };
                }
                
                // Find least frequent
                let leastFreq = 0;
                let minFreq = Infinity;
                for (let i = 0; i < 10; i++) {
                    if (freq[i] < minFreq) {
                        minFreq = freq[i];
                        leastFreq = i;
                    }
                }
                
                return {
                    digit: leastFreq,
                    confidence: 0.6,
                    method: 'frequency_least'
                };
            }
            
            transitionAnalysis(digits) {
                if (digits.length < 2) {
                    return { digit: Math.floor(Math.random() * 10), confidence: 0.3, method: 'random' };
                }
                
                const lastDigit = digits[digits.length - 1];
                const transitions = this.model.transitionMatrix[lastDigit];
                
                // Find most likely next digit based on transitions
                let maxTrans = 0;
                let predicted = 0;
                for (let i = 0; i < 10; i++) {
                    if (transitions[i] > maxTrans) {
                        maxTrans = transitions[i];
                        predicted = i;
                    }
                }
                
                // If no transitions found, use anti-pattern (avoid last digit)
                if (maxTrans === 0) {
                    predicted = (lastDigit + 5) % 10; // Opposite digit
                }
                
                const confidence = Math.min(0.8, maxTrans / (digits.length / 10));
                
                return {
                    digit: predicted,
                    confidence: confidence,
                    method: 'transition_based'
                };
            }
            
            patternRecognition(digits) {
                if (digits.length < this.sequenceLength) {
                    return { digit: Math.floor(Math.random() * 10), confidence: 0.3, method: 'random' };
                }
                
                const recentSequence = digits.slice(-this.sequenceLength).join('');
                
                // Look for repeating patterns
                let bestPattern = null;
                let bestCount = 0;
                
                for (const [pattern, count] of this.model.sequencePatterns) {
                    if (count > bestCount && pattern !== recentSequence) {
                        // Check if pattern ends with part of recent sequence
                        const patternEnd = pattern.slice(-5);
                        const recentStart = recentSequence.slice(0, 5);
                        if (patternEnd === recentStart) {
                            bestPattern = pattern;
                            bestCount = count;
                        }
                    }
                }
                
                if (bestPattern) {
                    // Predict next digit in pattern
                    const nextDigit = parseInt(bestPattern[this.sequenceLength % bestPattern.length]);
                    return {
                        digit: nextDigit,
                        confidence: Math.min(0.9, bestCount / 10),
                        method: 'pattern_match'
                    };
                }
                
                return { digit: Math.floor(Math.random() * 10), confidence: 0.4, method: 'no_pattern' };
            }
            
            gapAnalysis(digits) {
                const lastSeen = Array(10).fill(-1);
                
                digits.forEach((d, index) => {
                    if (d >= 0 && d <= 9) {
                        lastSeen[d] = index;
                    }
                });
                
                // Find digit with longest gap
                let longestGap = -1;
                let predictedDigit = 0;
                
                for (let i = 0; i < 10; i++) {
                    const gap = digits.length - 1 - lastSeen[i];
                    if (gap > longestGap) {
                        longestGap = gap;
                        predictedDigit = i;
                    }
                }
                
                const confidence = Math.min(0.8, longestGap / 20);
                
                return {
                    digit: predictedDigit,
                    confidence: confidence,
                    method: 'gap_analysis'
                };
            }
            
            combineAnalyses(...analyses) {
                // Weight different analysis methods
                const weights = {
                    frequency_missing: 0.4,
                    frequency_least: 0.3,
                    transition_based: 0.35,
                    pattern_match: 0.5,
                    gap_analysis: 0.4,
                    no_pattern: 0.2,
                    random: 0.1
                };
                
                const digitScores = Array(10).fill(0);
                
                analyses.forEach(analysis => {
                    const weight = weights[analysis.method] || 0.2;
                    digitScores[analysis.digit] += analysis.confidence * weight;
                });
                
                // Find digit with highest score
                let bestDigit = 0;
                let bestScore = -1;
                
                for (let i = 0; i < 10; i++) {
                    if (digitScores[i] > bestScore) {
                        bestScore = digitScores[i];
                        bestDigit = i;
                    }
                }
                
                // Determine which method contributed most
                let bestMethod = 'combined';
                let methodScore = -1;
                
                analyses.forEach(analysis => {
                    if (analysis.digit === bestDigit && analysis.confidence > methodScore) {
                        methodScore = analysis.confidence;
                        bestMethod = analysis.method;
                    }
                });
                
                return {
                    digit: bestDigit,
                    method: bestMethod,
                    score: bestScore
                };
            }
            
            calculateConfidence(analysis) {
                let confidence = analysis.details.frequency.confidence;
                
                // Boost confidence if multiple methods agree
                const methods = [
                    analysis.details.frequency,
                    analysis.details.transition,
                    analysis.details.pattern,
                    analysis.details.gap
                ];
                
                const sameDigitCount = methods.filter(m => m.digit === analysis.predictedDigit).length;
                
                if (sameDigitCount >= 2) {
                    confidence += 0.15;
                }
                if (sameDigitCount >= 3) {
                    confidence += 0.2;
                }
                
                // Cap confidence
                return Math.min(0.95, Math.max(0.1, confidence));
            }
            
            basicAnalysis(digits) {
                if (digits.length === 0) {
                    return {
                        digit: Math.floor(Math.random() * 10),
                        confidence: 0.1,
                        method: 'random',
                        timestamp: Date.now()
                    };
                }
                
                const freq = Array(10).fill(0);
                digits.forEach(d => freq[d]++);
                
                const missing = [];
                for (let i = 0; i < 10; i++) {
                    if (freq[i] === 0) missing.push(i);
                }
                
                let predictedDigit;
                let method = 'basic';
                
                if (missing.length > 0) {
                    predictedDigit = missing[Math.floor(Math.random() * missing.length)];
                    method = 'basic_missing';
                } else {
                    let leastFreq = 0;
                    let minFreq = Infinity;
                    for (let i = 0; i < 10; i++) {
                        if (freq[i] < minFreq) {
                            minFreq = freq[i];
                            leastFreq = i;
                        }
                    }
                    predictedDigit = leastFreq;
                    method = 'basic_least';
                }
                
                const confidence = 0.3 + (missing.length > 0 ? 0.2 : 0);
                
                this.lastPrediction = {
                    digit: predictedDigit,
                    confidence: confidence,
                    method: method,
                    timestamp: Date.now()
                };
                
                return this.lastPrediction;
            }
            
            recordOutcome(predictedDigit, actualDigit, wasWin) {
                this.totalPredictions++;
                
                if (wasWin) {
                    this.correctPredictions++;
                }
                
                this.accuracy = this.correctPredictions / Math.max(1, this.totalPredictions);
                
                // Store in history
                this.predictionHistory.push({
                    predicted: predictedDigit,
                    actual: actualDigit,
                    win: wasWin,
                    timestamp: Date.now()
                });
                
                // Keep history limited
                if (this.predictionHistory.length > 100) {
                    this.predictionHistory.shift();
                }
                
                return this.accuracy;
            }
            
            getAccuracy() {
                return this.accuracy;
            }
            
            getRecentPerformance() {
                const recent = this.predictionHistory.slice(-20);
                if (recent.length === 0) return 0;
                
                const wins = recent.filter(p => p.win).length;
                return wins / recent.length;
            }
            
            enable() {
                this.isEnabled = true;
                log('‚úÖ AI Prediction enabled', 'AI');
            }
            
            disable() {
                this.isEnabled = false;
                log('‚è∏Ô∏è AI Prediction disabled', 'AI');
            }
            
            toggle() {
                this.isEnabled = !this.isEnabled;
                return this.isEnabled;
            }
        }
        
        // Initialize AI Engine
        window.aiEngine = new AIPredictionEngine();
        
        // ============================================================================
        // ENHANCED ANALYSIS FUNCTIONS
        // ============================================================================
        
        // Override the performAnalysis function to include AI
        const originalPerformAnalysis = window.performAnalysis;
        window.performAnalysis = function() {
            if (analysisDigits.length < analysisWindowSize) return;
            
            if (sessionState.sessionStarted && sessionState.sessionDigit !== null) {
                log(`üîí Session active - digit ${sessionState.sessionDigit} remains locked`, 'SESSION');
                return;
            }
            
            try {
                let prediction;
                let useAI = false;
                
                // Use AI if enabled and in AI mode
                if (window.aiEngine.isEnabled && sessionState.mode === 'ai' && analysisDigits.length >= 10) {
                    prediction = window.aiEngine.analyzeDigits(analysisDigits);
                    useAI = true;
                    suggestedDigit = prediction.digit;
                    
                    // Display AI prediction
                    displayAIPrediction(prediction);
                    
                    log(`ü§ñ AI Prediction: ${suggestedDigit} (${(prediction.confidence * 100).toFixed(0)}% confidence)`, 'AI');
                } else {
                    // Use traditional analysis
                    const freq = Array(10).fill(0);
                    analysisDigits.forEach(d => {
                        if (d >= 0 && d <= 9) freq[d]++;
                    });
                    
                    const missing = [];
                    for (let i = 0; i < 10; i++) {
                        if (freq[i] === 0) missing.push(i);
                    }
                    
                    if (missing.length > 0) {
                        suggestedDigit = missing[Math.floor(Math.random() * missing.length)];
                        log(`üß† Analysis: Digit ${suggestedDigit} missing from last ${analysisWindowSize} ticks`, 'ANALYSIS');
                    } else {
                        let leastFrequent = 0;
                        let minFreq = Infinity;
                        for (let i = 0; i < 10; i++) {
                            if (freq[i] < minFreq) {
                                minFreq = freq[i];
                                leastFrequent = i;
                            }
                        }
                        suggestedDigit = leastFrequent;
                        log(`üß† Analysis: Digit ${suggestedDigit} is least frequent`, 'ANALYSIS');
                    }
                }
                
                analysisComplete = true;
                window.lastAnalysisTime = Date.now();
                updatePredictionBox();
                
                // Only auto-lock in smart mode, not AI mode
                if (sessionState.mode === 'smart' && suggestedDigit !== null) {
                    lockSessionDigit(suggestedDigit);
                } else if (sessionState.mode === 'ai' && useAI && prediction.confidence > 0.7) {
                    // Auto-lock in AI mode only if confidence is high
                    lockSessionDigit(suggestedDigit);
                    log(`üîí AI high-confidence prediction ${suggestedDigit} locked`, 'AI');
                }
                
                updateExecutionLogic();
                
            } catch (error) {
                console.error('Analysis error:', error);
            }
        };
        
        // Enhanced checkAndReanalyze with AI support
        const originalCheckAndReanalyze = window.checkAndReanalyze;
        window.checkAndReanalyze = function(currentDigit) {
            if (!window.recheckEnabled || sessionState.mode !== 'smart') {
                return false;
            }
            
            // Check cooldown period
            const now = Date.now();
            if (now - window.lastRecheckTime < window.recheckCooldown) {
                return false;
            }
            
            // Check if we've changed digits too many times
            if (window.digitChangesThisSession >= window.maxDigitChanges) {
                log(`‚ö†Ô∏è Maximum digit changes reached (${window.maxDigitChanges})`, 'ANALYSIS');
                return false;
            }
            
            // Check if we need to reanalyze
            const needRecheck = window.consecutiveLosses >= window.recheckThreshold;
            const timeSinceAnalysis = now - window.lastAnalysisTime;
            const marketChanged = timeSinceAnalysis > 30000;
            
            if (needRecheck || marketChanged) {
                log(`üîç Adaptive recheck triggered after ${window.consecutiveLosses} consecutive losses`, 'ANALYSIS');
                log(`üí∞ Current stake: $${window.currentStake.toFixed(2)}, Martingale step: ${window.martingaleStep}`, 'ANALYSIS');
                
                // Store current state
                const currentSessionDigit = sessionState.sessionDigit;
                const currentStake = window.currentStake;
                const currentMartingaleStep = window.martingaleStep;
                
                // Try to get fresh analysis
                let freshAnalysis = collectQuickAnalysis(15);
                
                // If using AI mode and AI is enabled
                if (sessionState.mode === 'ai' && window.aiEngine.isEnabled && freshAnalysis.length >= 5) {
                    const aiPrediction = window.aiEngine.analyzeDigits(freshAnalysis);
                    
                    if (aiPrediction.confidence > 0.6 && aiPrediction.digit !== currentSessionDigit) {
                        window.digitChangesThisSession++;
                        window.lastRecheckTime = now;
                        
                        log(`üîÑ AI Strategy change: ${currentSessionDigit} ‚Üí ${aiPrediction.digit}`, 'AI');
                        log(`üìä AI Confidence: ${(aiPrediction.confidence * 100).toFixed(0)}%`, 'AI');
                        log(`üìä Martingale CONTINUES: Step ${currentMartingaleStep}, Stake $${currentStake.toFixed(2)}`, 'STRATEGY');
                        
                        // Update session with new digit
                        sessionState.sessionDigit = aiPrediction.digit;
                        sessionState.manualOverride = false;
                        document.getElementById('predictedDigit').value = aiPrediction.digit;
                        
                        // Update analysis time
                        window.lastAnalysisTime = now;
                        
                        updatePredictionBox();
                        updateSessionDisplay();
                        
                        // Display AI prediction
                        displayAIPrediction(aiPrediction);
                        
                        log(`üéØ New AI target digit: ${aiPrediction.digit}`, 'AI');
                        log(`üí∞ Continuing martingale with stake: $${currentStake.toFixed(2)} (Step ${currentMartingaleStep})`, 'STRATEGY');
                        
                        updateTradeStatus('AI STRATEGY', 
                            `Changed to digit ${aiPrediction.digit} (AI Confidence: ${(aiPrediction.confidence * 100).toFixed(0)}%)`,
                            `Continuing with $${currentStake.toFixed(2)} stake`,
                            'normal');
                        
                        return true;
                    }
                }
                
                // Fall back to original recheck logic
                return originalCheckAndReanalyze(currentDigit);
            }
            
            return false;
        };
        
        // ============================================================================
        // AI UI FUNCTIONS
        // ============================================================================
        
        function toggleAIPrediction() {
            const enabled = window.aiEngine.toggle();
            const aiToggleBtn = document.getElementById('aiToggleBtn');
            const aiBadge = document.getElementById('ai-badge');
            const aiPanel = document.getElementById('ai-prediction-panel');
            
            if (enabled) {
                aiToggleBtn.textContent = 'ü§ñ AI ON';
                aiToggleBtn.className = 'px-4 py-2 bg-green-600 text-white font-bold rounded-lg shadow hover:bg-green-700 transition';
                aiBadge.classList.remove('hidden');
                aiPanel.classList.remove('hidden');
                log('‚úÖ AI Prediction System ENABLED', 'AI');
                
                // If we have enough data, show initial prediction
                if (analysisDigits.length >= 10) {
                    const prediction = window.aiEngine.analyzeDigits(analysisDigits);
                    displayAIPrediction(prediction);
                }
            } else {
                aiToggleBtn.textContent = 'ü§ñ AI OFF';
                aiToggleBtn.className = 'px-4 py-2 bg-pink-600 text-white font-bold rounded-lg shadow hover:bg-pink-700 transition';
                aiBadge.classList.add('hidden');
                aiPanel.classList.add('hidden');
                document.getElementById('ai-prediction-output').classList.add('hidden');
                document.getElementById('ai-visualization').classList.add('hidden');
                log('‚è∏Ô∏è AI Prediction System DISABLED', 'AI');
            }
        }
        
        function displayAIPrediction(prediction) {
            const output = document.getElementById('ai-prediction-output');
            const digitElem = document.getElementById('ai-predicted-digit');
            const confidenceBadge = document.getElementById('ai-confidence-badge');
            const methodElem = document.getElementById('ai-prediction-method');
            const visualization = document.getElementById('ai-visualization');
            const aiAccuracyShort = document.getElementById('ai-accuracy-short');
            const metricAIConfidence = document.getElementById('metricAIConfidence');
            
            if (!output || !digitElem) return;
            
            // Show elements
            output.classList.remove('hidden');
            visualization.classList.remove('hidden');
            
            // Update prediction
            digitElem.textContent = prediction.digit;
            
            // Update confidence badge
            const confidencePercent = Math.round(prediction.confidence * 100);
            confidenceBadge.textContent = `Confidence: ${confidencePercent}%`;
            
            // Set confidence color
            output.classList.remove('ai-high-confidence', 'ai-medium-confidence', 'ai-low-confidence');
            if (confidencePercent >= 70) {
                output.classList.add('ai-high-confidence');
            } else if (confidencePercent >= 40) {
                output.classList.add('ai-medium-confidence');
            } else {
                output.classList.add('ai-low-confidence');
            }
            
            // Update method
            methodElem.textContent = prediction.method.replace(/_/g, ' ');
            
            // Update accuracy displays
            const accuracy = window.aiEngine.getAccuracy() * 100;
            document.getElementById('ai-accuracy').textContent = `${accuracy.toFixed(1)}%`;
            if (aiAccuracyShort) {
                aiAccuracyShort.textContent = `${accuracy.toFixed(1)}%`;
            }
            
            // Update AI confidence metric
            if (metricAIConfidence) {
                metricAIConfidence.textContent = `${confidencePercent}%`;
                metricAIConfidence.className = `text-lg font-bold ${
                    confidencePercent >= 70 ? 'text-green-400' :
                    confidencePercent >= 40 ? 'text-yellow-400' : 'text-red-400'
                }`;
            }
            
            // Update probability distribution
            updateProbabilityDistribution(prediction);
            
            // Update pattern insights
            updatePatternInsights(prediction);
            
            // Update training progress
            const trainingProgress = Math.min(100, window.aiEngine.totalPredictions * 2);
            document.getElementById('ai-training-progress').style.width = `${trainingProgress}%`;
            
            // Update prediction count
            document.getElementById('ai-prediction-count').textContent = window.aiEngine.totalPredictions;
        }
        
        function updateProbabilityDistribution(prediction) {
            const container = document.getElementById('probability-distribution');
            if (!container) return;
            
            // Generate probability bars for each digit
            let html = '';
            for (let i = 0; i < 10; i++) {
                const isPredicted = i === prediction.digit;
                // Calculate probability (simplified - higher for predicted digit)
                const probability = isPredicted ? prediction.confidence : (1 - prediction.confidence) / 9;
                const width = Math.max(5, probability * 100);
                
                html += `
                    <div class="flex items-center">
                        <div class="w-4 text-xs text-gray-400 mr-2">${i}</div>
                        <div class="flex-1">
                            <div class="probability-bar ${isPredicted ? 'bg-green-500' : 'bg-blue-500'}" 
                                 style="width: ${width}%">
                            </div>
                        </div>
                        <div class="w-8 text-xs text-right ${isPredicted ? 'text-green-400 font-bold' : 'text-gray-400'}">
                            ${(probability * 100).toFixed(0)}%
                        </div>
                    </div>
                `;
            }
            
            container.innerHTML = html;
        }
        
        function updatePatternInsights(prediction) {
            const container = document.getElementById('pattern-insights');
            if (!container) return;
            
            const insights = [];
            
            // Add method-based insights
            if (prediction.method.includes('frequency')) {
                insights.push('‚Ä¢ Using frequency analysis');
            }
            if (prediction.method.includes('transition')) {
                insights.push('‚Ä¢ Analyzing digit transitions');
            }
            if (prediction.method.includes('pattern')) {
                insights.push('‚Ä¢ Pattern recognition active');
            }
            if (prediction.method.includes('gap')) {
                insights.push('‚Ä¢ Gap analysis applied');
            }
            
            // Add confidence-based insight
            if (prediction.confidence > 0.7) {
                insights.push('‚Ä¢ High confidence prediction');
            } else if (prediction.confidence > 0.4) {
                insights.push('‚Ä¢ Moderate confidence');
            } else {
                insights.push('‚Ä¢ Low confidence - use caution');
            }
            
            // Add accuracy insight
            const accuracy = window.aiEngine.getRecentPerformance() * 100;
            if (accuracy > 60) {
                insights.push(`‚Ä¢ Recent accuracy: ${accuracy.toFixed(1)}%`);
            }
            
            // Add win streak insight if applicable
            if (window.consecutiveLosses > 0) {
                insights.push(`‚Ä¢ Current loss streak: ${window.consecutiveLosses}`);
            }
            
            container.innerHTML = insights.map(insight => `<div class="mb-1">${insight}</div>`).join('');
        }
        
        // ============================================================================
        // ENHANCED MODE MANAGEMENT
        // ============================================================================
        
        function switchMode(mode) {
            sessionState.mode = mode;
            
            // Reset button styles
            document.getElementById('mode_instant').classList.remove('bg-green-600', 'bg-blue-600', 'bg-pink-600');
            document.getElementById('mode_smart').classList.remove('bg-green-600', 'bg-blue-600', 'bg-pink-600');
            document.getElementById('mode_ai').classList.remove('bg-green-600', 'bg-blue-600', 'bg-pink-600');
            
            // Set active button style
            if (mode === 'instant') {
                document.getElementById('mode_instant').classList.add('bg-green-600');
                document.getElementById('mode_smart').classList.add('bg-blue-600');
                document.getElementById('mode_ai').classList.add('bg-pink-600');
                document.getElementById('mode_description').textContent = '‚ö° INSTANT: Trade on each tick';
                log('üîÑ Switched to INSTANT mode', 'SYSTEM');
                window.nextTradeAllowed = true;
                
                if (window.isBotRunning && !sessionState.manualOverride) {
                    const manualDigit = parseInt(document.getElementById('predictedDigit').value);
                    if (!isNaN(manualDigit) && manualDigit >= 0 && manualDigit <= 9) {
                        sessionState.sessionDigit = manualDigit;
                        sessionState.sessionStarted = true;
                        sessionState.manualOverride = true;
                        updateSessionDisplay();
                        updatePredictionBox();
                        log(`üîí Digit ${manualDigit} set manually for instant mode`, 'SESSION');
                    }
                }
            } else if (mode === 'smart') {
                document.getElementById('mode_smart').classList.add('bg-green-600');
                document.getElementById('mode_instant').classList.add('bg-blue-600');
                document.getElementById('mode_ai').classList.add('bg-pink-600');
                document.getElementById('mode_description').textContent = 'üß† SMART: Analyze first, then trade';
                log('üîÑ Switched to SMART mode', 'SYSTEM');
                
                if (sessionState.sessionDigit !== null) {
                    log(`üîí Using locked digit ${sessionState.sessionDigit}`, 'SESSION');
                    updateExecutionLogic();
                } else {
                    updateExecutionLogic();
                }
            } else if (mode === 'ai') {
                document.getElementById('mode_ai').classList.add('bg-green-600');
                document.getElementById('mode_instant').classList.add('bg-blue-600');
                document.getElementById('mode_smart').classList.add('bg-blue-600');
                document.getElementById('mode_description').textContent = 'ü§ñ AI MODE: Neural network prediction';
                log('üîÑ Switched to AI mode', 'AI');
                
                // Enable AI if not already enabled
                if (!window.aiEngine.isEnabled) {
                    window.aiEngine.enable();
                    document.getElementById('aiToggleBtn').textContent = 'ü§ñ AI ON';
                    document.getElementById('aiToggleBtn').className = 'px-4 py-2 bg-green-600 text-white font-bold rounded-lg shadow hover:bg-green-700 transition';
                    document.getElementById('ai-badge').classList.remove('hidden');
                    document.getElementById('ai-prediction-panel').classList.remove('hidden');
                }
                
                updateExecutionLogic();
            }
        }
        
        // ============================================================================
        // ENHANCED TRADE EXECUTION WITH AI SUPPORT
        // ============================================================================
        
        // Override executeTrade to include AI tracking
        const originalExecuteTrade = window.executeTrade;
        window.executeTrade = function(tick) {
            // Record AI prediction before trade
            if (window.aiEngine.isEnabled && window.aiEngine.lastPrediction) {
                sessionState.lastAIPrediction = window.aiEngine.lastPrediction;
            }
            
            return originalExecuteTrade(tick);
        };
        
        // Override checkForImmediateWin to record AI outcomes
        const originalCheckForImmediateWin = window.checkForImmediateWin;
        window.checkForImmediateWin = function(tick) {
            const result = originalCheckForImmediateWin(tick);
            
            if (result) {
                // Record AI outcome if available
                if (sessionState.lastAIPrediction) {
                    const tickDigit = parseInt(tick.digit);
                    const wasWin = sessionState.lastAIPrediction.digit === tickDigit;
                    const accuracy = window.aiEngine.recordOutcome(
                        sessionState.lastAIPrediction.digit,
                        tickDigit,
                        wasWin
                    );
                    
                    log(`üìä AI recorded ${wasWin ? 'WIN' : 'LOSS'}. Accuracy: ${(accuracy * 100).toFixed(1)}%`, 'AI');
                    
                    // Update AI accuracy display
                    document.getElementById('ai-accuracy').textContent = `${(accuracy * 100).toFixed(1)}%`;
                    document.getElementById('ai-accuracy-short').textContent = `${(accuracy * 100).toFixed(1)}%`;
                }
            }
            
            return result;
        };
        
        // ============================================================================
        // ENHANCED UI UPDATES
        // ============================================================================
        
        // Update updatePredictionBox to show AI predictions
        function updatePredictionBox() {
            const box = document.getElementById('prediction_box');
            
            // Check if we have AI prediction
            const aiPrediction = window.aiEngine.isEnabled && window.aiEngine.lastPrediction;
            
            if (aiPrediction && sessionState.mode === 'ai') {
                // Show AI-enhanced prediction
                const confidencePercent = Math.round(aiPrediction.confidence * 100);
                const confidenceClass = aiPrediction.confidence >= 0.7 ? 'ai-high-confidence' :
                                      aiPrediction.confidence >= 0.4 ? 'ai-medium-confidence' : 'ai-low-confidence';
                
                box.innerHTML = `
                    <div class="text-cyan-300 font-bold mb-1">ü§ñ AI Prediction:</div>
                    <div class="flex items-center justify-between mb-2">
                        <div class="text-xl font-bold text-green-400">${suggestedDigit}</div>
                        <div class="text-xs ${confidenceClass} px-2 py-1 rounded-full">
                            ${confidencePercent}%
                        </div>
                    </div>
                    <div class="text-xs text-gray-300 mb-1">Method: ${aiPrediction.method.replace(/_/g, ' ')}</div>
                    <div class="text-xs text-gray-400">Neural Network Analysis</div>
                `;
                
                box.classList.add('analysis-complete');
                box.classList.remove('ai-high-confidence', 'ai-medium-confidence', 'ai-low-confidence');
                box.classList.add(confidenceClass);
            } else if (suggestedDigit !== null) {
                // Traditional prediction
                box.innerHTML = `
                    <div class="text-cyan-300 font-bold mb-1">Prediction:</div>
                    <div class="text-xl font-bold mb-2 text-center text-green-400">${suggestedDigit}</div>
                    <div class="text-xs text-gray-300">Based on ${analysisWindowSize} market ticks</div>
                `;
                box.classList.add('analysis-complete');
            } else if (sessionState.sessionDigit !== null) {
                box.innerHTML = `
                    <div class="text-cyan-300 font-bold mb-1">Session Digit:</div>
                    <div class="text-xl font-bold mb-2 text-center session-digit-locked px-3 py-1 rounded-lg">${sessionState.sessionDigit}</div>
                    <div class="text-xs text-gray-300">Locked for current session</div>
                `;
                box.classList.add('analysis-complete');
            }
        }
        
        // Update updateSessionDisplay to show AI mode
        const originalUpdateSessionDisplay = window.updateSessionDisplay;
        window.updateSessionDisplay = function() {
            originalUpdateSessionDisplay();
            
            if (sessionState.sessionStarted && sessionState.sessionDigit !== null) {
                document.getElementById('session_mode').textContent = 
                    sessionState.mode === 'ai' ? 'AI MODE' : sessionState.mode.toUpperCase();
            }
        };
        
        // Add win rate calculation
        function updateWinRate() {
            const totalTrades = window.stats.wins + window.stats.losses;
            if (totalTrades > 0) {
                const winRate = (window.stats.wins / totalTrades) * 100;
                document.getElementById('metricWinRate').textContent = `${winRate.toFixed(1)}%`;
                document.getElementById('metricWinRate').className = `text-lg font-bold ${
                    winRate >= 60 ? 'text-green-400' :
                    winRate >= 40 ? 'text-yellow-400' : 'text-red-400'
                }`;
            }
        }
        
        // Override updateStake to update win rate
        const originalUpdateStake = window.updateStake;
        window.updateStake = function(winOrLoss) {
            originalUpdateStake(winOrLoss);
            updateWinRate();
        };
        
        // ============================================================================
        // ENHANCED INITIALIZATION
        // ============================================================================
        
        // Update DOMContentLoaded to include AI initialization
        document.addEventListener('DOMContentLoaded', () => {
            console.log('ü§ñ Bot initialized with AI capabilities');
            initializeToggleState();
            
            if (!checkAuthToken()) {
                document.getElementById('prediction_text').textContent = 'Please authenticate first';
            }
            
            updateAnalysisUI('?');
            setInterval(calculateRates, 1000);
            startQueueProcessor();
            setInterval(updateLossStreakDisplay, 500);
            
            calculateMartingale();
            updateRecheckSettings();
            
            // Add event listeners for calculator sync
            document.getElementById('baseStake').addEventListener('change', syncCalculatorWithMain);
            document.getElementById('multiplier').addEventListener('change', syncCalculatorWithMain);
            document.getElementById('maxTrades').addEventListener('change', syncCalculatorWithMain);
            document.getElementById('calc_base_stake').addEventListener('change', () => {
                document.getElementById('baseStake').value = document.getElementById('calc_base_stake').value;
            });
            document.getElementById('calc_multiplier').addEventListener('change', () => {
                document.getElementById('multiplier').value = document.getElementById('calc_multiplier').value;
            });
            document.getElementById('calc_max_trades').addEventListener('change', () => {
                document.getElementById('maxTrades').value = document.getElementById('calc_max_trades').value;
            });
            
            document.getElementById('enableRecheck').addEventListener('change', updateRecheckSettings);
            document.getElementById('recheckThreshold').addEventListener('change', updateRecheckSettings);
            document.getElementById('maxDigitChanges').addEventListener('change', updateRecheckSettings);
            
            log('ü§ñ Bot ready', 'SYSTEM');
            log('ü§ñ AI Engine: Standby', 'AI');
            
            switchMode('instant');
            updatePnL();
            resetTradeStatus();
            updateWinRate();
            
            // Update account balance to green
            document.getElementById('metricAccountBalance').classList.add('account-balance-green');
            
            document.getElementById('predictedDigit').addEventListener('change', function() {
                const newDigit = parseInt(this.value);
                if (!isNaN(newDigit) && newDigit >= 0 && newDigit <= 9) {
                    if (sessionState.sessionStarted) {
                        const confirmChange = confirm('‚ö†Ô∏è Changing digit will reset current session. Continue?');
                        if (!confirmChange) {
                            this.value = sessionState.sessionDigit || 5;
                            return;
                        }
                    }
                    
                    sessionState.sessionDigit = newDigit;
                    sessionState.sessionStarted = true;
                    sessionState.manualOverride = true;
                    updateSessionDisplay();
                    updatePredictionBox();
                    log(`üî¢ Digit manually set to ${newDigit}`, 'SESSION');
                    updateTradeStatus('MANUAL', `Digit manually set to ${newDigit}`, 'Ready to trade', 'normal');
                }
            });
        });
        
        // Update resetAllState to include AI
        const originalResetAllState = window.resetAllState;
        window.resetAllState = function() {
            originalResetAllState();
            
            // Reset AI prediction panel
            document.getElementById('ai-prediction-output').classList.add('hidden');
            document.getElementById('ai-visualization').classList.add('hidden');
            
            // Reset AI metrics
            document.getElementById('ai-accuracy').textContent = '--%';
            document.getElementById('ai-prediction-count').textContent = '0';
            document.getElementById('ai-training-progress').style.width = '0%';
            document.getElementById('metricAIConfidence').textContent = '--%';
            
            log('üîÑ AI system reset', 'AI');
        };
        
        // Make sure to update the analysis window size
        analysisWindowSize = 20;
        document.getElementById('window_size').textContent = '20';
        document.getElementById('tick_window_input').value = '20';
    </script>
</body>
</html>
