<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Deriv DigitMatchStar Bot - LIVE MARKET</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <style>
        #log-area::-webkit-scrollbar { width: 4px; }
        #log-area::-webkit-scrollbar-thumb { background: #4ade80; border-radius: 2px; }
        #log-area::-webkit-scrollbar-track { background: #374151; }
        body { font-family: 'Inter', sans-serif; background-color: #111827; }
        @keyframes pulse-once { 0% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.03); opacity: 0.9; } 100% { transform: scale(1); opacity: 1; } }
        .tick-flash { animation: pulse-once 0.1s ease-out; }
        @keyframes win-pulse { 
            0% { 
                box-shadow: 0 0 5px #10B981, 0 0 10px rgba(16, 185, 129, 0.5); 
                border-color: #10B981;
            } 
            50% { 
                box-shadow: 0 0 20px #10B981, 0 0 30px rgba(16, 185, 129, 0.8); 
                border-color: #34d399;
            } 
            100% { 
                box-shadow: 0 0 5px #10B981, 0 0 10px rgba(16, 185, 129, 0.5); 
                border-color: #10B981;
            } 
        }
        .win-glow {
            animation: win-pulse 1s infinite;
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(16, 185, 129, 0.2)) !important;
        }
        .queue-digit { 
            width: 32px; 
            height: 32px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            border-radius: 50%; 
            font-weight: bold; 
            margin: 0 2px;
        }
        .contract-type-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: bold;
            margin-left: 5px;
        }
        .stop-button-active {
            background-color: #dc2626 !important;
            border: 2px solid #fca5a5 !important;
            animation: pulse-once 0.5s infinite;
        }
        .start-button-active {
            background-color: #16a34a !important;
            border: 2px solid #86efac !important;
            animation: pulse-once 0.5s;
        }
        .analysis-active {
            border: 2px solid #00ffea !important;
            box-shadow: 0 0 10px rgba(0, 255, 234, 0.3) !important;
        }
        .analysis-complete {
            border: 2px solid #10b981 !important;
            background-color: #064e3b20 !important;
        }
        .connection-badge-connected {
            background: linear-gradient(90deg, #10b981, #059669) !important;
        }
        .connection-badge-disconnected {
            background: linear-gradient(90deg, #dc2626, #b91c1c) !important;
        }
        .connection-badge-connecting {
            background: linear-gradient(90deg, #f59e0b, #d97706) !important;
        }
        /* Account Toggle */
        .account-toggle-container {
            display: inline-flex;
            align-items: center;
            margin-left: 15px;
            background: rgba(0, 0, 0, 0.3);
            padding: 2px 10px;
            border-radius: 20px;
        }
        .account-toggle {
            position: relative;
            display: inline-block;
            width: 44px;
            height: 22px;
            margin: 0 8px;
        }
        .account-toggle input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .account-toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #1e40af;
            border-radius: 34px;
            transition: .4s;
        }
        .account-toggle-slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            border-radius: 50%;
            transition: .4s;
        }
        input:checked + .account-toggle-slider {
            background-color: #059669;
        }
        input:checked + .account-toggle-slider:before {
            transform: translateX(22px);
        }
        .account-label {
            font-size: 12px;
            font-weight: 600;
        }
        .account-label-demo {
            color: #3b82f6;
        }
        .account-label-real {
            color: #10b981;
        }
        .profit-positive {
            color: #10b981 !important;
        }
        .profit-negative {
            color: #ef4444 !important;
        }
        .profit-neutral {
            color: #d1d5db !important;
        }
        .session-digit-locked {
            background: linear-gradient(135deg, #1e3a8a, #1e40af) !important;
            border: 2px solid #3b82f6 !important;
            color: white !important;
        }
        .status-win {
            color: #10b981 !important;
            font-weight: bold !important;
        }
        .status-loss {
            color: #ef4444 !important;
            font-weight: bold !important;
        }
        .status-trade {
            color: #f59e0b !important;
            font-weight: bold !important;
        }
        /* Calculator Styles */
        .calculator-highlight {
            background: linear-gradient(135deg, #7c3aed, #8b5cf6) !important;
            border: 1px solid #a78bfa !important;
            color: white !important;
        }
        .calculator-warning {
            background: linear-gradient(135deg, #dc2626, #ef4444) !important;
            border: 1px solid #f87171 !important;
            color: white !important;
        }
        .calculator-safe {
            background: linear-gradient(135deg, #059669, #10b981) !important;
            border: 1px solid #34d399 !important;
            color: white !important;
        }
        @keyframes calculator-pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.02); }
            100% { transform: scale(1); }
        }
        .calculator-pulse {
            animation: calculator-pulse 0.5s ease-out;
        }
        /* Recheck Badge */
        .recheck-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: bold;
            margin-left: 5px;
            background: linear-gradient(90deg, #8b5cf6, #7c3aed);
            color: white;
        }
        .loss-streak-high {
            color: #ef4444 !important;
            animation: pulse-once 0.5s infinite;
        }
        /* Pattern Badge */
        .pattern-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: bold;
            margin-left: 5px;
            background: linear-gradient(90deg, #ec4899, #db2777);
            color: white;
        }
        /* Confidence Bar */
        .confidence-bar {
            height: 6px;
            border-radius: 3px;
            background: linear-gradient(90deg, #ef4444, #f59e0b, #10b981);
            margin-top: 4px;
        }
        .confidence-fill {
            height: 100%;
            border-radius: 3px;
            background: linear-gradient(90deg, #10b981, #34d399);
            transition: width 0.3s ease;
        }
        /* Heatmap Digit */
        .heatmap-digit {
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            font-weight: bold;
            font-size: 12px;
            transition: all 0.3s ease;
        }
        .heatmap-high {
            background: linear-gradient(135deg, #ef4444, #dc2626) !important;
            color: white;
            transform: scale(1.1);
            box-shadow: 0 0 10px rgba(239, 68, 68, 0.5);
        }
        .heatmap-medium {
            background: linear-gradient(135deg, #f59e0b, #d97706) !important;
            color: white;
        }
        .heatmap-low {
            background: linear-gradient(135deg, #10b981, #059669) !important;
            color: white;
        }
        .heatmap-zero {
            background: linear-gradient(135deg, #1f2937, #374151) !important;
            color: #9ca3af;
        }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght400;600;700&display=swap" rel="stylesheet">
</head>
<body class="min-h-screen p-4 sm:p-8 flex items-start justify-center">

    <div class="w-full max-w-6xl bg-gray-800 text-gray-100 shadow-2xl rounded-xl p-5 md:p-6">
        <div class="flex justify-between items-center mb-4">
            <h1 class="text-3xl font-extrabold text-green-400 border-b border-gray-700 pb-2">
                Deriv DigitMatchStar Bot 
                <span id="status-badge" class="ml-3 inline-flex items-center px-3 py-1 text-sm font-medium rounded-full connection-badge-disconnected text-white shadow-md">
                    üî¥ DISCONNECTED
                </span>
                <span id="contract-type-badge" class="contract-type-badge bg-purple-600 text-white">DIGITMATCH</span>
                <span id="recheck-badge" class="recheck-badge hidden">ADAPTIVE</span>
                <span id="pattern-badge" class="pattern-badge hidden">AI POWERED</span>
                <!-- Account toggle -->
                <div class="account-toggle-container ml-3">
                    <span class="account-label account-label-demo">DEMO</span>
                    <label class="account-toggle">
                        <input type="checkbox" id="accTypeToggle" onchange="switchAccount()">
                        <span class="account-toggle-slider"></span>
                    </label>
                    <span class="account-label account-label-real">REAL</span>
                </div>
            </h1>
            <div class="flex items-center space-x-2">
                <button id="soundToggle" onclick="toggleSound()" 
                    class="px-4 py-2 bg-blue-600 text-white font-bold rounded-lg shadow hover:bg-blue-700 transition">
                    üîä Sound ON
                </button>
            </div>
        </div>
        
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
            <!-- LEFT COLUMN: SMART ANALYSIS ENGINE -->
            <div class="lg:col-span-1">
                <div class="bg-gray-900 border border-gray-700 rounded-xl p-4 shadow-lg analysis-settings-container">
                    <h2 class="text-lg font-bold text-cyan-400 mb-4 pb-2 border-b border-gray-700">
                        üß† SMART DIGIT ANALYSIS
                    </h2>
                    
                    <!-- Connection Status -->
                    <div class="mb-4 p-3 bg-gray-800 rounded-lg border border-gray-600">
                        <h3 class="text-sm font-bold text-gray-300 mb-2">Market Status</h3>
                        <div class="grid grid-cols-2 gap-2 text-xs">
                            <div>
                                <span class="text-gray-400">Connection:</span>
                                <span id="market_status" class="ml-2 font-bold text-red-400">Offline</span>
                            </div>
                            <div>
                                <span class="text-gray-400">Symbol:</span>
                                <span id="current_symbol" class="ml-2 font-bold text-cyan-400">V. 10 Index</span>
                            </div>
                            <div>
                                <span class="text-gray-400">Ticks Received:</span>
                                <span id="ticks_received" class="ml-2 font-bold text-green-400">0</span>
                            </div>
                            <div>
                                <span class="text-gray-400">Tick Rate:</span>
                                <span id="current_tick_rate" class="ml-2 font-bold text-blue-400">0/s</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Advanced Analysis Engine -->
                    <div class="mb-4 p-3 bg-gray-800 rounded-lg border border-purple-500/30">
                        <h3 class="text-sm font-bold text-purple-300 mb-3">ü¶æ AI Analysis Engine</h3>
                        
                        <div class="mb-3">
                            <label class="block text-xs font-semibold text-gray-300 mb-1">Analysis Intelligence Level</label>
                            <div class="flex gap-2">
                                <button id="aiLevel1" onclick="setAILevel(1)" class="flex-1 px-2 py-1.5 bg-purple-600 text-white font-bold rounded-md hover:bg-purple-700 transition text-xs">
                                    BASIC
                                </button>
                                <button id="aiLevel2" onclick="setAILevel(2)" class="flex-1 px-2 py-1.5 bg-gray-700 text-white font-bold rounded-md hover:bg-gray-600 transition text-xs">
                                    ADVANCED
                                </button>
                                <button id="aiLevel3" onclick="setAILevel(3)" class="flex-1 px-2 py-1.5 bg-gray-700 text-white font-bold rounded-md hover:bg-gray-600 transition text-xs">
                                    EXPERT
                                </button>
                            </div>
                            <p class="text-xs text-gray-400 mt-1">Higher levels = better prediction but slower analysis</p>
                        </div>
                        
                        <div class="mb-3">
                            <label class="block text-xs font-semibold text-gray-300 mb-1">Pattern Recognition</label>
                            <div class="flex items-center gap-2">
                                <input type="checkbox" id="enablePatternRecognition" checked 
                                    class="rounded bg-gray-700 border-gray-600 text-purple-600 focus:ring-purple-500">
                                <label for="enablePatternRecognition" class="text-xs text-gray-300">Enable pattern detection</label>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="block text-xs font-semibold text-gray-300 mb-1">Trend Analysis</label>
                            <div class="flex items-center gap-2">
                                <input type="checkbox" id="enableTrendAnalysis" checked 
                                    class="rounded bg-gray-700 border-gray-600 text-purple-600 focus:ring-purple-500">
                                <label for="enableTrendAnalysis" class="text-xs text-gray-300">Enable trend prediction</label>
                            </div>
                        </div>
                        
                        <!-- Confidence Display -->
                        <div class="mt-3 p-2 bg-gray-900 rounded border border-cyan-500/30">
                            <div class="flex justify-between text-xs mb-1">
                                <span class="text-cyan-300">Prediction Confidence</span>
                                <span id="confidence_percent" class="font-bold text-green-400">0%</span>
                            </div>
                            <div class="confidence-bar">
                                <div id="confidence_fill" class="confidence-fill" style="width: 0%"></div>
                            </div>
                            <div class="text-[10px] text-gray-400 mt-1 text-center">
                                <span id="confidence_text">No analysis yet</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Smart Predictor Settings -->
                    <div class="mb-4 p-3 bg-gray-800 rounded-lg border border-cyan-500/30">
                        <h3 class="text-sm font-bold text-cyan-300 mb-3">Analysis Settings</h3>
                        
                        <div class="mb-3">
                            <label class="block text-xs font-semibold text-gray-300 mb-1">Analysis Window</label>
                            <div class="flex items-center gap-2">
                                <input type="number" id="tick_window_input" value="25" min="3" max="100" 
                                    class="flex-1 rounded-md bg-gray-700 border border-gray-600 text-white shadow-sm focus:border-cyan-500 focus:ring-cyan-500 py-1.5 px-2 text-sm">
                                <button id="apply_tick_window" 
                                    class="px-3 py-1.5 bg-cyan-600 text-white font-bold rounded-md hover:bg-cyan-700 transition text-sm">
                                    Apply
                                </button>
                            </div>
                            <p class="text-xs text-gray-400 mt-1">Analyze last N ticks for digit patterns</p>
                        </div>
                        
                        <div id="tick_progress" class="mb-4 p-3 bg-gray-900 rounded text-center border border-gray-700">
                            <div class="text-cyan-400 font-bold mb-1">‚è≥ Waiting for Connection</div>
                            <div class="text-2xl font-bold mb-1">
                                <span id="tick_counter">0</span> / <span id="window_size">25</span>
                            </div>
                            <div class="w-full bg-gray-700 rounded-full h-3 mb-2">
                                <div id="tick_progress_bar" class="bg-cyan-600 h-3 rounded-full" style="width: 0%"></div>
                            </div>
                            <div class="text-xs text-gray-400">
                                <span id="analysis_status">Start bot to begin</span>
                            </div>
                        </div>
                        
                        <!-- Heatmap Display -->
                        <div class="mb-4 p-3 bg-gray-800 rounded border border-purple-500/50">
                            <h4 class="text-xs font-bold text-purple-300 mb-2">Digit Frequency Heatmap</h4>
                            <div class="grid grid-cols-5 gap-1">
                                <!-- Digits 0-4 -->
                                <div class="heatmap-digit heatmap-zero" id="heatmap-0">0</div>
                                <div class="heatmap-digit heatmap-zero" id="heatmap-1">1</div>
                                <div class="heatmap-digit heatmap-zero" id="heatmap-2">2</div>
                                <div class="heatmap-digit heatmap-zero" id="heatmap-3">3</div>
                                <div class="heatmap-digit heatmap-zero" id="heatmap-4">4</div>
                                <!-- Digits 5-9 -->
                                <div class="heatmap-digit heatmap-zero" id="heatmap-5">5</div>
                                <div class="heatmap-digit heatmap-zero" id="heatmap-6">6</div>
                                <div class="heatmap-digit heatmap-zero" id="heatmap-7">7</div>
                                <div class="heatmap-digit heatmap-zero" id="heatmap-8">8</div>
                                <div class="heatmap-digit heatmap-zero" id="heatmap-9">9</div>
                            </div>
                            <div class="flex justify-between text-[10px] text-gray-400 mt-2">
                                <span>Rare</span>
                                <span>Common</span>
                            </div>
                        </div>
                        
                        <div id="prediction_box" class="p-3 bg-gray-800 rounded border border-cyan-500/50 text-sm">
                            <div class="text-cyan-300 font-bold mb-1">Prediction Analysis:</div>
                            <div class="text-gray-300" id="prediction_text">Connect to market first</div>
                            <div id="pattern_info" class="text-xs text-purple-300 mt-1 hidden"></div>
                        </div>
                        
                        <!-- Session Status Display -->
                        <div id="session_display" class="mt-4 p-3 bg-gray-800 rounded border border-blue-500/30 hidden">
                            <h3 class="text-sm font-bold text-blue-300 mb-2">Active Session</h3>
                            <div class="flex items-center justify-between">
                                <div>
                                    <div class="text-xs text-gray-300">Digit:</div>
                                    <div id="session_digit" class="text-xl font-bold text-green-400">-</div>
                                </div>
                                <div>
                                    <div class="text-xs text-gray-300">Confidence:</div>
                                    <div id="session_confidence" class="text-sm font-bold text-cyan-400">-</div>
                                </div>
                                <div>
                                    <div class="text-xs text-gray-300">Trades:</div>
                                    <div id="session_trades" class="text-sm font-bold text-yellow-400">0/10</div>
                                </div>
                            </div>
                            <button id="new_analysis_btn" onclick="startNewAnalysis()" 
                                class="mt-2 w-full px-3 py-1.5 bg-purple-600 text-white font-bold rounded-md hover:bg-purple-700 transition text-sm">
                                üîÑ Run New Analysis
                            </button>
                        </div>
                    </div>
                    
                    <!-- Adaptive Recheck Settings -->
                    <div class="mt-4 p-3 bg-gray-800 rounded-lg border border-purple-500/30">
                        <h3 class="text-sm font-bold text-purple-300 mb-3">Adaptive Strategy</h3>
                        
                        <div class="mb-3">
                            <label class="block text-xs font-semibold text-gray-300 mb-1">
                                Recheck after consecutive losses:
                            </label>
                            <div class="flex items-center gap-2">
                                <input type="number" id="recheckThreshold" value="5" min="2" max="20" 
                                    class="flex-1 rounded-md bg-gray-700 border border-gray-600 text-white shadow-sm focus:border-purple-500 focus:ring-purple-500 py-1.5 px-2 text-sm">
                                <button onclick="updateRecheckSettings()" 
                                    class="px-3 py-1.5 bg-purple-600 text-white font-bold rounded-md hover:bg-purple-700 transition text-sm">
                                    Update
                                </button>
                            </div>
                            <p class="text-xs text-gray-400 mt-1">Reanalyze and adjust digit after X consecutive losses</p>
                        </div>
                        
                        <div class="flex items-center mb-2">
                            <input type="checkbox" id="enableRecheck" checked 
                                class="rounded bg-gray-700 border-gray-600 text-purple-600 focus:ring-purple-500">
                            <label for="enableRecheck" class="ml-2 text-xs text-gray-300">Enable adaptive reanalysis</label>
                        </div>
                        
                        <div class="text-xs text-gray-400 mb-2">
                            Max digit changes per session: 
                            <input type="number" id="maxDigitChanges" value="3" min="1" max="10" 
                                class="ml-2 w-12 rounded-md bg-gray-700 border border-gray-600 text-white text-center py-0.5 px-1">
                        </div>
                        
                        <div class="text-xs text-gray-400 mt-2 pt-2 border-t border-gray-700">
                            <div class="flex justify-between">
                                <span>Current loss streak:</span>
                                <span id="currentLossStreak" class="font-bold text-gray-300">0</span>
                            </div>
                            <div class="flex justify-between mt-1">
                                <span>Digit changes this session:</span>
                                <span id="digitChangesCount" class="font-bold text-gray-300">0</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- MIDDLE COLUMN: MAIN CONTROLS -->
            <div class="lg:col-span-2">
                <!-- MARTINGALE CALCULATOR -->
                <div class="mb-6 p-4 bg-gray-900 rounded-xl border border-purple-500/50 shadow-lg">
                    <h2 class="text-lg font-bold text-purple-400 mb-3 pb-2 border-b border-gray-700 flex items-center">
                        üßÆ MARTINGALE CALCULATOR
                        <button onclick="toggleCalculator()" class="ml-auto text-xs bg-gray-700 hover:bg-gray-600 px-2 py-1 rounded">
                            <span id="calcToggleIcon">‚àí</span>
                        </button>
                    </h2>
                    
                    <div id="calculatorContent" class="transition-all duration-300">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <!-- Left Column: Inputs -->
                            <div class="space-y-3">
                                <div>
                                    <label class="block text-xs font-semibold text-gray-300 mb-1">Base Stake ($)</label>
                                    <input type="number" id="calc_base_stake" value="1.0" min="0.1" step="0.1" 
                                        class="w-full rounded-md bg-gray-700 border border-gray-600 text-white shadow-sm focus:border-purple-500 focus:ring-purple-500 py-1.5 px-2 text-sm calculator-highlight">
                                </div>
                                
                                <div>
                                    <label class="block text-xs font-semibold text-gray-300 mb-1">Multiplier</label>
                                    <input type="number" id="calc_multiplier" value="1.15" min="1.0" step="0.01" 
                                        class="w-full rounded-md bg-gray-700 border border-gray-600 text-white shadow-sm focus:border-purple-500 focus:ring-purple-500 py-1.5 px-2 text-sm">
                                </div>
                                
                                <div>
                                    <label class="block text-xs font-semibold text-gray-300 mb-1">Max Trades</label>
                                    <input type="number" id="calc_max_trades" value="10" min="1" max="100" 
                                        class="w-full rounded-md bg-gray-700 border border-gray-600 text-white shadow-sm focus:border-purple-500 focus:ring-purple-500 py-1.5 px-2 text-sm">
                                </div>
                                
                                <div>
                                    <label class="block text-xs font-semibold text-gray-300 mb-1">Bankroll Limit ($)</label>
                                    <input type="number" id="calc_bankroll_limit" value="50.0" min="1.0" step="0.1" 
                                        class="w-full rounded-md bg-gray-700 border border-gray-600 text-white shadow-sm focus:border-purple-500 focus:ring-purple-500 py-1.5 px-2 text-sm">
                                </div>
                                
                                <button onclick="calculateMartingale()" 
                                    class="w-full mt-2 px-4 py-2 bg-purple-600 text-white font-bold rounded-lg hover:bg-purple-700 transition">
                                    üßÆ CALCULATE
                                </button>
                            </div>
                            
                            <!-- Right Column: Results -->
                            <div class="space-y-3">
                                <div class="p-3 bg-gray-800 rounded-lg border border-green-500/50">
                                    <div class="text-xs font-semibold text-green-400 mb-1">Total Required</div>
                                    <div id="calc_total_required" class="text-xl font-bold text-white">$0.00</div>
                                    <div class="text-xs text-gray-400 mt-1">For all trades</div>
                                </div>
                                
                                <div class="p-3 bg-gray-800 rounded-lg border border-blue-500/50">
                                    <div class="text-xs font-semibold text-blue-400 mb-1">Final Stake</div>
                                    <div id="calc_final_stake" class="text-lg font-bold text-white">$0.00</div>
                                    <div class="text-xs text-gray-400 mt-1">Last trade amount</div>
                                </div>
                                
                                <div class="p-3 bg-gray-800 rounded-lg border border-yellow-500/50">
                                    <div class="text-xs font-semibold text-yellow-400 mb-1">Bankroll Status</div>
                                    <div id="calc_bankroll_status" class="text-lg font-bold text-white">-</div>
                                    <div class="text-xs text-gray-400 mt-1">vs. your limit</div>
                                </div>
                                
                                <div class="p-3 bg-gray-800 rounded-lg border border-cyan-500/50">
                                    <div class="text-xs font-semibold text-cyan-400 mb-1">Profit on Win</div>
                                    <div id="calc_profit_on_win" class="text-lg font-bold text-white">$0.00</div>
                                    <div class="text-xs text-gray-400 mt-1">9x payout minus investment</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Stake Progression Table -->
                        <div class="mt-4">
                            <div class="text-xs font-semibold text-gray-300 mb-2">Stake Progression</div>
                            <div id="calc_progression" class="text-xs text-gray-400 italic">Click CALCULATE to see stake progression</div>
                        </div>
                    </div>
                </div>
                
                <!-- Main Trading Controls -->
                <div class="grid grid-cols-2 lg:grid-cols-3 gap-3 mb-6">
                    <!-- Symbol -->
                    <div>
                        <label for="symbol" class="block text-xs font-semibold text-gray-300 mb-1">Symbol</label>
                        <select id="symbol" class="block w-full rounded-md bg-gray-700 border border-gray-600 text-white shadow-sm focus:border-green-500 focus:ring-green-500 py-1.5 px-2 text-sm">
                            <option value="R_10">V. 10 Index</option>
                            <option value="R_100">V. 100 Index</option>
                            <option value="R_25">V. 25 Index</option>
                            <option value="R_50">V. 50 Index</option>
                            <option value="R_75">V. 75 Index</option>
                        </select>
                    </div>
                    
                    <!-- Predicted Digit -->
                    <div>
                        <label for="predictedDigit" class="block text-xs font-semibold text-gray-300 mb-1">Predicted Digit</label>
                        <input type="number" id="predictedDigit" value="5" min="0" max="9" 
                            class="block w-full rounded-md bg-gray-700 border border-gray-600 text-white shadow-sm focus:border-green-500 focus:ring-green-500 py-1.5 px-2 text-sm text-center">
                    </div>

                    <!-- Contract Type -->
                    <div>
                        <label for="contractType" class="block text-xs font-semibold text-gray-300 mb-1">Contract Type</label>
                        <select id="contractType" class="block w-full rounded-md bg-gray-700 border border-gray-600 text-white shadow-sm focus:border-green-500 focus:ring-green-500 py-1.5 px-2 text-sm">
                            <option value="DIGITMATCH">DIGITMATCH</option>
                        </select>
                    </div>

                    <!-- Base Stake -->
                    <div>
                        <label for="baseStake" class="block text-xs font-semibold text-gray-300 mb-1">Base Stake</label>
                        <input type="number" id="baseStake" value="1.0" min="0.1" step="0.1" 
                            class="block w-full rounded-md bg-gray-700 border border-gray-600 text-white shadow-sm focus:border-green-500 focus:ring-green-500 py-1.5 px-2 text-sm">
                    </div>

                    <!-- Multiplier -->
                    <div>
                        <label for="multiplier" class="block text-xs font-semibold text-gray-300 mb-1">Multiplier</label>
                        <input type="number" id="multiplier" value="1.15" min="1.0" step="0.01" 
                            class="block w-full rounded-md bg-gray-700 border border-gray-600 text-white shadow-sm focus:border-green-500 focus:ring-green-500 py-1.5 px-2 text-sm">
                    </div>

                    <!-- Max Trades -->
                    <div>
                        <label for="maxTrades" class="block text-xs font-semibold text-gray-300 mb-1">Max Trades</label>
                        <input type="number" id="maxTrades" value="10" min="1" max="100" 
                            class="block w-full rounded-md bg-gray-700 border border-gray-600 text-white shadow-sm focus:border-green-500 focus:ring-green-500 py-1.5 px-2 text-sm">
                    </div>
                    
                    <!-- Mode Toggle -->
                    <div class="col-span-2 lg:col-span-3">
                        <label class="block text-xs font-semibold text-gray-300 mb-1">Execution Mode</label>
                        <div class="grid grid-cols-2 gap-2">
                            <button id="mode_instant" onclick="switchMode('instant')" 
                                class="px-4 py-2 bg-green-600 text-white font-bold rounded-lg hover:bg-green-700 transition">
                                ‚ö° INSTANT
                            </button>
                            <button id="mode_smart" onclick="switchMode('smart')" 
                                class="px-4 py-2 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 transition">
                                üß† SMART
                            </button>
                        </div>
                        <p id="mode_description" class="text-xs text-gray-400 mt-1">
                            ‚ö° INSTANT: Trade on each tick
                        </p>
                    </div>
                </div>
                
                <!-- METRICS -->
                <div class="grid grid-cols-3 gap-3">
                    <div class="bg-gray-700 rounded-lg p-2 shadow-inner border border-green-500/50 col-span-2">
                        <p class="text-[10px] font-semibold text-green-500 uppercase">Current Tick</p>
                        <p id="metricLiveTick" class="text-xl font-extrabold text-white">---</p>
                        <p id="metricLastDigit" class="text-lg font-bold text-green-300">Digit: ?</p>
                        <p id="metricTickRate" class="text-xs font-bold text-blue-400">Ticks/sec: --</p>
                    </div>
                    
                    <div class="bg-gray-700 rounded-lg p-2 shadow-inner border border-purple-500/50">
                        <p class="text-[10px] font-semibold text-purple-500 uppercase">Balance</p>
                        <p id="metricAccountBalance" class="text-lg font-bold text-white">$---</p>
                    </div>
                    
                    <div class="bg-gray-700 rounded-lg p-2 shadow-inner">
                        <p class="text-[10px] font-semibold text-green-500 uppercase">Trade #</p>
                        <p id="metricTradeCount" class="text-lg font-bold text-white">0</p>
                    </div>
                    
                    <div class="bg-gray-700 rounded-lg p-2 shadow-inner">
                        <p class="text-[10px] font-semibold text-lime-400 uppercase">P/L</p>
                        <p id="metricTotalProfit" class="text-lg font-bold profit-neutral">$0.00</p>
                    </div>
                    
                    <div class="bg-gray-700 rounded-lg p-2 shadow-inner">
                        <p class="text-[10px] font-semibold text-green-500 uppercase">Stake</p>
                        <p id="metricCurrentStake" class="text-lg font-bold text-white">$0.00</p>
                    </div>
                    
                    <!-- TRADE STATUS SECTION - ONLY GLOW ON WINS -->
                    <div id="trade-result-container" class="bg-gray-900 rounded-lg p-3 shadow-inner border border-yellow-500/50 col-span-3">
                        <div class="flex justify-between items-center mb-2">
                            <p class="text-[10px] font-semibold text-yellow-500 uppercase">TRADE STATUS</p>
                            <p id="metricTradeResult" class="text-xs font-bold text-gray-400">READY</p>
                        </div>
                        <div class="mb-2">
                            <p class="text-[10px] font-semibold text-gray-400 uppercase mb-1">Status:</p>
                            <p id="metricPreviousResult" class="text-sm font-bold text-gray-300">Waiting for connection...</p>
                        </div>
                        <div>
                            <p class="text-[10px] font-semibold text-gray-400 uppercase mb-1">Action:</p>
                            <p id="metricNextAction" class="text-sm font-bold text-yellow-400">Start bot to begin</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- START/STOP BUTTON -->
        <div class="flex justify-center mb-5">
            <button id="toggleButton" onclick="toggleBot()" 
                class="w-full md:w-1/2 px-6 py-3 bg-green-600 text-white font-bold text-lg rounded-lg shadow-xl hover:bg-green-700 transition duration-150">
                üöÄ START BOT
            </button>
        </div>

        <!-- LOG AREA -->
        <div id="log-column" class="w-full flex flex-col">
            <h2 class="text-lg font-bold text-gray-300 mb-2 border-b border-gray-700 pb-1">Live Log</h2>
            <div id="log-area" class="flex-grow h-80 bg-gray-900 text-lime-400 p-2.5 rounded-lg overflow-y-scroll text-xs whitespace-pre-wrap shadow-inner">
[00:00:00] ü§ñ Deriv Bot Initialized
[00:00:00] üìä Ready to connect to live market
[00:00:00] üß† AI Analysis Engine Ready
[00:00:00] üîÑ Adaptive strategy enabled
            </div>
        </div>
    </div>

    <script>
        // ============================================================================
        // MARTINGALE CALCULATOR FUNCTIONS
        // ============================================================================
        
        let calculatorExpanded = true;
        
        function toggleCalculator() {
            calculatorExpanded = !calculatorExpanded;
            const calculatorContent = document.getElementById('calculatorContent');
            const toggleIcon = document.getElementById('calcToggleIcon');
            
            if (calculatorExpanded) {
                calculatorContent.classList.remove('hidden');
                toggleIcon.textContent = '‚àí';
            } else {
                calculatorContent.classList.add('hidden');
                toggleIcon.textContent = '+';
            }
        }
        
        function calculateMartingale() {
            try {
                const baseStake = parseFloat(document.getElementById('calc_base_stake').value) || 1.0;
                const multiplier = parseFloat(document.getElementById('calc_multiplier').value) || 1.15;
                const maxTrades = parseInt(document.getElementById('calc_max_trades').value) || 10;
                const bankrollLimit = parseFloat(document.getElementById('calc_bankroll_limit').value) || 50.0;
                
                if (baseStake <= 0 || multiplier <= 1.0 || maxTrades <= 0) {
                    alert('Please enter valid values for calculation.');
                    return;
                }
                
                let currentStake = baseStake;
                let totalRequired = 0;
                let progression = [];
                let finalStake = baseStake;
                
                // Calculate progression and totals
                for (let i = 1; i <= maxTrades; i++) {
                    if (i === 1) {
                        currentStake = baseStake;
                    } else {
                        currentStake *= multiplier;
                    }
                    
                    // Round to 2 decimal places
                    currentStake = Math.round(currentStake * 100) / 100;
                    totalRequired += currentStake;
                    finalStake = currentStake;
                    
                    progression.push({
                        trade: i,
                        stake: currentStake.toFixed(2),
                        cumulative: Math.round(totalRequired * 100) / 100
                    });
                }
                
                // Round total required
                totalRequired = Math.round(totalRequired * 100) / 100;
                
                // Calculate profit on win (DIGITMATCH pays 9x)
                const profitOnWin = (finalStake * 9) - totalRequired;
                
                // Update main bot controls with calculated values
                document.getElementById('baseStake').value = baseStake.toFixed(2);
                document.getElementById('multiplier').value = multiplier.toFixed(2);
                document.getElementById('maxTrades').value = maxTrades;
                
                // Update calculator results
                document.getElementById('calc_total_required').textContent = `$${totalRequired.toFixed(2)}`;
                document.getElementById('calc_final_stake').textContent = `$${finalStake.toFixed(2)}`;
                document.getElementById('calc_profit_on_win').textContent = `$${profitOnWin.toFixed(2)}`;
                
                // Update bankroll status
                const bankrollStatusElem = document.getElementById('calc_bankroll_status');
                bankrollStatusElem.classList.remove('calculator-safe', 'calculator-warning', 'calculator-highlight');
                
                if (totalRequired <= bankrollLimit) {
                    bankrollStatusElem.textContent = '‚úÖ Within Limit';
                    bankrollStatusElem.classList.add('calculator-safe');
                } else if (totalRequired <= bankrollLimit * 1.5) {
                    bankrollStatusElem.textContent = '‚ö†Ô∏è Close to Limit';
                    bankrollStatusElem.classList.add('calculator-warning');
                } else {
                    bankrollStatusElem.textContent = '‚ùå Over Limit';
                    bankrollStatusElem.classList.add('calculator-warning');
                }
                
                // Update progression display
                const progressionElem = document.getElementById('calc_progression');
                let progressionHTML = '<div class="grid grid-cols-4 gap-1 text-xs mb-1 font-semibold text-gray-300">';
                progressionHTML += '<div>Trade #</div><div>Stake</div><div>Cumulative</div><div>Status</div>';
                progressionHTML += '</div>';
                
                progression.forEach(item => {
                    const status = item.cumulative <= bankrollLimit ? '‚úÖ' : '‚ùå';
                    progressionHTML += `
                        <div class="grid grid-cols-4 gap-1 text-xs py-1 ${item.trade % 2 === 0 ? 'bg-gray-800/50' : ''}">
                            <div class="text-gray-300">${item.trade}</div>
                            <div class="text-green-400">$${item.stake}</div>
                            <div class="text-blue-400">$${item.cumulative.toFixed(2)}</div>
                            <div class="${status === '‚úÖ' ? 'text-green-400' : 'text-red-400'}">${status}</div>
                        </div>
                    `;
                });
                
                progressionElem.innerHTML = progressionHTML;
                
                // Add pulse animation
                document.getElementById('calc_total_required').classList.add('calculator-pulse');
                setTimeout(() => {
                    document.getElementById('calc_total_required').classList.remove('calculator-pulse');
                }, 500);
                
                log(`üßÆ Calculator: Total required: $${totalRequired.toFixed(2)} for ${maxTrades} trades`, 'CALCULATOR');
                
            } catch (error) {
                console.error('Calculator error:', error);
                alert('Error in calculation. Please check your inputs.');
            }
        }
        
        // Sync calculator with main controls
        function syncCalculatorWithMain() {
            const baseStake = parseFloat(document.getElementById('baseStake').value) || 1.0;
            const multiplier = parseFloat(document.getElementById('multiplier').value) || 1.15;
            const maxTrades = parseInt(document.getElementById('maxTrades').value) || 10;
            
            document.getElementById('calc_base_stake').value = baseStake.toFixed(2);
            document.getElementById('calc_multiplier').value = multiplier.toFixed(2);
            document.getElementById('calc_max_trades').value = maxTrades;
            
            // Auto-calculate when main controls change
            calculateMartingale();
        }
        
        // ============================================================================
        // INITIALIZATION
        // ============================================================================
        
        // Global State
        window.ws = null;
        window.req_id = 0;
        window.isBotRunning = false;
        window.isConnecting = false;
        window.soundEnabled = true;
        window.ToneInitialized = false;
        window.synth = null;
        
        // Trading State
        window.baseStake = 1.0;
        window.currentStake = 1.0;
        window.multiplier = 1.15;
        window.maxTrades = 10;
        window.tradeCount = 0;
        window.martingaleStep = 0;
        window.accountBalance = 0.0;
        window.startingBalance = 0.0;
        window.currentBalance = 0.0;
        window.netProfit = 0.0;
        
        // PnL Tracking
        window.pnlTracker = {
            totalInvestment: 0.0,
            totalPayout: 0.0,
            netProfit: 0.0,
            trades: []
        };
        
        // Execution State
        window.lastTick = null;
        window.nextTradeAllowed = true;
        window.stopAfterWin = false;
        window.pendingProposals = new Map();
        window.executionLock = false;
        
        // Statistics
        window.stats = {
            totalTicks: 0,
            tradesExecuted: 0,
            wins: 0,
            losses: 0
        };
        
        // Rate tracking
        window.botTickTimestamps = [];
        
        // Queue - INCREASED SIZE FOR BETTER REANALYSIS
        window.tickQueue = [];
        window.maxQueueSize = 50; // Increased for better pattern recognition
        
        // Analysis Engine - UPGRADED
        let analysisDigits = [];
        let analysisWindowSize = 25; // Increased default window
        let analysisComplete = false;
        let suggestedDigit = null;
        let totalTicksReceived = 0;
        let lastTickTime = 0;
        let tickTimestamps = [];
        
        // Session State
        let sessionState = {
            active: false,
            mode: 'instant',
            sessionDigit: null,
            sessionStarted: false,
            manualOverride: false
        };
        
        // ============================================================================
        // ADVANCED AI ANALYSIS ENGINE
        // ============================================================================
        
        // AI Configuration
        window.aiLevel = 2; // 1=Basic, 2=Advanced, 3=Expert
        window.enablePatternRecognition = true;
        window.enableTrendAnalysis = true;
        window.predictionConfidence = 0;
        window.digitHistory = []; // Store last 100 digits for advanced analysis
        window.patternBuffer = []; // Buffer for pattern detection
        window.trendBuffer = []; // Buffer for trend analysis
        
        // Pattern Recognition
        window.patterns = {
            repeating: [], // e.g., [1,1,1]
            alternating: [], // e.g., [1,2,1,2]
            sequences: [], // e.g., [1,2,3,4]
            clusters: [] // e.g., digits appearing in groups
        };
        
        // Advanced Statistics
        window.advancedStats = {
            digitFrequency: Array(10).fill(0),
            lastAppearance: Array(10).fill(-1),
            streakCount: Array(10).fill(0),
            patternMatches: 0,
            trendStrength: 0
        };
        
        // ============================================================================
        // AI ANALYSIS FUNCTIONS
        // ============================================================================
        
        function setAILevel(level) {
            window.aiLevel = level;
            
            // Update button styles
            for (let i = 1; i <= 3; i++) {
                const btn = document.getElementById(`aiLevel${i}`);
                if (i === level) {
                    btn.classList.remove('bg-gray-700');
                    btn.classList.add('bg-purple-600');
                } else {
                    btn.classList.remove('bg-purple-600');
                    btn.classList.add('bg-gray-700');
                }
            }
            
            // Update analysis parameters based on level
            switch(level) {
                case 1: // Basic
                    analysisWindowSize = 15;
                    window.patternBuffer = [];
                    log(`‚öôÔ∏è AI Level: BASIC - Fast analysis with basic patterns`, 'AI');
                    break;
                case 2: // Advanced
                    analysisWindowSize = 25;
                    window.patternBuffer = new Array(20);
                    log(`‚öôÔ∏è AI Level: ADVANCED - Pattern recognition enabled`, 'AI');
                    break;
                case 3: // Expert
                    analysisWindowSize = 35;
                    window.patternBuffer = new Array(30);
                    window.trendBuffer = new Array(25);
                    log(`‚öôÔ∏è AI Level: EXPERT - Advanced pattern & trend analysis`, 'AI');
                    break;
            }
            
            document.getElementById('tick_window_input').value = analysisWindowSize;
            document.getElementById('window_size').textContent = analysisWindowSize;
            updateAnalysisUI('?');
            
            // Show pattern badge for advanced levels
            const badge = document.getElementById('pattern-badge');
            if (level >= 2) {
                badge.classList.remove('hidden');
            } else {
                badge.classList.add('hidden');
            }
        }
        
        function updateHeatmap() {
            if (window.advancedStats.digitFrequency.length === 0) return;
            
            // Find max frequency for scaling
            const maxFreq = Math.max(...window.advancedStats.digitFrequency);
            if (maxFreq === 0) return;
            
            // Update each digit's heatmap
            for (let i = 0; i < 10; i++) {
                const elem = document.getElementById(`heatmap-${i}`);
                const freq = window.advancedStats.digitFrequency[i];
                const ratio = freq / maxFreq;
                
                // Remove all classes
                elem.classList.remove('heatmap-high', 'heatmap-medium', 'heatmap-low', 'heatmap-zero');
                
                // Add appropriate class based on frequency
                if (freq === 0) {
                    elem.classList.add('heatmap-zero');
                } else if (ratio > 0.7) {
                    elem.classList.add('heatmap-high');
                } else if (ratio > 0.3) {
                    elem.classList.add('heatmap-medium');
                } else {
                    elem.classList.add('heatmap-low');
                }
                
                // Add tooltip with frequency
                elem.title = `Digit ${i}: ${freq} occurrences`;
            }
        }
        
        function updateConfidenceDisplay(confidence, reason = '') {
            window.predictionConfidence = confidence;
            const percentElem = document.getElementById('confidence_percent');
            const fillElem = document.getElementById('confidence_fill');
            const textElem = document.getElementById('confidence_text');
            
            const percent = Math.round(confidence * 100);
            percentElem.textContent = `${percent}%`;
            fillElem.style.width = `${percent}%`;
            
            // Color based on confidence
            if (percent >= 70) {
                percentElem.className = 'font-bold text-green-400';
                fillElem.style.background = 'linear-gradient(90deg, #10b981, #34d399)';
            } else if (percent >= 40) {
                percentElem.className = 'font-bold text-yellow-400';
                fillElem.style.background = 'linear-gradient(90deg, #f59e0b, #d97706)';
            } else {
                percentElem.className = 'font-bold text-red-400';
                fillElem.style.background = 'linear-gradient(90deg, #ef4444, #dc2626)';
            }
            
            textElem.textContent = reason || getConfidenceText(percent);
        }
        
        function getConfidenceText(percent) {
            if (percent >= 80) return 'High confidence - Strong pattern detected';
            if (percent >= 60) return 'Good confidence - Pattern identified';
            if (percent >= 40) return 'Moderate confidence - Weak pattern';
            if (percent >= 20) return 'Low confidence - Limited data';
            return 'Very low confidence - Random prediction';
        }
        
        // ============================================================================
        // PATTERN RECOGNITION ALGORITHMS
        // ============================================================================
        
        function detectRepeatingPattern(digits) {
            // Detect repeating digits (e.g., 1,1,1 or 2,2,2)
            if (digits.length < 3) return null;
            
            const lastThree = digits.slice(-3);
            if (lastThree[0] === lastThree[1] && lastThree[1] === lastThree[2]) {
                return {
                    type: 'REPEATING',
                    digit: lastThree[0],
                    length: 3,
                    confidence: 0.85
                };
            }
            
            return null;
        }
        
        function detectAlternatingPattern(digits) {
            // Detect alternating digits (e.g., 1,2,1,2 or 3,7,3,7)
            if (digits.length < 4) return null;
            
            const lastFour = digits.slice(-4);
            if (lastFour[0] === lastFour[2] && lastFour[1] === lastFour[3] && lastFour[0] !== lastFour[1]) {
                return {
                    type: 'ALTERNATING',
                    digits: [lastFour[0], lastFour[1]],
                    confidence: 0.75
                };
            }
            
            return null;
        }
        
        function detectSequencePattern(digits) {
            // Detect ascending/descending sequences (e.g., 1,2,3,4 or 9,8,7,6)
            if (digits.length < 3) return null;
            
            const lastThree = digits.slice(-3);
            const diff1 = lastThree[1] - lastThree[0];
            const diff2 = lastThree[2] - lastThree[1];
            
            if (Math.abs(diff1) === 1 && diff1 === diff2) {
                const direction = diff1 > 0 ? 'ASCENDING' : 'DESCENDING';
                return {
                    type: 'SEQUENCE',
                    direction: direction,
                    nextDigit: lastThree[2] + diff1,
                    confidence: 0.70
                };
            }
            
            return null;
        }
        
        function detectMissingDigitPattern(digits) {
            // Find digits that haven't appeared recently
            const recentDigits = new Set(digits.slice(-10));
            const missing = [];
            
            for (let i = 0; i < 10; i++) {
                if (!recentDigits.has(i)) {
                    missing.push(i);
                }
            }
            
            if (missing.length > 0) {
                // Choose the digit missing for the longest time
                let longestMissing = missing[0];
                let maxMissingTime = window.advancedStats.lastAppearance[longestMissing];
                
                for (const digit of missing) {
                    if (window.advancedStats.lastAppearance[digit] > maxMissingTime) {
                        longestMissing = digit;
                        maxMissingTime = window.advancedStats.lastAppearance[digit];
                    }
                }
                
                return {
                    type: 'MISSING',
                    digit: longestMissing,
                    missingTime: maxMissingTime,
                    confidence: 0.65
                };
            }
            
            return null;
        }
        
        function detectFrequencyPattern(digits) {
            // Analyze frequency of each digit
            const freq = Array(10).fill(0);
            digits.forEach(d => freq[d]++);
            
            // Find least frequent digit
            let leastFrequent = 0;
            let minFreq = Infinity;
            for (let i = 0; i < 10; i++) {
                if (freq[i] < minFreq) {
                    minFreq = freq[i];
                    leastFrequent = i;
                }
            }
            
            return {
                type: 'LEAST_FREQUENT',
                digit: leastFrequent,
                frequency: minFreq,
                confidence: 0.60
            };
        }
        
        function detectStreakPattern(digits) {
            // Detect if a digit is on a streak (multiple appearances in short time)
            if (digits.length < 5) return null;
            
            const lastDigit = digits[digits.length - 1];
            const streak = window.advancedStats.streakCount[lastDigit];
            
            if (streak >= 2) {
                return {
                    type: 'STREAK',
                    digit: lastDigit,
                    streakLength: streak,
                    confidence: 0.55
                };
            }
            
            return null;
        }
        
        // ============================================================================
        // ADVANCED PREDICTION ENGINE
        // ============================================================================
        
        function performAdvancedAnalysis() {
            if (analysisDigits.length < analysisWindowSize) return null;
            
            const patterns = [];
            let totalConfidence = 0;
            
            // Run all pattern detectors
            if (window.enablePatternRecognition) {
                const repeating = detectRepeatingPattern(analysisDigits);
                if (repeating) {
                    patterns.push(repeating);
                    totalConfidence += repeating.confidence;
                }
                
                const alternating = detectAlternatingPattern(analysisDigits);
                if (alternating) {
                    patterns.push(alternating);
                    totalConfidence += alternating.confidence;
                }
                
                const sequence = detectSequencePattern(analysisDigits);
                if (sequence) {
                    patterns.push(sequence);
                    totalConfidence += sequence.confidence;
                }
            }
            
            const missing = detectMissingDigitPattern(analysisDigits);
            if (missing) {
                patterns.push(missing);
                totalConfidence += missing.confidence;
            }
            
            const frequency = detectFrequencyPattern(analysisDigits);
            if (frequency) {
                patterns.push(frequency);
                totalConfidence += frequency.confidence;
            }
            
            const streak = detectStreakPattern(analysisDigits);
            if (streak) {
                patterns.push(streak);
                totalConfidence += streak.confidence;
            }
            
            // If no patterns found, use basic analysis
            if (patterns.length === 0) {
                return performBasicAnalysis();
            }
            
            // Weight patterns by confidence and AI level
            const weightedPredictions = new Map();
            
            for (const pattern of patterns) {
                let weight = pattern.confidence;
                
                // Adjust weight based on AI level
                if (window.aiLevel === 3) weight *= 1.2;
                if (window.aiLevel === 1) weight *= 0.8;
                
                let predictedDigit;
                
                switch(pattern.type) {
                    case 'REPEATING':
                        predictedDigit = pattern.digit;
                        break;
                    case 'ALTERNATING':
                        // Predict the next digit in alternating pattern
                        const lastTwo = analysisDigits.slice(-2);
                        predictedDigit = lastTwo[0] === pattern.digits[0] ? pattern.digits[1] : pattern.digits[0];
                        break;
                    case 'SEQUENCE':
                        predictedDigit = pattern.nextDigit;
                        // Wrap around if out of bounds
                        if (predictedDigit < 0) predictedDigit = 9;
                        if (predictedDigit > 9) predictedDigit = 0;
                        break;
                    case 'MISSING':
                        predictedDigit = pattern.digit;
                        break;
                    case 'LEAST_FREQUENT':
                        predictedDigit = pattern.digit;
                        break;
                    case 'STREAK':
                        // Bet against the streak continuing
                        const alternatives = [];
                        for (let i = 0; i < 10; i++) {
                            if (i !== pattern.digit) alternatives.push(i);
                        }
                        predictedDigit = alternatives[Math.floor(Math.random() * alternatives.length)];
                        break;
                }
                
                if (predictedDigit !== undefined) {
                    const currentWeight = weightedPredictions.get(predictedDigit) || 0;
                    weightedPredictions.set(predictedDigit, currentWeight + weight);
                }
            }
            
            // Find digit with highest total weight
            let bestDigit = null;
            let bestWeight = -1;
            
            for (const [digit, weight] of weightedPredictions) {
                if (weight > bestWeight) {
                    bestWeight = weight;
                    bestDigit = digit;
                }
            }
            
            // Calculate overall confidence
            const avgConfidence = totalConfidence / patterns.length;
            const confidence = Math.min(0.95, avgConfidence * (1 + (window.aiLevel - 1) * 0.1));
            
            // Update pattern info display
            const patternInfo = document.getElementById('pattern_info');
            if (patterns.length > 0) {
                const mainPattern = patterns[0];
                patternInfo.textContent = `${mainPattern.type.replace('_', ' ').toLowerCase()} pattern detected`;
                patternInfo.classList.remove('hidden');
            }
            
            // Update confidence display
            const confidenceReason = patterns.length > 0 ? 
                `${patterns.length} pattern${patterns.length > 1 ? 's' : ''} detected` : 
                'Basic frequency analysis';
            
            updateConfidenceDisplay(confidence, confidenceReason);
            
            log(`üß† AI Analysis: ${patterns.length} pattern(s) detected ‚Üí Digit ${bestDigit} (${Math.round(confidence * 100)}% confidence)`, 'AI');
            
            return bestDigit;
        }
        
        function performBasicAnalysis() {
            // Original basic analysis logic
            const freq = Array(10).fill(0);
            analysisDigits.forEach(d => {
                if (d >= 0 && d <= 9) freq[d]++;
            });
            
            const missing = [];
            for (let i = 0; i < 10; i++) {
                if (freq[i] === 0) missing.push(i);
            }
            
            if (missing.length > 0) {
                const digit = missing[Math.floor(Math.random() * missing.length)];
                updateConfidenceDisplay(0.60, `Missing digit analysis`);
                return digit;
            }
            
            let leastFrequent = 0;
            let minFreq = Infinity;
            for (let i = 0; i < 10; i++) {
                if (freq[i] < minFreq) {
                    minFreq = freq[i];
                    leastFrequent = i;
                }
            }
            
            updateConfidenceDisplay(0.55, `Least frequent digit`);
            return leastFrequent;
        }
        
        // ============================================================================
        // IMPROVED ANALYSIS ENGINE
        // ============================================================================
        
        function processTickForAnalysis(tick) {
            try {
                const price = parseFloat(tick.quote);
                const symbol = document.getElementById('symbol').value;
                let decimalPlaces = 3;
                if (symbol === 'R_100') decimalPlaces = 2;
                const formattedPrice = price.toFixed(decimalPlaces);
                const digit = parseInt(formattedPrice.charAt(formattedPrice.length - 1), 10);
                
                if (isNaN(digit) || digit < 0 || digit > 9) return;
                
                totalTicksReceived++;
                lastTickTime = Date.now();
                tickTimestamps.push(lastTickTime);
                
                const tenSecondsAgo = Date.now() - 10000;
                tickTimestamps = tickTimestamps.filter(ts => ts > tenSecondsAgo);
                
                // Add to analysis digits
                analysisDigits.push(digit);
                if (analysisDigits.length > analysisWindowSize) {
                    analysisDigits.shift();
                }
                
                // Update advanced statistics
                updateAdvancedStats(digit);
                
                // Update heatmap
                updateHeatmap();
                
                updateAnalysisUI(digit);
                
                if (!sessionState.sessionStarted && analysisDigits.length >= analysisWindowSize) {
                    performEnhancedAnalysis();
                }
                
                if (totalTicksReceived <= 5) {
                    log(`üìä Tick #${totalTicksReceived}: ${price.toFixed(3)} (Digit ${digit})`, 'TICK');
                }
                
            } catch (error) {
                console.error('Tick processing error:', error);
            }
        }
        
        function updateAdvancedStats(digit) {
            // Update frequency
            window.advancedStats.digitFrequency[digit]++;
            
            // Update last appearance
            window.advancedStats.lastAppearance[digit] = totalTicksReceived;
            
            // Update streak count
            for (let i = 0; i < 10; i++) {
                if (i === digit) {
                    window.advancedStats.streakCount[i]++;
                } else {
                    window.advancedStats.streakCount[i] = 0;
                }
            }
            
            // Add to history for pattern detection
            window.digitHistory.push(digit);
            if (window.digitHistory.length > 100) {
                window.digitHistory.shift();
            }
            
            // Update pattern buffer for AI levels 2-3
            if (window.aiLevel >= 2) {
                window.patternBuffer.push(digit);
                if (window.patternBuffer.length > 30) {
                    window.patternBuffer.shift();
                }
            }
        }
        
        function performEnhancedAnalysis() {
            if (analysisDigits.length < analysisWindowSize) return;
            
            if (sessionState.sessionStarted && sessionState.sessionDigit !== null) {
                log(`üîí Session active - digit ${sessionState.sessionDigit} remains locked`, 'SESSION');
                return;
            }
            
            try {
                // Use advanced analysis for AI levels 2-3, basic for level 1
                if (window.aiLevel >= 2 && window.enablePatternRecognition) {
                    suggestedDigit = performAdvancedAnalysis();
                } else {
                    suggestedDigit = performBasicAnalysis();
                }
                
                if (suggestedDigit === null) {
                    suggestedDigit = performBasicAnalysis();
                }
                
                analysisComplete = true;
                window.lastAnalysisTime = Date.now();
                updatePredictionBox();
                
                if (sessionState.mode === 'smart' && suggestedDigit !== null) {
                    lockSessionDigit(suggestedDigit);
                }
                
                updateExecutionLogic();
                
            } catch (error) {
                console.error('Analysis error:', error);
                // Fallback to basic analysis
                suggestedDigit = performBasicAnalysis();
            }
        }
        
        function updatePredictionBox() {
            const box = document.getElementById('prediction_box');
            if (suggestedDigit !== null) {
                const confidence = Math.round(window.predictionConfidence * 100);
                box.innerHTML = `
                    <div class="text-cyan-300 font-bold mb-1">AI Prediction:</div>
                    <div class="text-xl font-bold mb-2 text-center text-green-400">${suggestedDigit}</div>
                    <div class="flex items-center justify-between text-xs">
                        <span class="text-gray-300">Confidence:</span>
                        <span class="font-bold ${confidence >= 70 ? 'text-green-400' : confidence >= 40 ? 'text-yellow-400' : 'text-red-400'}">
                            ${confidence}%
                        </span>
                    </div>
                    <div id="pattern_info" class="text-xs text-purple-300 mt-1"></div>
                `;
                box.classList.add('analysis-complete');
            } else if (sessionState.sessionDigit !== null) {
                box.innerHTML = `
                    <div class="text-cyan-300 font-bold mb-1">Session Digit:</div>
                    <div class="text-xl font-bold mb-2 text-center session-digit-locked px-3 py-1 rounded-lg">${sessionState.sessionDigit}</div>
                    <div class="text-xs text-gray-300">Locked for current session</div>
                `;
                box.classList.add('analysis-complete');
            }
        }
        
        // ============================================================================
        // ADAPTIVE RECHECK SYSTEM - IMPROVED
        // ============================================================================
        
        window.recheckThreshold = 5;
        window.consecutiveLosses = 0;
        window.lastAnalysisTime = 0;
        window.recheckEnabled = true;
        window.digitChangesThisSession = 0;
        window.maxDigitChanges = 3;
        window.lastRecheckTime = 0;
        window.recheckCooldown = 10000;
        
        // DOM Elements
        const toggleButton = document.getElementById('toggleButton');
        const soundToggleButton = document.getElementById('soundToggle');
        const sessionDisplay = document.getElementById('session_display');
        const tradeResultContainer = document.getElementById('trade-result-container');
        const metricPreviousResult = document.getElementById('metricPreviousResult');
        const metricNextAction = document.getElementById('metricNextAction');
        const metricTradeResult = document.getElementById('metricTradeResult');
        
        function updateRecheckSettings() {
            window.recheckThreshold = parseInt(document.getElementById('recheckThreshold').value) || 5;
            window.recheckEnabled = document.getElementById('enableRecheck').checked;
            window.maxDigitChanges = parseInt(document.getElementById('maxDigitChanges').value) || 3;
            
            // Update AI settings
            window.enablePatternRecognition = document.getElementById('enablePatternRecognition').checked;
            window.enableTrendAnalysis = document.getElementById('enableTrendAnalysis').checked;
            
            log(`‚öôÔ∏è AI Settings: Pattern recognition ${window.enablePatternRecognition ? 'ON' : 'OFF'}, Trend analysis ${window.enableTrendAnalysis ? 'ON' : 'OFF'}`, 'AI');
            log(`‚öôÔ∏è Adaptive settings: ${window.recheckEnabled ? 'ON' : 'OFF'}, threshold: ${window.recheckThreshold} losses, max changes: ${window.maxDigitChanges}`, 'SETTINGS');
            
            // Update badge visibility
            const badge = document.getElementById('recheck-badge');
            if (window.recheckEnabled) {
                badge.classList.remove('hidden');
            } else {
                badge.classList.add('hidden');
            }
        }
        
        // ============================================================================
        // CORE BOT FUNCTIONS (Updated with AI)
        // ============================================================================
        
        // DOM Ready
        document.addEventListener('DOMContentLoaded', () => {
            console.log('ü§ñ AI Bot Initialized');
            initializeToggleState();
            
            if (!checkAuthToken()) {
                document.getElementById('prediction_text').textContent = 'Please authenticate first';
            }
            
            updateAnalysisUI('?');
            setInterval(calculateRates, 1000);
            startQueueProcessor();
            setInterval(updateLossStreakDisplay, 500);
            
            calculateMartingale();
            updateRecheckSettings();
            
            // Set default AI level
            setAILevel(2);
            
            document.getElementById('baseStake').addEventListener('change', syncCalculatorWithMain);
            document.getElementById('multiplier').addEventListener('change', syncCalculatorWithMain);
            document.getElementById('maxTrades').addEventListener('change', syncCalculatorWithMain);
            document.getElementById('calc_base_stake').addEventListener('change', () => {
                document.getElementById('baseStake').value = document.getElementById('calc_base_stake').value;
            });
            document.getElementById('calc_multiplier').addEventListener('change', () => {
                document.getElementById('multiplier').value = document.getElementById('calc_multiplier').value;
            });
            document.getElementById('calc_max_trades').addEventListener('change', () => {
                document.getElementById('maxTrades').value = document.getElementById('calc_max_trades').value;
            });
            
            document.getElementById('enableRecheck').addEventListener('change', updateRecheckSettings);
            document.getElementById('recheckThreshold').addEventListener('change', updateRecheckSettings);
            document.getElementById('maxDigitChanges').addEventListener('change', updateRecheckSettings);
            document.getElementById('enablePatternRecognition').addEventListener('change', updateRecheckSettings);
            document.getElementById('enableTrendAnalysis').addEventListener('change', updateRecheckSettings);
            
            log('ü§ñ AI Bot ready', 'SYSTEM');
            switchMode('smart'); // Default to smart mode for AI analysis
            updatePnL();
            resetTradeStatus();
            
            document.getElementById('predictedDigit').addEventListener('change', function() {
                const newDigit = parseInt(this.value);
                if (!isNaN(newDigit) && newDigit >= 0 && newDigit <= 9) {
                    if (sessionState.sessionStarted) {
                        const confirmChange = confirm('‚ö†Ô∏è Changing digit will reset current session. Continue?');
                        if (!confirmChange) {
                            this.value = sessionState.sessionDigit || 5;
                            return;
                        }
                    }
                    
                    sessionState.sessionDigit = newDigit;
                    sessionState.sessionStarted = true;
                    sessionState.manualOverride = true;
                    updateSessionDisplay();
                    updatePredictionBox();
                    log(`üî¢ Digit manually set to ${newDigit}`, 'SESSION');
                    updateTradeStatus('MANUAL', `Digit manually set to ${newDigit}`, 'Ready to trade', 'normal');
                }
            });
            
            // Apply tick window
            document.getElementById('apply_tick_window').addEventListener('click', function() {
                const newSize = parseInt(document.getElementById('tick_window_input').value);
                if (newSize >= 3 && newSize <= 100) {
                    analysisWindowSize = newSize;
                    
                    if (!sessionState.sessionStarted) {
                        analysisDigits = [];
                        analysisComplete = false;
                        suggestedDigit = null;
                        log(`üìä Analysis window: ${newSize} ticks`, 'ANALYSIS');
                        updateAnalysisUI('?');
                        document.getElementById('prediction_text').textContent = 'Waiting for market data...';
                    } else {
                        log(`üìä Analysis window updated to ${newSize} (digit remains locked)`, 'ANALYSIS');
                    }
                }
            });
        });
        
        // ... (Keep all other existing functions from previous version, 
        // but replace performAnalysis() calls with performEnhancedAnalysis())
        
        // Update the analysis UI function
        function updateAnalysisUI(currentDigit) {
            updateConnectionStatus();
            document.getElementById('tick_counter').textContent = analysisDigits.length;
            const progressPercent = Math.min(100, (analysisDigits.length / analysisWindowSize) * 100);
            document.getElementById('tick_progress_bar').style.width = `${progressPercent}%`;
            
            const statusElem = document.getElementById('analysis_status');
            if (analysisDigits.length < analysisWindowSize) {
                statusElem.textContent = `Collecting: ${analysisDigits.length}/${analysisWindowSize}`;
                statusElem.className = 'text-xs text-cyan-400';
            } else {
                statusElem.textContent = '‚úÖ Analysis complete';
                statusElem.className = 'text-xs text-green-400';
            }
            
            document.getElementById('window_size').textContent = analysisWindowSize;
        }
        
        // Update session display to show confidence
        function updateSessionDisplay() {
            if (sessionState.sessionStarted && sessionState.sessionDigit !== null) {
                document.getElementById('session_digit').textContent = sessionState.sessionDigit;
                document.getElementById('session_confidence').textContent = `${Math.round(window.predictionConfidence * 100)}%`;
                document.getElementById('session_mode').textContent = sessionState.mode.toUpperCase();
                document.getElementById('session_trades').textContent = `${window.tradeCount}/${window.maxTrades}`;
                sessionDisplay.classList.remove('hidden');
            } else {
                sessionDisplay.classList.add('hidden');
            }
        }
        
        // Reset all state with AI
        function resetAllState() {
            window.maxTrades = parseInt(document.getElementById('maxTrades').value) || 10;
            window.consecutiveLosses = 0;
            window.digitChangesThisSession = 0;
            window.lastAnalysisTime = 0;
            window.lastRecheckTime = 0;
            
            // Reset AI statistics
            window.advancedStats = {
                digitFrequency: Array(10).fill(0),
                lastAppearance: Array(10).fill(-1),
                streakCount: Array(10).fill(0),
                patternMatches: 0,
                trendStrength: 0
            };
            
            window.digitHistory = [];
            window.patternBuffer = [];
            window.trendBuffer = [];
            window.predictionConfidence = 0;
            
            updateStake('initial');
            resetPnL();
            resetTradeStatus();
            
            window.startingBalance = 0.0;
            window.currentBalance = 0.0;
            window.netProfit = 0.0;
            
            document.getElementById('metricTradeCount').textContent = '0';
            document.getElementById('metricAccountBalance').textContent = '$---';
            document.getElementById('metricLiveTick').textContent = '---';
            document.getElementById('metricLastDigit').textContent = 'Digit: ?';
            
            window.stats = { totalTicks: 0, tradesExecuted: 0, wins: 0, losses: 0 };
            window.tickQueue = [];
            window.lastTick = null;
            window.lastTradeResult = null;
            window.tradeCount = 0;
            window.martingaleStep = 0;
            window.pendingProposals.clear();
            window.botTickTimestamps = [];
            
            window.executionLock = false;
            window.waitingForTradeResult = false;
            window.nextTradeAllowed = true;
            window.stopAfterWin = false;
            
            // Reset heatmap
            for (let i = 0; i < 10; i++) {
                const elem = document.getElementById(`heatmap-${i}`);
                elem.classList.remove('heatmap-high', 'heatmap-medium', 'heatmap-low');
                elem.classList.add('heatmap-zero');
            }
            
            // Reset confidence display
            updateConfidenceDisplay(0, 'No analysis yet');
            
            const logArea = document.getElementById('log-area');
            logArea.innerHTML = '[00:00:00] ü§ñ AI Bot reset. Ready.';
            
            log('üîÑ AI Bot reset', 'SYSTEM');
            log('üîÑ AI Analysis Engine reset', 'AI');
        }
        
        // ... (Keep all other functions from previous version)
        
        // Helper functions (copy from previous version)
        function checkAuthToken() {
            const token = localStorage.getItem('active_token') || localStorage.getItem('derivToken');
            if (!token) {
                log('‚ö†Ô∏è No API token found. Please authenticate first.', 'WARNING');
                document.getElementById('prediction_text').textContent = 'Authentication required';
                return false;
            }
            return true;
        }
        
        function initializeToggleState() {
            const token = localStorage.getItem('active_token');
            const allAccounts = JSON.parse(localStorage.getItem('deriv_accounts')) || [];
            
            if (token && allAccounts.length > 0) {
                const currentAccount = allAccounts.find(acc => acc.token === token);
                if (currentAccount) {
                    const isReal = !currentAccount.account.startsWith('VR');
                    document.getElementById('accTypeToggle').checked = isReal;
                    log(`Account: ${isReal ? 'REAL' : 'DEMO'} (${currentAccount.account})`, 'SYSTEM');
                }
            }
        }
        
        function switchAccount() {
            const isRealRequested = document.getElementById('accTypeToggle').checked;
            const allAccounts = JSON.parse(localStorage.getItem('deriv_accounts')) || [];
            
            const targetAccount = allAccounts.find(acc => 
                isRealRequested ? !acc.account.startsWith('VR') : acc.account.startsWith('VR')
            );
        
            if (targetAccount) {
                localStorage.setItem('active_token', targetAccount.token);
                log(`Switched to ${isRealRequested ? 'REAL' : 'DEMO'} account`, 'SYSTEM');
                
                if (window.isBotRunning) {
                    stopBot();
                    setTimeout(() => startBot(), 1000);
                }
            } else {
                alert(`No ${isRealRequested ? 'Real' : 'Demo'} account found`);
                document.getElementById('accTypeToggle').checked = !isRealRequested;
            }
        }
        
        function updateTradeStatus(status, result, action, type = 'normal') {
            tradeResultContainer.classList.remove('win-glow');
            metricPreviousResult.textContent = result;
            metricNextAction.textContent = action;
            
            switch(type) {
                case 'win':
                    metricTradeResult.textContent = 'WIN üéØ';
                    metricTradeResult.className = 'text-xs font-bold status-win';
                    metricPreviousResult.className = 'text-sm font-bold status-win';
                    metricNextAction.className = 'text-sm font-bold text-green-400';
                    tradeResultContainer.classList.add('win-glow');
                    log(`üéØ Trade Status: ${result}`, 'WIN');
                    break;
                case 'loss':
                    metricTradeResult.textContent = 'LOSS ‚ùå';
                    metricTradeResult.className = 'text-xs font-bold status-loss';
                    metricPreviousResult.className = 'text-sm font-bold status-loss';
                    metricNextAction.className = 'text-sm font-bold text-red-400';
                    log(`‚ùå Trade Status: ${result}`, 'LOSS');
                    break;
                case 'trade':
                    metricTradeResult.textContent = 'TRADING ‚ö°';
                    metricTradeResult.className = 'text-xs font-bold status-trade';
                    metricPreviousResult.className = 'text-sm font-bold status-trade';
                    metricNextAction.className = 'text-sm font-bold text-yellow-400';
                    log(`‚ö° Trade Status: ${result}`, 'TRADE');
                    break;
                default:
                    metricTradeResult.textContent = status || 'READY';
                    metricTradeResult.className = 'text-xs font-bold text-gray-400';
                    metricPreviousResult.className = 'text-sm font-bold text-gray-300';
                    metricNextAction.className = 'text-sm font-bold text-yellow-400';
                    break;
            }
        }
        
        function resetTradeStatus() {
            updateTradeStatus('READY', 'Waiting for connection...', 'Start bot to begin', 'normal');
        }
        
        // ... (Copy all other helper functions from previous version)
        
        // WEBSOCKET CONNECTION (same as before)
        function connectWebSocket() {
            if (window.ws) {
                try {
                    window.ws.close();
                } catch (e) {}
            }
            
            window.isConnecting = true;
            updateConnectionStatus();
            
            const wsUrl = 'wss://ws.binaryws.com/websockets/v3?app_id=118332';
            log('üîó Connecting to Deriv API...', 'SYSTEM');
            
            window.ws = new WebSocket(wsUrl);
            
            window.ws.onopen = () => {
                window.isConnecting = false;
                log('‚úÖ WebSocket connected', 'SYSTEM');
                updateConnectionStatus();
                
                const token = localStorage.getItem('active_token') || localStorage.getItem('derivToken');
                if (!token) {
                    log('‚ùå No API token found in storage', 'ERROR');
                    stopBot();
                    return;
                }
                
                sendRequest({ 
                    authorize: token, 
                    req_id: getNextReqId() 
                });
            };
            
            window.ws.onmessage = (msg) => {
                try {
                    const data = JSON.parse(msg.data);
                    handleAPIResponse(data);
                } catch (e) {
                    console.error('WebSocket message error:', e);
                }
            };
            
            window.ws.onclose = () => {
                window.isConnecting = false;
                updateConnectionStatus();
                log('üîå WebSocket disconnected', 'SYSTEM');
                
                if (window.isBotRunning) {
                    log('üîÑ Attempting to reconnect...', 'SYSTEM');
                    setTimeout(() => {
                        if (window.isBotRunning) {
                            connectWebSocket();
                        }
                    }, 2000);
                }
            };
            
            window.ws.onerror = (error) => {
                console.error('WebSocket error:', error);
                log('‚ùå WebSocket connection error', 'ERROR');
            };
        }
        
        // ... (Copy all other functions from previous version, replacing performAnalysis with performEnhancedAnalysis where needed)
        
    </script>
</body>
</html>
